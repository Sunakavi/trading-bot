<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Crypto Bot Control Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #111827;
      color: #e5e7eb;
    }
    body.theme-crypto {
      --tab-active-bg: #10b981;
      --tab-active-text: #0f172a;
      --tab-underline: #10b981;
      --sell-all-outline: transparent;
      --sell-all-bg: #b91c1c;
    }
    body.theme-stocks {
      --tab-active-bg: #6366f1;
      --tab-active-text: #f9fafb;
      --tab-underline: #f59e0b;
      --sell-all-outline: #f59e0b;
      --sell-all-bg: #991b1b;
    }
    .container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 20px;
    }
    h1 {
      margin: 0 0 10px;
      font-size: 24px;
      color: #f9fafb;
    }
    .subtitle {
      margin-bottom: 20px;
      color: #9ca3af;
      font-size: 14px;
    }
    .control-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #1f2933;
      border-radius: 8px;
      padding: 12px 16px;
      border: 1px solid #111827;
      margin-bottom: 14px;
      box-shadow: 0 0 0 1px #111827;
    }
    .control-info {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .control-title {
      font-size: 15px;
      font-weight: 600;
      color: #f9fafb;
    }
    .control-note {
      font-size: 12px;
      color: #9ca3af;
    }
    .control-actions {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 6px;
      flex-wrap: wrap;
    }
    .control-actions-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .pill-green {
      background: #064e3b;
      color: #6ee7b7;
    }
    .pill-red {
      background: #7f1d1d;
      color: #fecaca;
    }
    .num-input {
      width: 70px;
      padding: 3px 6px;
      border-radius: 4px;
      border: 1px solid #4b5563;
      background: #111827;
      color: #e5e7eb;
      font-size: 12px;
      margin-right: 4px;
    }

    .market-tabs {
      display: flex;
      gap: 8px;
      margin: 8px 0 16px;
    }

    .market-tab {
      border: 1px solid #1f2937;
      background: #111827;
      color: #cbd5f5;
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 12px;
      cursor: pointer;
      position: relative;
    }

    .market-tab.active {
      background: var(--tab-active-bg);
      border-color: var(--tab-active-bg);
      color: var(--tab-active-text);
    }

    .market-tab.active::after {
      content: "";
      position: absolute;
      left: 12px;
      right: 12px;
      bottom: -6px;
      height: 2px;
      background: var(--tab-underline);
      border-radius: 999px;
    }

    .grid {
      display: grid;
      grid-template-columns: 340px 1fr;
      gap: 20px;
    }

    .summary-bar {
      background: #0f172a;
      border: 1px solid #111827;
      border-radius: 10px;
      padding: 12px 14px;
      margin-bottom: 14px;
      box-shadow: 0 0 0 1px #0b1220;
    }

    .summary-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 12px;
    }

    .summary-title {
      font-weight: 700;
      color: #f9fafb;
      font-size: 15px;
    }

    .summary-note {
      font-size: 12px;
      color: #9ca3af;
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 12px;
    }

    .summary-item {
      background: #111827;
      border: 1px solid #1f2937;
      border-radius: 8px;
      padding: 10px 12px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .summary-label {
      font-size: 12px;
      color: #9ca3af;
      letter-spacing: 0.03em;
      text-transform: uppercase;
    }

    .summary-value {
      font-size: 18px;
      font-weight: 700;
      color: #e5e7eb;
    }

    .summary-sub {
      font-size: 12px;
      color: #cbd5e1;
    }

    .summary-metrics {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
    }

    .summary-mini-label {
      font-size: 11px;
      color: #94a3b8;
      letter-spacing: 0.02em;
      text-transform: uppercase;
    }

    .summary-mini-value {
      font-size: 16px;
      font-weight: 700;
      color: #e5e7eb;
    }

    .summary-mini-sub {
      font-size: 11px;
      color: #cbd5e1;
    }

    .card {
      background: #1f2933;
      border-radius: 8px;
      padding: 16px;
      box-shadow: 0 0 0 1px #111827;
    }
    .card h2 {
      margin: 0 0 12px;
      font-size: 18px;
      color: #f9fafb;
    }

    .row {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 8px;
    }
    .row + .row {
      margin-top: 6px;
    }
    .label {
      min-width: 110px;
      font-size: 14px;
      color: #9ca3af;
    }
    .value {
      font-size: 14px;
      color: #e5e7eb;
      font-weight: 500;
    }

    .badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      margin-left: 8px;
    }
    .badge-green {
      background: #064e3b;
      color: #6ee7b7;
    }
    .badge-red {
      background: #7f1d1d;
      color: #fecaca;
    }
    .badge-amber {
      background: #78350f;
      color: #fde68a;
    }

    .btn {
      border: none;
      border-radius: 6px;
      padding: 6px 12px;
      font-size: 13px;
      cursor: pointer;
      margin-right: 6px;
      margin-top: 4px;
      transition: background 0.15s, transform 0.05s;
    }
    .btn:active {
      transform: translateY(1px);
    }
    .btn-primary {
      background: #2563eb;
      color: #f9fafb;
    }
    .btn-outline {
      background: transparent;
      color: #e5e7eb;
      border: 1px solid #4b5563;
    }
    .btn-danger {
      background: #b91c1c;
      color: #fee2e2;
    }

    .sell-all-btn {
      background: var(--sell-all-bg);
      border: 1px solid var(--sell-all-outline);
    }
    .btn-small {
      font-size: 12px;
      padding: 4px 10px;
    }

    .status-line {
      font-size: 12px;
      color: #9ca3af;
      margin-top: 4px;
    }

    .countdown-focus .label,
    .countdown-focus .value {
      color: #f9fafb;
      font-weight: 600;
    }

    .countdown-note {
      margin-left: 110px;
      font-size: 12px;
      color: #9ca3af;
    }

    .stocks-only {
      display: none;
    }

    .stocks-only.active {
      display: flex;
    }

    .stocks-only.countdown-note.active {
      display: block;
    }

    /* LOG AREA LIKE TERMINAL */
    .log-container {
      background: #000000;
      border-radius: 8px;
      padding: 8px 10px;
      border: 1px solid #4b5563;
      height: 520px;
      overflow-y: auto;
      font-family: "Consolas", "SF Mono", "Menlo", "Monaco", monospace;
      font-size: 12px;
      line-height: 1.3;
      color: #d1d5db;
      white-space: pre; /* שומר על הפורמט בדיוק כמו בטרמינל */
    }

    .log-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }
    .log-title {
      font-size: 13px;
      color: #9ca3af;
    }
    .log-controls {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: flex-end;
    }
    .log-controls .num-input {
      width: 200px;
    }
    .log-download[aria-disabled="true"] {
      opacity: 0.5;
      pointer-events: none;
    }
    .pill {
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: #111827;
      color: #9ca3af;
      border: 1px solid #4b5563;
    }

    .log-buy {
      color: #34d399;
      font-weight: 700;
    }
    .log-sell {
      color: #f87171;
      font-weight: 700;
    }
    .log-tp {
      color: #fbbf24;
      font-weight: 700;
    }
    .log-sl {
      color: #c084fc;
      font-weight: 700;
    }

    .strategy-table-wrapper {
      margin-top: 12px;
      overflow-x: auto;
    }

    .strategy-table {
      width: 100%;
      border-collapse: collapse;
      color: #e5e7eb;
      font-size: 13px;
    }

    .strategy-table th,
    .strategy-table td {
      padding: 8px;
      border-bottom: 1px solid #374151;
      vertical-align: top;
      text-align: left;
    }

    .strategy-table th {
      background: #111827;
      color: #9ca3af;
      font-weight: 700;
      font-size: 12px;
      letter-spacing: 0.03em;
      text-transform: uppercase;
    }

    .strategy-table td strong {
      color: #f9fafb;
    }

    .tab-header {
      display: flex;
      gap: 8px;
      margin-bottom: 14px;
      border-bottom: 1px solid #1f2937;
      padding-bottom: 8px;
    }

    .tab-button {
      border: 1px solid #1f2937;
      background: #111827;
      color: #cbd5f5;
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 12px;
      cursor: pointer;
    }

    .tab-button.active {
      background: #2563eb;
      border-color: #2563eb;
      color: #f9fafb;
    }

    .tab-panel {
      display: none;
    }

    .tab-panel.active {
      display: block;
    }

    .preset-inputs {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 8px;
    }

    .preset-input {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 11px;
      color: #9ca3af;
    }

    .preset-input input {
      width: 100%;
    }

    .pairing-select {
      width: 200px;
      padding: 4px 6px;
      border-radius: 6px;
      border: 1px solid #374151;
      background: #111827;
      color: #e5e7eb;
      font-size: 12px;
    }

    .entry-variables {
      font-size: 13px;
      color: #cbd5e1;
      background: #111827;
      border: 1px solid #1f2937;
      border-radius: 6px;
      padding: 8px 10px;
    }

    .settings-panel {
      display: none;
      margin-bottom: 16px;
      background: #0f172a;
      border: 1px solid #1f2937;
    }

    .settings-panel.open {
      display: block;
    }

    .settings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 12px;
    }

    .text-input {
      width: 100%;
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #374151;
      background: #111827;
      color: #e5e7eb;
      font-size: 12px;
    }

    .theme-crypto .settings-stocks {
      opacity: 0.6;
    }

    .theme-stocks .settings-crypto {
      opacity: 0.6;
    }

    .theme-stocks #stocksCountdown {
      color: #f59e0b;
      font-weight: 600;
    }

    .strategy-market-label {
      font-size: 12px;
      color: #9ca3af;
      margin-bottom: 10px;
      letter-spacing: 0.02em;
    }
  </style>
</head>
<body class="theme-crypto">
  <div class="container">
    <h1>Crypto Bot Control Panel</h1>
    <div class="subtitle">
      Live control over strategy, interval, sell all and reset funds.
      Logs are shown exactly as in the terminal.
    </div>

    <div class="market-tabs" id="marketTabs">
      <button class="market-tab active" data-market="crypto">Crypto</button>
      <button class="market-tab" data-market="stocks">Stocks</button>
    </div>

    <div class="control-bar">
      <div class="control-info">
        <div class="control-title">Bot run control</div>
        <div class="control-note">Pause safely saves state & performance so you can resume later.</div>
      </div>
      <div class="control-actions">
        <div class="control-actions-row">
          <span id="botRunBadge" class="pill pill-green">Running</span>
          <button id="startBotBtn" class="btn btn-primary btn-small">START BOT</button>
          <button id="stopBotBtn" class="btn btn-danger btn-small">STOP BOT</button>
        </div>
        <button id="settingsToggleBtn" class="btn btn-outline btn-small">SETTINGS</button>
      </div>
    </div>
    <div class="status-line" id="botControlStatus"></div>

    <div id="settingsPanel" class="card settings-panel">
      <h2>Connection Settings</h2>
      <div class="settings-grid">
        <label class="preset-input settings-crypto">Binance API Key
          <input id="binanceApiKeyInput" class="text-input" type="text" placeholder="Enter Binance API key" />
        </label>
        <label class="preset-input settings-crypto">Binance Secret Key
          <input id="binanceApiSecretInput" class="text-input" type="password" placeholder="Enter Binance secret key" />
        </label>
        <label class="preset-input settings-crypto">Binance Base URL
          <input id="binanceBaseUrlInput" class="text-input" type="text" placeholder="https://testnet.binance.vision" />
        </label>
        <label class="preset-input settings-crypto">TradingView Webhook URL
          <input id="tradingViewWebhookInput" class="text-input" type="text" placeholder="https://your-webhook-url" />
        </label>
        <label class="preset-input">Market Type
          <select id="marketTypeInput" class="text-input">
            <option value="crypto">Crypto (Binance)</option>
            <option value="stocks">Stocks (Alpaca Paper)</option>
          </select>
        </label>
        <label class="preset-input settings-stocks">Alpaca API Key
          <input id="alpacaApiKeyInput" class="text-input" type="text" placeholder="Enter Alpaca API key" />
        </label>
        <label class="preset-input settings-stocks">Alpaca Secret Key
          <input id="alpacaApiSecretInput" class="text-input" type="password" placeholder="Enter Alpaca secret key" />
        </label>
        <label class="preset-input settings-stocks">Alpaca Trading Base URL
          <input id="alpacaTradingBaseUrlInput" class="text-input" type="text" placeholder="https://paper-api.alpaca.markets" />
        </label>
        <label class="preset-input settings-stocks">Alpaca Data Base URL
          <input id="alpacaDataBaseUrlInput" class="text-input" type="text" placeholder="https://data.alpaca.markets" />
        </label>
        <label class="preset-input settings-stocks">Alpaca Data Feed
          <input id="alpacaDataFeedInput" class="text-input" type="text" placeholder="iex" />
        </label>
      </div>
      <div class="row" style="margin-top: 10px;">
        <button id="saveSettingsBtn" class="btn btn-primary btn-small">Save Settings</button>
      </div>
      <div class="status-line" id="settingsStatus"></div>
    </div>

    <div class="summary-bar">
      <div class="summary-header">
        <div>
          <div class="summary-title">Performance snapshots</div>
          <div class="summary-note">PNL, trades, wins/losses, and win rate for each window.</div>
        </div>
        <div class="summary-note">Auto-refreshes with the bot status poll.</div>
      </div>
      <div class="summary-grid">
        <div class="summary-item">
          <div class="summary-label">Last 24 hours</div>
          <div class="summary-value" id="summaryPnlValue-24h">–</div>
          <div class="summary-sub" id="summaryPnlPct-24h">–</div>
          <div class="summary-metrics">
            <div>
              <div class="summary-mini-label">Trades</div>
              <div class="summary-mini-value" id="summaryTrades-24h">–</div>
              <div class="summary-mini-sub" id="summaryWinLoss-24h">–</div>
            </div>
            <div>
              <div class="summary-mini-label">Win rate</div>
              <div class="summary-mini-value" id="summaryWinRate-24h">–</div>
              <div class="summary-mini-sub" id="summaryAvgPnl-24h">–</div>
            </div>
          </div>
        </div>
        <div class="summary-item">
          <div class="summary-label">Last 3 days</div>
          <div class="summary-value" id="summaryPnlValue-3d">–</div>
          <div class="summary-sub" id="summaryPnlPct-3d">–</div>
          <div class="summary-metrics">
            <div>
              <div class="summary-mini-label">Trades</div>
              <div class="summary-mini-value" id="summaryTrades-3d">–</div>
              <div class="summary-mini-sub" id="summaryWinLoss-3d">–</div>
            </div>
            <div>
              <div class="summary-mini-label">Win rate</div>
              <div class="summary-mini-value" id="summaryWinRate-3d">–</div>
              <div class="summary-mini-sub" id="summaryAvgPnl-3d">–</div>
            </div>
          </div>
        </div>
        <div class="summary-item">
          <div class="summary-label">Last 1 week</div>
          <div class="summary-value" id="summaryPnlValue-7d">–</div>
          <div class="summary-sub" id="summaryPnlPct-7d">–</div>
          <div class="summary-metrics">
            <div>
              <div class="summary-mini-label">Trades</div>
              <div class="summary-mini-value" id="summaryTrades-7d">–</div>
              <div class="summary-mini-sub" id="summaryWinLoss-7d">–</div>
            </div>
            <div>
              <div class="summary-mini-label">Win rate</div>
              <div class="summary-mini-value" id="summaryWinRate-7d">–</div>
              <div class="summary-mini-sub" id="summaryAvgPnl-7d">–</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT: STATUS + CONTROLS -->
      <div class="card">
        <h2>Status & Controls</h2>

        <!-- STATUS -->
        <div class="row">
          <span class="label">Strategy:</span>
          <span class="value">
            <span id="statusStrategy">–</span>
          </span>
        </div>
        <div class="row">
          <span class="label">Interval:</span>
          <span class="value"><span id="statusInterval">–</span></span>
        </div>
        <div class="row">
          <span class="label">Last Equity:</span>
          <span class="value">
            <span id="statusEquity">–</span>
          </span>
        </div>
        <div class="row">
          <span class="label">Last PNL:</span>
          <span class="value">
            <span id="statusPnl">–</span>
          </span>
        </div>
        <div class="row">
          <span class="label">Symbols:</span>
          <span class="value">
            <span id="statusSymbols">—</span>
          </span>
        </div>
        <div class="row stocks-only" id="stocksAlpacaRow">
          <span class="label">Alpaca:</span>
          <span class="value"><span id="statusAlpaca">?</span></span>
        </div>
        <div class="row stocks-only" id="stocksMarketOpenRow">
          <span class="label">Market Open:</span>
          <span class="value"><span id="stocksMarketOpen">—</span></span>
        </div>
        <div class="row stocks-only" id="stocksNextOpenRow">
          <span class="label">Next Open:</span>
          <span class="value"><span id="stocksNextOpen">—</span></span>
        </div>
        <div class="row stocks-only" id="stocksCountdownRow">
          <span class="label">Countdown:</span>
          <span class="value"><span id="stocksCountdown">—</span></span>
        </div>
        <div class="status-line stocks-only countdown-note" id="stocksCountdownNote"></div>
        <div class="status-line" id="statusUpdated">Last update: –</div>

        <hr style="border: none; border-top: 1px solid #374151; margin: 10px 0;" />
            <!-- LEFT: EXIT SETTINGS CARD -->
      <div class="card" style="margin-top: 12px;">
        <h2>Exit Settings</h2>

        <!-- ערכים בפועל -->
        <div class="row">
          <span class="label">Current SL:</span>
          <span class="value"><span id="exitSlValue">–</span></span>
        </div>
        <div class="row">
          <span class="label">Current TP:</span>
          <span class="value"><span id="exitTpValue">–</span></span>
        </div>
        <div class="row">
          <span class="label">Trail Start:</span>
          <span class="value"><span id="exitTrailStartValue">–</span></span>
        </div>
        <div class="row">
          <span class="label">Trail Distance:</span>
          <span class="value"><span id="exitTrailDistanceValue">–</span></span>
        </div>
        <div class="row">
          <span class="label">Candle Exit:</span>
          <span class="value"><span id="exitCandleRedValue">–</span></span>
        </div>

        <hr style="border: none; border-top: 1px solid #374151; margin: 10px 0;" />

        <div class="row">
          <span class="label">Preset sets:</span>
          <div>
            <select id="exitPresetSelect" class="num-input" style="width: 240px;">
              <option value="" selected disabled>Select exit preset...</option>
            </select>
            <button id="applyExitPresetBtn" class="btn btn-outline btn-small" style="margin-left: 4px;">
              Apply preset
            </button>
          </div>
        </div>

        <!-- עריכה דינמית -->
        <div class="row">
          <span class="label">Edit (%):</span>
          <div>
            <input id="exitSlInput" class="num-input" type="number" step="0.1" min="0.1" max="50" placeholder="SL" />
            <input id="exitTpInput" class="num-input" type="number" step="0.1" min="0.1" max="100" placeholder="TP" />
          </div>
        </div>
        <div class="row">
          <span class="label"></span>
          <div>
            <input id="exitTrailStartInput" class="num-input" type="number" step="0.1" min="0.1" max="100" placeholder="Trail Start" />
            <input id="exitTrailDistanceInput" class="num-input" type="number" step="0.1" min="0.1" max="100" placeholder="Trail Dist." />
          </div>
        </div>
        <div class="row">
          <span class="label">Candle (%):</span>
          <div>
            <label style="display: flex; align-items: center; gap: 8px;">
              <input id="exitCandleEnabledInput" type="checkbox" />
              <span>Use candle confirmation</span>
            </label>
            <input
              id="exitCandleRedInput"
              class="num-input"
              type="number"
              step="1"
              min="0"
              max="100"
              placeholder="Red %"
              disabled
            />
          </div>
        </div>

        <div class="row" style="margin-top: 8px;">
          <span class="label"></span>
          <div>
            <button class="btn btn-primary btn-small" onclick="updateExitConfig()">
              UPDATE EXIT
            </button>
          </div>
        </div>

        <div class="status-line" id="exitStatus"></div>
      </div>

        <!-- ENTRY STRATEGY SELECTION -->
        <div class="row">
          <span class="label">Entry Strategy:</span>
          <div>
            <select id="entryStrategySelect" class="num-input" style="width: 260px;">
              <option value="" disabled selected>Select entry strategy...</option>
            </select>
          </div>
        </div>
        <div class="status-line" id="strategyStatus">Select an entry strategy to send it live.</div>

        <!-- INTERVAL -->
        <div class="row" style="margin-top: 8px;">
          <span class="label">Loop interval:</span>
          <div>
            <button class="btn btn-outline btn-small" onclick="setIntervalMs(60000)">Every 60s</button>
            <button class="btn btn-outline btn-small" onclick="setIntervalMs(300000)">Every 5 min</button>
            <button class="btn btn-outline btn-small" onclick="setIntervalMs(900000)">Every 15 min</button>
          </div>
        </div>
        <div class="status-line" id="intervalStatus"></div>

        <!-- SELL & RESET -->
        <div class="row" style="margin-top: 10px;">
          <span class="label">Actions:</span>
          <div>
            <button id="sellAllBtn" class="btn btn-danger btn-small sell-all-btn" onclick="sellAll()">SELL ALL (Crypto)</button>
          </div>
        </div>
      </div>

      <!-- RIGHT: LOG VIEWER -->
      <div class="card">
        <div class="log-header">
          <div class="log-title">Live Logs</div>
          <div class="log-controls">
            <label for="logFileSelect" style="font-size: 12px; color: #9ca3af;">Log file:</label>
            <select id="logFileSelect" class="num-input">
              <option value="">Latest (live)</option>
            </select>
            <button id="logLoadBtn" class="btn btn-outline btn-small">View</button>
            <button id="logRefreshBtn" class="btn btn-outline btn-small">Refresh list</button>
            <a id="logDownloadLink" class="btn btn-primary btn-small log-download" aria-disabled="true" download>Download</a>
            <span class="pill" id="logStatusPill">Polling every 5s</span>
          </div>
        </div>
      <div id="logContainer" class="log-container">
        Loading logs...
      </div>
    </div>
  </div>

    <div class="card" style="margin-top: 16px;">
      <div class="tab-header" role="tablist">
        <button class="tab-button active" data-tab="entry">Entry Strategy Presets</button>
        <button class="tab-button" data-tab="exit">Exit Strategy Presets</button>
      </div>

      <div id="entryStrategyTab" class="tab-panel active">
        <h2>Entry Strategy Presets</h2>
        <div class="strategy-market-label" id="entryStrategyMarketLabel">Entry Strategy Presets - Crypto</div>
        <p class="subtitle" style="margin-bottom: 12px;">
          These presets adjust trend, pullback, momentum, ATR, and volume filters. Selecting one updates the bot
          immediately for the next trading loop.
        </p>
        <div class="entry-variables">
          <strong>Key entry variables:</strong> MA Fast / MA Slow, Pullback %, RSI Range, ATR Filter, Volume Surge.
        </div>
        <div class="strategy-table-wrapper">
          <table class="strategy-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Purpose & Behavior</th>
                <th>Run Logic</th>
                <th>Suggested Exit Preset</th>
                <th>Parameters</th>
              </tr>
            </thead>
            <tbody id="strategyTableBody"></tbody>
          </table>
        </div>
      </div>

      <div id="exitStrategyTab" class="tab-panel">
        <h2>Exit Strategy Presets</h2>
        <p class="subtitle" style="margin-bottom: 12px;">
          Tune each exit preset, save your preferred values, and quickly load them into the live Exit Settings.
        </p>
        <div class="strategy-table-wrapper">
          <table class="strategy-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Purpose</th>
                <th>Preset Values (%)</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="exitStrategyTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    const statusEls = {
      strategy: document.getElementById("statusStrategy"),
      interval: document.getElementById("statusInterval"),
      equity: document.getElementById("statusEquity"),
      pnl: document.getElementById("statusPnl"),
      symbols: document.getElementById("statusSymbols"),
      alpaca: document.getElementById("statusAlpaca"),
      stocksMarketOpen: document.getElementById("stocksMarketOpen"),
      stocksNextOpen: document.getElementById("stocksNextOpen"),
      stocksCountdown: document.getElementById("stocksCountdown"),
      stocksCountdownNote: document.getElementById("stocksCountdownNote"),
      updated: document.getElementById("statusUpdated"),
    };

    const marketTabsEl = document.getElementById("marketTabs");
    const marketTabButtons = marketTabsEl
      ? Array.from(marketTabsEl.querySelectorAll(".market-tab"))
      : [];
    const stocksOnlyEls = document.querySelectorAll(".stocks-only");
    let currentMarket = localStorage.getItem("activeMarket") || "crypto";
    let statusTimer = null;
    let logTimer = null;
    let logListTimer = null;

    const strategyStatusEl = document.getElementById("strategyStatus");
    const intervalStatusEl = document.getElementById("intervalStatus");
    const logContainerEl = document.getElementById("logContainer");
    const logStatusPillEl = document.getElementById("logStatusPill");
    const logFileSelectEl = document.getElementById("logFileSelect");
    const logRefreshBtn = document.getElementById("logRefreshBtn");
    const logLoadBtn = document.getElementById("logLoadBtn");
    const logDownloadLinkEl = document.getElementById("logDownloadLink");
    const sellAllBtnEl = document.getElementById("sellAllBtn");
    const entryStrategyMarketLabelEl = document.getElementById("entryStrategyMarketLabel");
    const stocksCountdownRowEl = document.getElementById("stocksCountdownRow");
    const botControlStatusEl = document.getElementById("botControlStatus");
    const botRunBadgeEl = document.getElementById("botRunBadge");
    const startBotBtn = document.getElementById("startBotBtn");
    const stopBotBtn = document.getElementById("stopBotBtn");
    const settingsToggleBtn = document.getElementById("settingsToggleBtn");
    const settingsPanelEl = document.getElementById("settingsPanel");
    const saveSettingsBtn = document.getElementById("saveSettingsBtn");
    const settingsStatusEl = document.getElementById("settingsStatus");

    const settingsInputs = {
      binanceApiKey: document.getElementById("binanceApiKeyInput"),
      binanceApiSecret: document.getElementById("binanceApiSecretInput"),
      binanceBaseUrl: document.getElementById("binanceBaseUrlInput"),
      tradingViewWebhookUrl: document.getElementById("tradingViewWebhookInput"),
      marketType: document.getElementById("marketTypeInput"),
      alpacaApiKey: document.getElementById("alpacaApiKeyInput"),
      alpacaApiSecret: document.getElementById("alpacaApiSecretInput"),
      alpacaTradingBaseUrl: document.getElementById("alpacaTradingBaseUrlInput"),
      alpacaDataBaseUrl: document.getElementById("alpacaDataBaseUrlInput"),
      alpacaDataFeed: document.getElementById("alpacaDataFeedInput"),
    };

    let selectedLogFile = "";

    const summaryConfig = {
      last24h: { suffix: "24h", label: "24h" },
      last3d: { suffix: "3d", label: "3 days" },
      last7d: { suffix: "7d", label: "1 week" },
    };

    const summaryEls = Object.fromEntries(
      Object.entries(summaryConfig).map(([key, cfg]) => [
        key,
        {
          pnlValue: document.getElementById(`summaryPnlValue-${cfg.suffix}`),
          pnlPct: document.getElementById(`summaryPnlPct-${cfg.suffix}`),
          trades: document.getElementById(`summaryTrades-${cfg.suffix}`),
          winLoss: document.getElementById(`summaryWinLoss-${cfg.suffix}`),
          winRate: document.getElementById(`summaryWinRate-${cfg.suffix}`),
          avgPnl: document.getElementById(`summaryAvgPnl-${cfg.suffix}`),
        },
      ])
    );

    const exitElems = {
      slValue: document.getElementById("exitSlValue"),
      tpValue: document.getElementById("exitTpValue"),
      trailStartValue: document.getElementById("exitTrailStartValue"),
      trailDistanceValue: document.getElementById("exitTrailDistanceValue"),
      candleRedValue: document.getElementById("exitCandleRedValue"),

      slInput: document.getElementById("exitSlInput"),
      tpInput: document.getElementById("exitTpInput"),
      trailStartInput: document.getElementById("exitTrailStartInput"),
      trailDistanceInput: document.getElementById("exitTrailDistanceInput"),
      candleRedInput: document.getElementById("exitCandleRedInput"),
      candleEnabledInput: document.getElementById("exitCandleEnabledInput"),
    };

    const exitStatusEl = document.getElementById("exitStatus");
    const exitPresetSelectEl = document.getElementById("exitPresetSelect");
    const applyExitPresetBtn = document.getElementById("applyExitPresetBtn");
    const entryStrategySelectEl = document.getElementById("entryStrategySelect");
    const strategyTableBodyEl = document.getElementById("strategyTableBody");
    const exitStrategyTableBodyEl = document.getElementById("exitStrategyTableBody");
    const tabButtons = Array.from(document.querySelectorAll(".tab-button"));
    const tabPanels = Array.from(document.querySelectorAll(".tab-panel"));

    const ENTRY_EXIT_PAIR_KEY = "entryExitPairs";
    const EXIT_PRESET_STORAGE_KEY = "exitPresetOverrides";

    const entryStrategies = [
      {
        id: 101,
        name: "Conservative Trend Entry",
        purpose: "Stable trends, avoid whipsaw",
        behavior: "Few but high-quality trades",
        logicGroup: "Trend/Pullback (Strategy 2)",
        defaultExitPresetId: "conservative",
        parameters: [
          { label: "Fast MA", value: "20" },
          { label: "Slow MA", value: "200" },
          { label: "Pullback", value: "1.0%–2.0%" },
          { label: "RSI", value: "50–60" },
          { label: "ATR Filter", value: "ON (ATR > ATR_MA × 0.7)" },
          { label: "Volume Surge", value: "Optional" },
        ],
      },
      {
        id: 102,
        name: "Aggressive Trend Entry",
        purpose: "Strong trends & momentum markets",
        behavior: "Early entries on breakouts and shallow pullbacks",
        logicGroup: "Trend/Pullback (Strategy 2)",
        defaultExitPresetId: "aggressive-trend",
        parameters: [
          { label: "Fast MA", value: "10" },
          { label: "Slow MA", value: "50" },
          { label: "Pullback", value: "2.5%–4%" },
          { label: "RSI", value: "55–70" },
          { label: "ATR Filter", value: "OFF" },
          { label: "Volume Surge", value: "ON (≥ 20% above 10-candle avg)" },
        ],
      },
      {
        id: 103,
        name: "Scalping Mode",
        purpose: "Small moves, sideways markets",
        behavior: "Many small, fast trades",
        logicGroup: "EMA + ATR Momentum (Strategy 3)",
        defaultExitPresetId: "safe-scalping",
        parameters: [
          { label: "Fast MA", value: "9" },
          { label: "Slow MA", value: "21" },
          { label: "Pullback", value: "≤ 1.0%" },
          { label: "RSI", value: "45–55" },
          { label: "ATR Filter", value: "OFF" },
          { label: "Volume Surge", value: "Low (≥ 10%)" },
        ],
      },
      {
        id: 104,
        name: "Deep Pullback Entry",
        purpose: "Buy deep dips inside an uptrend",
        behavior: "Waits for larger pullbacks for discount entries",
        logicGroup: "Trend/Pullback (Strategy 2)",
        defaultExitPresetId: "atr-mixed",
        parameters: [
          { label: "Fast MA", value: "50" },
          { label: "Slow MA", value: "200" },
          { label: "Pullback", value: "3%–6%" },
          { label: "RSI", value: "28–40" },
          { label: "ATR Filter", value: "ON" },
          { label: "Volume Surge", value: "OFF" },
        ],
      },
      {
        id: 105,
        name: "Breakout Entry",
        purpose: "Capture large upside breakouts",
        behavior: "Ignores pullbacks; enters on momentum bursts",
        logicGroup: "EMA + ATR Momentum (Strategy 3)",
        defaultExitPresetId: "breakout-mode",
        parameters: [
          { label: "Fast MA", value: "15" },
          { label: "Slow MA", value: "50" },
          { label: "Pullback", value: "0%–1%" },
          { label: "RSI", value: "≥ 60" },
          { label: "ATR Filter", value: "ON" },
          { label: "Volume Surge", value: "High (≥ 30%)" },
        ],
      },
      {
        id: 106,
        name: "Volatility Adaptive Entry (ATR-Based)",
        purpose: "Fit entries to volatility",
        behavior: "Pullback + entry thresholds scale with ATR",
        logicGroup: "EMA + ATR Momentum (Strategy 3)",
        defaultExitPresetId: "atr-mixed",
        parameters: [
          { label: "Fast MA", value: "10" },
          { label: "Slow MA", value: "30" },
          { label: "Pullback", value: "ATR × 1.2" },
          { label: "RSI", value: "48–65" },
          { label: "ATR Filter", value: "≥ 1.5 × Average ATR" },
          { label: "Volume Surge", value: "Recommended" },
        ],
      },
      {
        id: 107,
        name: "MA Slope Entry",
        purpose: "Detect the beginning of a new trend",
        behavior: "Enters when MA slopes show acceleration",
        logicGroup: "Trend/Pullback (Strategy 2)",
        defaultExitPresetId: "momentum-rider",
        parameters: [
          { label: "Fast MA Slope", value: "> 0.1% per candle" },
          { label: "Slow MA Slope", value: "Positive" },
          { label: "Pullback", value: "1%–3%" },
          { label: "RSI", value: "50–65" },
          { label: "ATR Filter", value: "OFF" },
          { label: "Volume Surge", value: "Moderate" },
        ],
      },
      {
        id: 108,
        name: "EMA + ATR Core (Enhanced Version of Strategy 3)",
        purpose: "Volatility-aware swing entries",
        behavior: "Entries triggered by volatility zones around EMAs",
        logicGroup: "EMA + ATR Momentum (Strategy 3)",
        defaultExitPresetId: "momentum-rider",
        parameters: [
          { label: "EMA", value: "20 / 50" },
          { label: "ATR Stop", value: "ATR × 1.8" },
          { label: "Pullback", value: "ATR × 0.8" },
          { label: "RSI", value: "45–60" },
          { label: "Volume Surge", value: "Optional" },
        ],
      },
      {
        id: 1,
        name: "Legacy – Golden Cross",
        purpose: "Baseline moving-average crossover",
        behavior: "Enters on SMA 12/50 crossovers",
        logicGroup: "Golden Cross (Strategy 1)",
        defaultExitPresetId: "conservative",
        parameters: [
          { label: "Fast MA", value: "12" },
          { label: "Slow MA", value: "50" },
          { label: "Pullback", value: "Cross confirmation" },
          { label: "RSI", value: "Not enforced" },
          { label: "ATR Filter", value: "None" },
          { label: "Volume Surge", value: "Not enforced" },
        ],
      },
      {
        id: 2,
        name: "Legacy – Trend/Pullback",
        purpose: "Original trend + pullback logic",
        behavior: "Trend filtered pullbacks with RSI and candle checks",
        logicGroup: "Trend/Pullback (Strategy 2)",
        defaultExitPresetId: "conservative",
        parameters: [
          { label: "Fast MA", value: "Config FAST_MA" },
          { label: "Slow MA", value: "Config SLOW_MA" },
          { label: "Pullback", value: "~0.4%–0.8% below fast MA" },
          { label: "RSI", value: "Config RSI min/max" },
          { label: "ATR Filter", value: "None" },
          { label: "Volume Surge", value: "Optional" },
        ],
      },
      {
        id: 3,
        name: "Legacy – EMA + ATR",
        purpose: "EMA 9/21 crossover with volatility filter",
        behavior: "Momentum entries when crossover plus candle body > 0.7 × ATR",
        logicGroup: "EMA + ATR Momentum (Strategy 3)",
        defaultExitPresetId: "momentum-rider",
        parameters: [
          { label: "EMA", value: "9 / 21" },
          { label: "Volatility", value: "Body > 0.7 × ATR" },
          { label: "Pullback", value: "Not required" },
          { label: "RSI", value: "Not enforced" },
          { label: "ATR Filter", value: "Implicit via body" },
          { label: "Volume Surge", value: "Not enforced" },
        ],
      },
    ];

    const exitPresetDefaults = [
      {
        id: "conservative",
        order: 1,
        name: "Conservative",
        purpose: "Lower risk, wider stops with moderate targets.",
        sl: 1.2,
        tp: 2.4,
        trailStart: 1.2,
        trailDistance: 0.6,
        candleRed: 60,
      },
      {
        id: "aggressive-trend",
        order: 2,
        name: "Aggressive Trend",
        purpose: "Ride fast trends with tighter risk controls.",
        sl: 0.9,
        tp: 3.2,
        trailStart: 1.6,
        trailDistance: 0.8,
        candleRed: 40,
      },
      {
        id: "safe-scalping",
        order: 3,
        name: "Safe Scalping",
        purpose: "Quick exits for short-term scalps.",
        sl: 0.6,
        tp: 1.2,
        trailStart: 0.8,
        trailDistance: 0.4,
        candleRed: 50,
      },
      {
        id: "momentum-rider",
        order: 4,
        name: "Momentum Rider",
        purpose: "Let momentum breathe before trailing.",
        sl: 1.0,
        tp: 4.0,
        trailStart: 2.0,
        trailDistance: 1.0,
        candleRed: 30,
      },
      {
        id: "atr-mixed",
        order: 5,
        name: "ATR Mixed (semi-dynamic)",
        purpose: "Balanced trailing with ATR-aware spacing.",
        sl: 0.6,
        tp: 1.4,
        trailStart: 2.0,
        trailDistance: 1.0,
        candleRed: 40,
      },
      {
        id: "volatility-shield",
        order: 6,
        name: "Volatility Shield",
        purpose: "More protection during choppy sessions.",
        sl: 1.5,
        tp: 2.5,
        trailStart: 2.2,
        trailDistance: 1.2,
        candleRed: 70,
      },
      {
        id: "breakout-mode",
        order: 7,
        name: "Breakout Mode",
        purpose: "Give big breakouts space to extend.",
        sl: 0.8,
        tp: 5.0,
        trailStart: 3.0,
        trailDistance: 1.5,
        candleRed: 20,
      },
      {
        id: "ultra-tight",
        order: 8,
        name: "Ultra Tight",
        purpose: "Minimal exposure for quick exits.",
        sl: 0.4,
        tp: 0.8,
        trailStart: 0.5,
        trailDistance: 0.25,
        candleRed: 60,
      },
    ];
    let exitPresets = loadExitPresets(exitPresetDefaults);

    function applyExitPreset(id) {
      const preset = exitPresets.find((p) => p.id === id);
      if (!preset) {
        exitStatusEl.textContent = "Preset not found.";
        return;
      }

      exitElems.slInput.value = preset.sl.toFixed(2);
      exitElems.tpInput.value = preset.tp.toFixed(2);
      exitElems.trailStartInput.value = preset.trailStart.toFixed(2);
      exitElems.trailDistanceInput.value = preset.trailDistance.toFixed(2);
      exitElems.candleRedInput.value = preset.candleRed.toFixed(0);

      exitStatusEl.textContent = `${formatExitPresetLabel(
        preset
      )} loaded into fields. Click UPDATE EXIT to apply.`;
    }

    // --- HELPERS ---
    function setBotRunUi(running) {
      botRunBadgeEl.textContent = running ? "Running" : "Stopped";
      botRunBadgeEl.classList.toggle("pill-green", running);
      botRunBadgeEl.classList.toggle("pill-red", !running);
      startBotBtn.disabled = running;
      stopBotBtn.disabled = !running;
    }

    function formatTs(ts) {
      if (!ts) return "–";
      const d = new Date(ts);
      return d.toLocaleString();
    }

    function formatPnl(p) {
      if (p === null || p === undefined) return "–";
      const v = Number(p);
      if (Number.isNaN(v)) return "–";
      const sign = v > 0 ? "+" : "";
      return sign + v.toFixed(2) + "%";
    }

    function formatUsd(v) {
      if (v === null || v === undefined) return "–";
      const num = Number(v);
      if (Number.isNaN(num)) return "–";
      const sign = num > 0 ? "+" : num < 0 ? "" : "";
      return sign + num.toFixed(2) + " USDT";
    }

    function pctText(v, digits = 2) {
      return v === null || v === undefined ? "–" : (v * 100).toFixed(digits) + "%";
    }

    function escapeHtml(str) {
      return str
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    function loadStoredJson(key, fallback) {
      try {
        const raw = localStorage.getItem(key);
        if (!raw) return fallback;
        const parsed = JSON.parse(raw);
        return parsed ?? fallback;
      } catch (err) {
        return fallback;
      }
    }

    function formatExitPresetLabel(preset) {
      return `${preset.order} — ${preset.name}`;
    }

    function loadExitPresetOverrides() {
      return loadStoredJson(EXIT_PRESET_STORAGE_KEY, {});
    }

    function saveExitPresetOverrides(overrides) {
      localStorage.setItem(EXIT_PRESET_STORAGE_KEY, JSON.stringify(overrides));
    }

    function loadExitPresets(defaults) {
      const overrides = loadExitPresetOverrides();
      return defaults.map((preset) => ({
        ...preset,
        ...(overrides[preset.id] || {}),
      }));
    }

    let entryExitPairs = loadStoredJson(ENTRY_EXIT_PAIR_KEY, {});

    function highlightLog(line) {
      let safe = escapeHtml(line);
      const highlights = [
        { regex: /\bBUY\b/g, cls: "log-buy" },
        { regex: /\bSELL\b/g, cls: "log-sell" },
        { regex: /\bTP\b/g, cls: "log-tp" },
        { regex: /\bSL\b/g, cls: "log-sl" },
      ];

      highlights.forEach(({ regex, cls }) => {
        safe = safe.replace(regex, (m) => `<span class="${cls}">${m}</span>`);
      });

      return safe;
    }

    function getExitPresetById(id) {
      return exitPresets.find((preset) => preset.id === id);
    }

    function getEntryExitPair(entryId) {
      if (entryExitPairs[entryId]) return entryExitPairs[entryId];
      const entry = getEntryStrategyById(entryId);
      return entry?.defaultExitPresetId || "";
    }

    function saveEntryExitPair(entryId, presetId) {
      if (!entryId) return;
      if (!presetId) {
        const { [entryId]: _, ...rest } = entryExitPairs;
        entryExitPairs = rest;
      } else {
        entryExitPairs = {
          ...entryExitPairs,
          [entryId]: presetId,
        };
      }
      localStorage.setItem(ENTRY_EXIT_PAIR_KEY, JSON.stringify(entryExitPairs));
    }

    function getEntryStrategyById(id) {
      const numericId = Number(id);
      return entryStrategies.find((s) => s.id === numericId);
    }

    function describeStrategy(id) {
      const meta = getEntryStrategyById(id);
      return meta ? `${meta.id} – ${meta.name}` : `ID ${id}`;
    }

    function buildExitPresetOptions(selectedId) {
      const options = ['<option value="">No preset</option>'];
      exitPresets.forEach((preset) => {
        const selected = preset.id === selectedId ? "selected" : "";
        options.push(
          `<option value="${preset.id}" ${selected}>${escapeHtml(
            formatExitPresetLabel(preset)
          )}</option>`
        );
      });
      return options.join("");
    }

    function renderExitPresetOptions() {
      if (!exitPresetSelectEl) return;
      const current = exitPresetSelectEl.value;
      exitPresetSelectEl.innerHTML = '<option value="" selected disabled>Select exit preset...</option>';
      exitPresets.forEach((preset) => {
        const opt = document.createElement("option");
        opt.value = preset.id;
        opt.textContent = formatExitPresetLabel(preset);
        exitPresetSelectEl.appendChild(opt);
      });
      if (current) {
        exitPresetSelectEl.value = current;
      }
    }

    function renderEntryStrategyOptions() {
      if (!entryStrategySelectEl) return;
      entryStrategySelectEl.innerHTML = '<option value="" disabled selected>Select entry strategy...</option>';
      entryStrategies.forEach((s) => {
        const opt = document.createElement("option");
        opt.value = s.id;
        opt.textContent = `${s.id} – ${s.name}`;
        entryStrategySelectEl.appendChild(opt);
      });
    }

    function renderEntryStrategyTable() {
      if (!strategyTableBodyEl) return;
      const rows = entryStrategies.map((s) => {
        const params = s.parameters
          .map((p) => `<div><strong>${p.label}:</strong> ${p.value}</div>`)
          .join("");
        const pairedExitId = getEntryExitPair(s.id);
        const pairingSelect = `
          <div style="display: flex; flex-direction: column; gap: 6px;">
            <select class="pairing-select" data-entry-id="${s.id}">
              ${buildExitPresetOptions(pairedExitId)}
            </select>
            <button class="btn btn-outline btn-small" data-action="load-pair" data-entry-id="${s.id}">
              Load exit preset
            </button>
          </div>
        `;
        return `
          <tr>
            <td>${s.id}</td>
            <td>${escapeHtml(s.name)}</td>
            <td><div><strong>Purpose:</strong> ${escapeHtml(s.purpose)}</div><div><strong>Behavior:</strong> ${escapeHtml(s.behavior)}</div></td>
            <td>${escapeHtml(s.logicGroup || "—")}</td>
            <td>${pairingSelect}</td>
            <td>${params}</td>
          </tr>
        `;
      });
      strategyTableBodyEl.innerHTML = rows.join("");
    }

    function renderExitPresetTable() {
      if (!exitStrategyTableBodyEl) return;
      const rows = exitPresets.map((preset) => {
        const values = `
          <div class="preset-inputs">
            <label class="preset-input">SL
              <input type="number" step="0.1" min="0.1" max="50" value="${preset.sl}" data-field="sl" />
            </label>
            <label class="preset-input">TP
              <input type="number" step="0.1" min="0.1" max="100" value="${preset.tp}" data-field="tp" />
            </label>
            <label class="preset-input">Trail Start
              <input type="number" step="0.1" min="0.1" max="100" value="${preset.trailStart}" data-field="trailStart" />
            </label>
            <label class="preset-input">Trail Distance
              <input type="number" step="0.1" min="0.1" max="100" value="${preset.trailDistance}" data-field="trailDistance" />
            </label>
            <label class="preset-input">Candle Red
              <input type="number" step="1" min="0" max="100" value="${preset.candleRed}" data-field="candleRed" />
            </label>
          </div>
        `;
        return `
          <tr data-exit-id="${preset.id}">
            <td>${preset.order}</td>
            <td>${escapeHtml(preset.name)}</td>
            <td>${escapeHtml(preset.purpose)}</td>
            <td>${values}</td>
            <td>
              <div style="display: flex; flex-direction: column; gap: 6px;">
                <button class="btn btn-outline btn-small" data-action="load-exit" data-exit-id="${preset.id}">
                  Load
                </button>
                <button class="btn btn-primary btn-small" data-action="save-exit" data-exit-id="${preset.id}">
                  Save
                </button>
                <button class="btn btn-outline btn-small" data-action="reset-exit" data-exit-id="${preset.id}">
                  Reset
                </button>
              </div>
            </td>
          </tr>
        `;
      });
      exitStrategyTableBodyEl.innerHTML = rows.join("");
    }

    function readExitPresetInputs(row) {
      const values = {};
      const fields = ["sl", "tp", "trailStart", "trailDistance", "candleRed"];
      fields.forEach((field) => {
        const input = row.querySelector(`input[data-field="${field}"]`);
        const value = input ? Number(input.value) : NaN;
        values[field] = value;
      });
      return values;
    }

    function isExitPresetValid(values) {
      return (
        Number.isFinite(values.sl) &&
        Number.isFinite(values.tp) &&
        Number.isFinite(values.trailStart) &&
        Number.isFinite(values.trailDistance) &&
        Number.isFinite(values.candleRed) &&
        values.sl > 0 &&
        values.tp > 0 &&
        values.trailStart > 0 &&
        values.trailDistance > 0 &&
        values.candleRed >= 0 &&
        values.candleRed <= 100
      );
    }

    function saveExitPreset(id, values) {
      const overrides = loadExitPresetOverrides();
      overrides[id] = values;
      saveExitPresetOverrides(overrides);
      exitPresets = loadExitPresets(exitPresetDefaults);
    }

    function resetExitPreset(id) {
      const overrides = loadExitPresetOverrides();
      delete overrides[id];
      saveExitPresetOverrides(overrides);
      exitPresets = loadExitPresets(exitPresetDefaults);
    }

    function updateStrategyUiFromStatus(activeId) {
      const meta = getEntryStrategyById(activeId);
      const label = meta ? `${meta.id} – ${meta.name}` : activeId ?? "–";
      statusEls.strategy.textContent = label || "–";
      if (entryStrategySelectEl) {
        entryStrategySelectEl.value = meta ? String(meta.id) : "";
      }
      if (meta) {
        const pairedExitId = getEntryExitPair(meta.id);
        const pairedPreset = pairedExitId ? getExitPresetById(pairedExitId) : null;
        const pairedExit = pairedPreset
          ? ` • Suggested Exit: ${formatExitPresetLabel(pairedPreset)}`
          : "";
        strategyStatusEl.textContent = `Entry Strategy: ${meta.id} – ${meta.name}${pairedExit}`;
      } else if (activeId != null) {
        strategyStatusEl.textContent = `Entry Strategy: ${activeId}`;
      } else {
        strategyStatusEl.textContent = "Select an entry strategy to send it live.";
      }
    }

    function updateSummaryGroup(key, stats) {
      const cfg = summaryConfig[key];
      const els = summaryEls[key];
      if (!cfg || !els || !els.pnlValue) return;

      const total = Number(stats?.total) || 0;
      const wins = Number(stats?.wins) || 0;
      const losses = Number(stats?.losses) || 0;

      let sumPnLPct = Number(stats?.sumPnLPct);
      let sumPnlValue = Number(stats?.sumPnlValue);

      if (!Number.isFinite(sumPnLPct)) sumPnLPct = 0;
      if (!Number.isFinite(sumPnlValue)) sumPnlValue = 0;

      els.pnlValue.textContent = formatUsd(sumPnlValue);
      els.pnlPct.textContent = formatPnl(sumPnLPct);
      els.trades.textContent = String(total);
      els.winLoss.textContent = `Wins ${wins} • Losses ${losses}`;

      if (total > 0) {
        const winRate = (wins / total) * 100;
        els.winRate.textContent = `${winRate.toFixed(1)}%`;
        const avgPnl = sumPnLPct / total;
        els.avgPnl.textContent = `Avg/Trade: ${formatPnl(avgPnl)}`;
      } else {
        els.winRate.textContent = "0%";
        els.avgPnl.textContent = `No trades in last ${cfg.label}`;
      }
    }

    function updateSummaryBar(allStats) {
      if (!allStats) return;
      Object.keys(summaryConfig).forEach((key) => {
        updateSummaryGroup(key, allStats?.[key]);
      });
    }

    function stopPolling() {
      if (statusTimer) clearInterval(statusTimer);
      if (logTimer) clearInterval(logTimer);
      if (logListTimer) clearInterval(logListTimer);
      statusTimer = null;
      logTimer = null;
      logListTimer = null;
    }

    function startPolling() {
      fetchStatus();
      fetchLogs();
      fetchLogFiles();
      statusTimer = setInterval(fetchStatus, 8000);
      logTimer = setInterval(fetchLogs, 5000);
      logListTimer = setInterval(fetchLogFiles, 15000);
    }

    function applyMarketTheme(target) {
      document.body.classList.toggle("theme-crypto", target === "crypto");
      document.body.classList.toggle("theme-stocks", target === "stocks");
      if (sellAllBtnEl) {
        sellAllBtnEl.textContent =
          target === "stocks" ? "SELL ALL (Stocks)" : "SELL ALL (Crypto)";
      }
      if (entryStrategyMarketLabelEl) {
        entryStrategyMarketLabelEl.textContent =
          target === "stocks"
            ? "Entry Strategy Presets - Stocks (US Equities)"
            : "Entry Strategy Presets - Crypto";
      }
    }

    function setActiveMarket(nextMarket) {
      const target = nextMarket === "stocks" ? "stocks" : "crypto";
      currentMarket = target;
      localStorage.setItem("activeMarket", target);
      selectedLogFile = "";
      updateLogDownloadLink();
      marketTabButtons.forEach((btn) =>
        btn.classList.toggle("active", btn.dataset.market === target)
      );
      applyMarketTheme(target);
      stopPolling();
      startPolling();
    }

    // --- STATUS POLLING ---
    async function fetchStatus() {
      try {
        const res = await fetch(`/api/status?market=${currentMarket}`);
        const data = await res.json();
        if (!data.ok) throw new Error("status not ok");

        const cfg = data;
        setBotRunUi(data.botRunning !== false);
        updateStrategyUiFromStatus(cfg.activeStrategyId);

        const intervalMs = cfg.config?.loopIntervalMs || cfg.loopIntervalMs;
        statusEls.interval.textContent = intervalMs ? intervalMs / 1000 + " s" : "–";

        const perfEquity = data.performance?.lastEquity;
        const alpacaEquity = data.alpaca?.equity;
        const equityValue =
          currentMarket === "stocks" && alpacaEquity != null
            ? alpacaEquity
            : perfEquity;

        if (equityValue != null) {
          const equity = Number(equityValue);
          const quoteLabel = currentMarket === "stocks" ? "USD" : "USDT";
          statusEls.equity.textContent = Number.isFinite(equity)
            ? equity.toFixed(2) + " " + quoteLabel
            : "-";
        } else {
          statusEls.equity.textContent = "-";
        }

        if (data.performance) {
          statusEls.pnl.textContent = formatPnl(data.performance.lastPnlPct);
        }

        if (data.exitConfig) {
          const ex = data.exitConfig;

          exitElems.slValue.textContent = pctText(ex.slPct);
          exitElems.tpValue.textContent = pctText(ex.tpPct);
          exitElems.trailStartValue.textContent = pctText(ex.trailStartPct);
          exitElems.trailDistanceValue.textContent = pctText(ex.trailDistancePct);
          const candleEnabled = !!ex.candleExitEnabled;
          exitElems.candleRedValue.textContent = candleEnabled
            ? pctText(ex.candleRedTriggerPct, 0)
            : "Disabled";
          exitElems.candleEnabledInput.checked = candleEnabled;
          exitElems.candleRedInput.disabled = !candleEnabled;

          // Prefill inputs only if empty, to avoid overwriting user typing
          if (!exitElems.slInput.value && ex.slPct != null)
            exitElems.slInput.value = (ex.slPct * 100).toFixed(2);
          if (!exitElems.tpInput.value && ex.tpPct != null)
            exitElems.tpInput.value = (ex.tpPct * 100).toFixed(2);
          if (!exitElems.trailStartInput.value && ex.trailStartPct != null)
            exitElems.trailStartInput.value = (ex.trailStartPct * 100).toFixed(2);
          if (!exitElems.trailDistanceInput.value && ex.trailDistancePct != null)
            exitElems.trailDistanceInput.value = (ex.trailDistancePct * 100).toFixed(2);
          if (!exitElems.candleRedInput.value && ex.candleRedTriggerPct != null)
            exitElems.candleRedInput.value = (ex.candleRedTriggerPct * 100).toFixed(0);
        }

        const symbolsCount =
          data.symbolsCount != null
            ? data.symbolsCount
            : data.stateSummary?.symbols;
        statusEls.symbols.textContent =
          symbolsCount != null ? String(symbolsCount) : "–";

        const isStocks = currentMarket === "stocks";
        stocksOnlyEls.forEach((el) => el.classList.toggle("active", isStocks));
        if (isStocks && data.marketClock) {
          const clock = data.marketClock;
          const isOpen = clock.isOpen === true;
          statusEls.stocksMarketOpen.innerHTML = isOpen
            ? '<span class="badge badge-green">OPEN</span>'
            : '<span class="badge badge-amber">CLOSED</span>';
          statusEls.stocksNextOpen.textContent = clock.nextOpen || "?";
          statusEls.stocksCountdown.textContent = clock.countdown || "?";
          if (stocksCountdownRowEl) {
            stocksCountdownRowEl.classList.toggle("countdown-focus", !isOpen);
          }
          if (statusEls.stocksCountdownNote) {
            statusEls.stocksCountdownNote.textContent = isOpen
              ? ""
              : "Bot running - waiting for market open";
          }
        }

        if (isStocks && statusEls.alpaca) {
          const alpaca = data.alpaca || {};
          if (alpaca.connected) {
            const base = alpaca.baseUrl
              ? " " + escapeHtml(String(alpaca.baseUrl))
              : "";
            statusEls.alpaca.innerHTML =
              '<span class="badge badge-green">CONNECTED</span>' + base;
          } else {
            const err = alpaca.lastError
              ? " " + escapeHtml(String(alpaca.lastError))
              : "";
            statusEls.alpaca.innerHTML =
              '<span class="badge badge-red">DISCONNECTED</span>' + err;
          }
        } else if (statusEls.alpaca) {
          statusEls.alpaca.textContent = "-";
        }

        updateSummaryBar(data.tradeStats || {});

        statusEls.updated.textContent =
          "Last update: " +
          formatTs(
            data.stateSummary?.lastUpdateTs ||
              data.performance?.lastUpdateTs ||
              Date.now()
          );
      } catch (err) {
        statusEls.updated.textContent = "Status error: " + err.message;
      }
    }

    // --- EXIT SETTINGS ---
    async function updateExitConfig() {
      try {
        exitStatusEl.textContent = "Sending EXIT config...";

        const sl = parseFloat(exitElems.slInput.value);
        const tp = parseFloat(exitElems.tpInput.value);
        const ts = parseFloat(exitElems.trailStartInput.value);
        const td = parseFloat(exitElems.trailDistanceInput.value);
        const cr = parseFloat(exitElems.candleRedInput.value);
        const candleEnabled = exitElems.candleEnabledInput.checked;

        const payload = {};

        if (!Number.isNaN(sl)) payload.slPct = sl / 100.0;
        if (!Number.isNaN(tp)) payload.tpPct = tp / 100.0;
        if (!Number.isNaN(ts)) payload.trailStartPct = ts / 100.0;
        if (!Number.isNaN(td)) payload.trailDistancePct = td / 100.0;
        if (!Number.isNaN(cr)) payload.candleRedTriggerPct = cr / 100.0;
        payload.candleExitEnabled = candleEnabled;

        const res = await fetch(`/api/config?market=${currentMarket}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        const data = await res.json();
        if (!data.ok) throw new Error(data.error || "failed");

        exitStatusEl.textContent = "EXIT updated successfully.";
        await fetchStatus();
      } catch (err) {
        exitStatusEl.textContent = "Error: " + err.message;
      }
    }

    // --- SETTINGS ---
    async function fetchSettings() {
      try {
        settingsStatusEl.textContent = "Loading settings...";
        const res = await fetch("/api/settings");
        const data = await res.json();
        if (!data.ok) throw new Error(data.error || "failed");

        const settings = data.settings || {};
        settingsInputs.binanceApiKey.value = settings.binanceApiKey || "";
        settingsInputs.binanceApiSecret.value = settings.binanceApiSecret || "";
        settingsInputs.binanceBaseUrl.value = settings.binanceBaseUrl || "";
        settingsInputs.tradingViewWebhookUrl.value =
          settings.tradingViewWebhookUrl || "";
        settingsInputs.marketType.value = settings.marketType || "crypto";
        settingsInputs.alpacaApiKey.value = settings.alpacaApiKey || "";
        settingsInputs.alpacaApiSecret.value = settings.alpacaApiSecret || "";
        settingsInputs.alpacaTradingBaseUrl.value =
          settings.alpacaTradingBaseUrl || "";
        settingsInputs.alpacaDataBaseUrl.value =
          settings.alpacaDataBaseUrl || "";
        settingsInputs.alpacaDataFeed.value = settings.alpacaDataFeed || "";
        settingsStatusEl.textContent = "";
      } catch (err) {
        settingsStatusEl.textContent = "Settings error: " + err.message;
      }
    }

    async function saveSettings() {
      try {
        settingsStatusEl.textContent = "Saving settings...";
        const payload = {
          binanceApiKey: settingsInputs.binanceApiKey.value.trim(),
          binanceApiSecret: settingsInputs.binanceApiSecret.value.trim(),
          binanceBaseUrl: settingsInputs.binanceBaseUrl.value.trim(),
          tradingViewWebhookUrl: settingsInputs.tradingViewWebhookUrl.value.trim(),
          marketType: settingsInputs.marketType.value,
          alpacaApiKey: settingsInputs.alpacaApiKey.value.trim(),
          alpacaApiSecret: settingsInputs.alpacaApiSecret.value.trim(),
          alpacaTradingBaseUrl: settingsInputs.alpacaTradingBaseUrl.value.trim(),
          alpacaDataBaseUrl: settingsInputs.alpacaDataBaseUrl.value.trim(),
          alpacaDataFeed: settingsInputs.alpacaDataFeed.value.trim(),
        };

        const res = await fetch("/api/settings", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        const data = await res.json();
        if (!data.ok) throw new Error(data.error || "failed");
        settingsStatusEl.textContent = "Settings saved successfully.";
      } catch (err) {
        settingsStatusEl.textContent = "Settings error: " + err.message;
      }
    }

    // --- LOGS POLLING ---
    function updateLogDownloadLink() {
      if (selectedLogFile) {
        logDownloadLinkEl.href = `/api/logs/download?market=${currentMarket}&file=${encodeURIComponent(selectedLogFile)}`;
        logDownloadLinkEl.setAttribute("aria-disabled", "false");
      } else {
        logDownloadLinkEl.removeAttribute("href");
        logDownloadLinkEl.setAttribute("aria-disabled", "true");
      }
    }

    async function fetchLogFiles() {
      try {
        const res = await fetch(`/api/logs/list?market=${currentMarket}`);
        const data = await res.json();
        if (!data.ok || !Array.isArray(data.files)) {
          throw new Error("invalid log list");
        }

        const options = ["<option value=\"\">Latest (live)</option>"];
        data.files.forEach((file) => {
          const sizeKb = file.size ? (file.size / 1024).toFixed(1) : "0";
          const label = file.date ? `${file.date} (${sizeKb} KB)` : `${file.name} (${sizeKb} KB)`;
          const selected = file.name === selectedLogFile ? "selected" : "";
          options.push(`<option value="${file.name}" ${selected}>${label}</option>`);
        });

        logFileSelectEl.innerHTML = options.join("");

        if (selectedLogFile && !data.files.find((f) => f.name === selectedLogFile)) {
          selectedLogFile = "";
        }

        updateLogDownloadLink();
      } catch (err) {
        logStatusPillEl.textContent = "Log list error: " + err.message;
      }
    }

    async function fetchLogs() {
      try {
        const url = selectedLogFile
          ? `/api/logs?market=${currentMarket}&file=${encodeURIComponent(selectedLogFile)}`
          : `/api/logs?market=${currentMarket}`;
        const res = await fetch(url);
        const data = await res.json();
        if (!data.ok || !Array.isArray(data.lines)) {
          throw new Error("invalid log payload");
        }

        const prefix = currentMarket === "stocks" ? "[STOCKS] " : "[CRYPTO] ";
        const html = (data.lines || [])
          .map((line) => highlightLog(prefix + line))
          .join("<br>");
        logContainerEl.innerHTML = html || "(no logs yet)";
        // auto scroll to bottom
        logContainerEl.scrollTop = logContainerEl.scrollHeight;
        const label = selectedLogFile ? `Viewing ${selectedLogFile}` : "Polling every 5s";
        logStatusPillEl.textContent = `${label} • ${new Date().toLocaleTimeString()}`;
      } catch (err) {
        logStatusPillEl.textContent = "Log error: " + err.message;
      }
    }

    // --- CONTROLS ---
    async function startBot() {
      try {
        botControlStatusEl.textContent = "Starting bot...";
        const res = await fetch("/api/bot/start", { method: "POST" });
        const data = await res.json();
        if (!res.ok || !data.ok) throw new Error(data.error || "failed");
        botControlStatusEl.textContent = "Bot resumed. Continuing from saved state.";
        setBotRunUi(true);
      } catch (err) {
        botControlStatusEl.textContent = "Error: " + err.message;
      }
    }

    async function stopBot() {
      try {
        botControlStatusEl.textContent = "Stopping bot after current loop...";
        const res = await fetch("/api/bot/stop", { method: "POST" });
        const data = await res.json();
        if (!res.ok || !data.ok) throw new Error(data.error || "failed");
        botControlStatusEl.textContent = "Bot will pause after persisting state.";
        setBotRunUi(false);
      } catch (err) {
        botControlStatusEl.textContent = "Error: " + err.message;
      }
    }

    async function setStrategy(id) {
      try {
        const label = describeStrategy(id);
        strategyStatusEl.textContent = `Sending strategy change for ${label}...`;
        const res = await fetch(`/api/config?market=${currentMarket}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ activeStrategyId: Number(id) }),
        });
        const data = await res.json();
        if (!data.ok) throw new Error(data.error || "failed");
        strategyStatusEl.textContent = "Entry Strategy set to " + label;
        await fetchStatus();
      } catch (err) {
        strategyStatusEl.textContent = "Error: " + err.message;
      }
    }

    async function setIntervalMs(ms) {
      try {
        intervalStatusEl.textContent = "Sending interval change...";
        const res = await fetch(`/api/config?market=${currentMarket}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ loopIntervalMs: ms }),
        });
        const data = await res.json();
        if (!data.ok) throw new Error(data.error || "failed");
        intervalStatusEl.textContent = "Interval set to " + ms / 1000 + " sec";
        await fetchStatus();
      } catch (err) {
        intervalStatusEl.textContent = "Error: " + err.message;
      }
    }

    async function sellAll() {
      try {
        intervalStatusEl.textContent = "Sending SELL ALL...";
        const res = await fetch(`/api/sellAll?market=${currentMarket}`, {
          method: "POST",
        });
        const data = await res.json();
        if (!data.ok) throw new Error(data.error || "failed");
        intervalStatusEl.textContent = "SELL ALL requested";
      } catch (err) {
        intervalStatusEl.textContent = "Error: " + err.message;
      }
    }

    startBotBtn.addEventListener("click", startBot);
    stopBotBtn.addEventListener("click", stopBot);
    settingsToggleBtn.addEventListener("click", () => {
      settingsPanelEl.classList.toggle("open");
      if (settingsPanelEl.classList.contains("open")) {
        fetchSettings();
      }
    });
    saveSettingsBtn.addEventListener("click", saveSettings);
    applyExitPresetBtn.addEventListener("click", () => {
      const presetId = exitPresetSelectEl.value;
      if (!presetId) {
        exitStatusEl.textContent = "Please choose a preset first.";
        return;
      }
      applyExitPreset(presetId);
    });
    exitPresetSelectEl.addEventListener("change", () => {
      if (exitPresetSelectEl.value) {
        applyExitPreset(exitPresetSelectEl.value);
      }
    });

    tabButtons.forEach((button) => {
      button.addEventListener("click", () => {
        const target = button.dataset.tab;
        tabButtons.forEach((btn) => btn.classList.toggle("active", btn === button));
        tabPanels.forEach((panel) =>
          panel.classList.toggle("active", panel.id === `${target}StrategyTab`)
        );
      });
    });

    strategyTableBodyEl.addEventListener("change", (event) => {
      const target = event.target;
      if (!(target instanceof HTMLSelectElement)) return;
      if (!target.classList.contains("pairing-select")) return;
      const entryId = Number(target.dataset.entryId);
      saveEntryExitPair(entryId, target.value);
      strategyStatusEl.textContent = `Saved pairing for Entry ${entryId}.`;
    });

    strategyTableBodyEl.addEventListener("click", (event) => {
      const button = event.target.closest("button");
      if (!button) return;
      const action = button.dataset.action;
      if (action !== "load-pair") return;
      const entryId = Number(button.dataset.entryId);
      const selectEl = strategyTableBodyEl.querySelector(
        `select.pairing-select[data-entry-id="${entryId}"]`
      );
      const presetId = selectEl?.value;
      if (!presetId) {
        exitStatusEl.textContent = "Select an exit preset to load.";
        return;
      }
      applyExitPreset(presetId);
    });

    exitStrategyTableBodyEl.addEventListener("click", (event) => {
      const button = event.target.closest("button");
      if (!button) return;
      const action = button.dataset.action;
      const presetId = button.dataset.exitId;
      if (!action || !presetId) return;
      const row = button.closest("tr");
      if (!row) return;
      if (action === "load-exit") {
        applyExitPreset(presetId);
        return;
      }
      if (action === "save-exit") {
        const values = readExitPresetInputs(row);
        if (!isExitPresetValid(values)) {
          exitStatusEl.textContent = "Please enter valid numbers before saving.";
          return;
        }
        saveExitPreset(presetId, values);
        renderExitPresetOptions();
        renderExitPresetTable();
        renderEntryStrategyTable();
        const preset = getExitPresetById(presetId);
        exitStatusEl.textContent = preset
          ? `${formatExitPresetLabel(preset)} saved.`
          : "Preset saved.";
        return;
      }
      if (action === "reset-exit") {
        resetExitPreset(presetId);
        renderExitPresetOptions();
        renderExitPresetTable();
        renderEntryStrategyTable();
        const preset = getExitPresetById(presetId);
        exitStatusEl.textContent = preset
          ? `${formatExitPresetLabel(preset)} reset to default.`
          : "Preset reset.";
      }
    });

    exitElems.candleEnabledInput.addEventListener("change", () => {
      exitElems.candleRedInput.disabled = !exitElems.candleEnabledInput.checked;
    });

    entryStrategySelectEl.addEventListener("change", () => {
      const id = Number(entryStrategySelectEl.value);
      if (!id) return;
      setStrategy(id);
    });

    marketTabButtons.forEach((button) => {
      button.addEventListener("click", () => {
        const target = button.dataset.market;
        if (!target) return;
        setActiveMarket(target);
      });
    });

    renderExitPresetOptions();
    renderEntryStrategyOptions();
    renderEntryStrategyTable();
    renderExitPresetTable();

    logFileSelectEl.addEventListener("change", () => {
      selectedLogFile = logFileSelectEl.value;
      updateLogDownloadLink();
      fetchLogs();
    });

    logLoadBtn.addEventListener("click", () => {
      fetchLogs();
    });

    logRefreshBtn.addEventListener("click", () => {
      fetchLogFiles();
    });

    // --- INITIAL LOAD ---
    setActiveMarket(currentMarket);
  </script>
</body>
</html>
