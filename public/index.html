<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Trading Bot Control Panel</title>
    <style>
      body { font-family: Arial, sans-serif; margin: 20px; }
      h1 { margin-bottom: 10px; }
      .section {
        margin-bottom: 16px;
        padding: 10px;
        border: 1px solid #ddd;
      }
      .section h2 {
        margin-top: 0;
        font-size: 18px;
      }
      .btn {
        padding: 8px 14px;
        margin: 4px;
        cursor: pointer;
        border: none;
        border-radius: 4px;
      }
      .btn-primary { background: #007bff; color: #fff; }
      .btn-danger { background: #dc3545; color: #fff; }
      .btn-outline { background: #fff; border: 1px solid #aaa; }
      .log-box {
        margin-top: 8px;
        padding: 10px;
        border: 1px solid #ccc;
        height: 400px;
        overflow-y: scroll;
        background: #111;
        color: #0f0;
        font-family: monospace;
        font-size: 12px;
      }
      .label {
        display: inline-block;
        margin-right: 8px;
      }
      .row { margin-bottom: 6px; }
    </style>
  </head>
  <body>
    <h1>Trading Bot Control Panel</h1>

    <!-- STATUS -->
    <div class="section">
      <h2>Status</h2>
      <div class="row">Active Strategy: <span id="strategy-span">-</span></div>
      <div class="row">Loop Interval: <span id="interval-span">-</span></div>
      <div class="row">Kill Switch Pending: <span id="kill-span">false</span></div>
      <div class="row">Symbols in state: <span id="symbols-span">0</span></div>
      <div class="row">Equity: <span id="equity-span">-</span></div>
      <div class="row">PNL %: <span id="pnl-span">-</span></div>
    </div>

    <!-- SETTINGS -->
    <div class="section">
      <h2>Settings</h2>

      <div class="row">
        <span class="label">Strategy:</span>
        <label><input type="radio" name="strategy" value="1" onclick="setStrategy(1)" /> 1 (SMA)</label>
        <label><input type="radio" name="strategy" value="2" onclick="setStrategy(2)" /> 2 (Trend/RSI)</label>
        <label><input type="radio" name="strategy" value="3" onclick="setStrategy(3)" /> 3 (EMA/ATR)</label>
      </div>

      <div class="row">
  <span class="label">Loop interval:</span>
  <button class="btn btn-outline" onclick="setIntervalMs(60000)">Every 60s</button>
  <button class="btn btn-outline" onclick="setIntervalMs(300000)">Every 5 min</button>
  <button class="btn btn-outline" onclick="setIntervalMs(900000)">Every 15 min</button>
</div>

<div class="row">
  <button class="btn btn-danger" onclick="killSwitch()">SELL ALL NOW</button>

  <button id="resetFundsBtn" class="btn btn-outline" style="margin-left: 10px;">
    RESET FUNDS (10,000 USDT)
  </button>
  <span id="resetFundsStatus" style="margin-left: 10px; color: #999;"></span>
</div>
</div>

    <!-- LOGS -->
    <div class="section">
      <h2>Logs</h2>
      <div id="logs" class="log-box"></div>
    </div>

    <script>
      async function refreshStatus() {
        try {
          const res = await fetch("/api/status");
          const data = await res.json();
          if (!data.ok) return;

          document.getElementById("strategy-span").textContent =
            data.activeStrategyId;
          document.getElementById("symbols-span").textContent =
            data.stateSummary?.symbols ?? 0;
          document.getElementById("kill-span").textContent =
            data.killSwitch ? "true" : "false";

          if (data.performance && data.performance.lastEquity != null) {
            document.getElementById("equity-span").textContent =
              data.performance.lastEquity.toFixed(2) + " USDT";
          }
          if (data.performance && data.performance.lastPnlPct != null) {
            document.getElementById("pnl-span").textContent =
              data.performance.lastPnlPct.toFixed(2) + " %";
          }
        } catch (e) {
          console.error(e);
        }
      }

      async function refreshConfig() {
        try {
          const res = await fetch("/api/config");
          const data = await res.json();
          if (!data.ok) return;

          const cfg = data.config || {};
          // אסטרטגיה
          if (cfg.activeStrategyId) {
            const radios = document.querySelectorAll('input[name="strategy"]');
            radios.forEach((r) => {
              r.checked = Number(r.value) === Number(cfg.activeStrategyId);
            });
          }

          // אינטרוול
          let label = "-";
          if (cfg.loopIntervalMs === 60000) label = "Every 60s";
          else if (cfg.loopIntervalMs === 300000) label = "Every 5 min";
          else if (cfg.loopIntervalMs === 900000) label = "Every 15 min";
          else if (cfg.loopIntervalMs) label = cfg.loopIntervalMs + " ms";

          document.getElementById("interval-span").textContent = label;
        } catch (e) {
          console.error(e);
        }
      }

      async function refreshLogs() {
        try {
          const res = await fetch("/api/logs");
          const data = await res.json();
          if (!data.ok) return;
          const box = document.getElementById("logs");
          box.textContent = data.lines.join("\n");
          box.scrollTop = box.scrollHeight;
        } catch (e) {
          console.error(e);
        }
      }

      async function setStrategy(id) {
        try {
          await fetch("/api/config", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ activeStrategyId: id }),
          });
          refreshConfig();
          refreshStatus();
        } catch (e) {
          console.error(e);
        }
      }

      async function setIntervalMs(ms) {
        try {
          await fetch("/api/config", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ loopIntervalMs: ms }),
          });
          refreshConfig();
        } catch (e) {
          console.error(e);
        }
      }

      async function killSwitch() {
        try {
          await fetch("/api/kill", { method: "POST" });
          refreshStatus();
        } catch (e) {
          console.error(e);
        }
      }

      // רענון אוטומטי
      setInterval(refreshStatus, 5000);
      setInterval(refreshLogs, 5000);
      refreshStatus();
      refreshConfig();
      refreshLogs();
    </script>
  </body>
</html>
