<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Crypto Bot Control Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #111827;
      color: #e5e7eb;
    }
    .container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 20px;
    }
    h1 {
      margin: 0 0 10px;
      font-size: 24px;
      color: #f9fafb;
    }
    .subtitle {
      margin-bottom: 20px;
      color: #9ca3af;
      font-size: 14px;
    }
    .control-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #1f2933;
      border-radius: 8px;
      padding: 12px 16px;
      border: 1px solid #111827;
      margin-bottom: 14px;
      box-shadow: 0 0 0 1px #111827;
    }
    .control-info {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .control-title {
      font-size: 15px;
      font-weight: 600;
      color: #f9fafb;
    }
    .control-note {
      font-size: 12px;
      color: #9ca3af;
    }
    .control-actions {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .pill-green {
      background: #064e3b;
      color: #6ee7b7;
    }
    .pill-red {
      background: #7f1d1d;
      color: #fecaca;
    }
    .num-input {
      width: 70px;
      padding: 3px 6px;
      border-radius: 4px;
      border: 1px solid #4b5563;
      background: #111827;
      color: #e5e7eb;
      font-size: 12px;
      margin-right: 4px;
    }

    .grid {
      display: grid;
      grid-template-columns: 340px 1fr;
      gap: 20px;
    }

    .card {
      background: #1f2933;
      border-radius: 8px;
      padding: 16px;
      box-shadow: 0 0 0 1px #111827;
    }
    .card h2 {
      margin: 0 0 12px;
      font-size: 18px;
      color: #f9fafb;
    }

    .row {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 8px;
    }
    .row + .row {
      margin-top: 6px;
    }
    .label {
      min-width: 110px;
      font-size: 14px;
      color: #9ca3af;
    }
    .value {
      font-size: 14px;
      color: #e5e7eb;
      font-weight: 500;
    }

    .badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      margin-left: 8px;
    }
    .badge-green {
      background: #064e3b;
      color: #6ee7b7;
    }
    .badge-red {
      background: #7f1d1d;
      color: #fecaca;
    }

    .btn {
      border: none;
      border-radius: 6px;
      padding: 6px 12px;
      font-size: 13px;
      cursor: pointer;
      margin-right: 6px;
      margin-top: 4px;
      transition: background 0.15s, transform 0.05s;
    }
    .btn:active {
      transform: translateY(1px);
    }
    .btn-primary {
      background: #2563eb;
      color: #f9fafb;
    }
    .btn-outline {
      background: transparent;
      color: #e5e7eb;
      border: 1px solid #4b5563;
    }
    .btn-danger {
      background: #b91c1c;
      color: #fee2e2;
    }
    .btn-small {
      font-size: 12px;
      padding: 4px 10px;
    }

    .status-line {
      font-size: 12px;
      color: #9ca3af;
      margin-top: 4px;
    }

    /* LOG AREA LIKE TERMINAL */
    .log-container {
      background: #000000;
      border-radius: 8px;
      padding: 8px 10px;
      border: 1px solid #4b5563;
      height: 520px;
      overflow-y: auto;
      font-family: "Consolas", "SF Mono", "Menlo", "Monaco", monospace;
      font-size: 12px;
      line-height: 1.3;
      color: #d1d5db;
      white-space: pre; /* שומר על הפורמט בדיוק כמו בטרמינל */
    }

    .log-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }
    .log-title {
      font-size: 13px;
      color: #9ca3af;
    }
    .pill {
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: #111827;
      color: #9ca3af;
      border: 1px solid #4b5563;
    }

    .log-buy {
      color: #34d399;
      font-weight: 700;
    }
    .log-sell {
      color: #f87171;
      font-weight: 700;
    }
    .log-tp {
      color: #fbbf24;
      font-weight: 700;
    }
    .log-sl {
      color: #c084fc;
      font-weight: 700;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Crypto Bot Control Panel</h1>
    <div class="subtitle">
      Live control over strategy, interval, kill switch and reset funds.
      Logs are shown exactly as in the terminal.
    </div>

    <div class="control-bar">
      <div class="control-info">
        <div class="control-title">Bot run control</div>
        <div class="control-note">Pause safely saves state & performance so you can resume later.</div>
      </div>
      <div class="control-actions">
        <span id="botRunBadge" class="pill pill-green">Running</span>
        <button id="startBotBtn" class="btn btn-primary btn-small">START BOT</button>
        <button id="stopBotBtn" class="btn btn-danger btn-small">STOP BOT</button>
      </div>
    </div>
    <div class="status-line" id="botControlStatus"></div>

    <div class="grid">
      <!-- LEFT: STATUS + CONTROLS -->
      <div class="card">
        <h2>Status & Controls</h2>

        <!-- STATUS -->
        <div class="row">
          <span class="label">Strategy:</span>
          <span class="value">
            <span id="statusStrategy">–</span>
          </span>
        </div>
        <div class="row">
          <span class="label">Interval:</span>
          <span class="value"><span id="statusInterval">–</span></span>
        </div>
        <div class="row">
          <span class="label">Last Equity:</span>
          <span class="value">
            <span id="statusEquity">–</span>
          </span>
        </div>
        <div class="row">
          <span class="label">Last PNL:</span>
          <span class="value">
            <span id="statusPnl">–</span>
          </span>
        </div>
        <div class="row">
          <span class="label">Kill switch:</span>
          <span class="value">
            <span id="statusKill">OFF</span>
            <span id="killBadge" class="badge badge-green">Inactive</span>
          </span>
        </div>
        <div class="status-line" id="statusUpdated">Last update: –</div>

        <hr style="border: none; border-top: 1px solid #374151; margin: 10px 0;" />
            <!-- LEFT: EXIT SETTINGS CARD -->
      <div class="card" style="margin-top: 12px;">
        <h2>Exit Settings</h2>

        <!-- ערכים בפועל -->
        <div class="row">
          <span class="label">Current SL:</span>
          <span class="value"><span id="exitSlValue">–</span></span>
        </div>
        <div class="row">
          <span class="label">Current TP:</span>
          <span class="value"><span id="exitTpValue">–</span></span>
        </div>
        <div class="row">
          <span class="label">Trail Start:</span>
          <span class="value"><span id="exitTrailStartValue">–</span></span>
        </div>
        <div class="row">
          <span class="label">Trail Distance:</span>
          <span class="value"><span id="exitTrailDistanceValue">–</span></span>
        </div>
        <div class="row">
          <span class="label">Candle Red:</span>
          <span class="value"><span id="exitCandleRedValue">–</span></span>
        </div>

        <hr style="border: none; border-top: 1px solid #374151; margin: 10px 0;" />

        <!-- עריכה דינמית -->
        <div class="row">
          <span class="label">Edit (%):</span>
          <div>
            <input id="exitSlInput" class="num-input" type="number" step="0.1" min="0.1" max="50" placeholder="SL" />
            <input id="exitTpInput" class="num-input" type="number" step="0.1" min="0.1" max="100" placeholder="TP" />
          </div>
        </div>
        <div class="row">
          <span class="label"></span>
          <div>
            <input id="exitTrailStartInput" class="num-input" type="number" step="0.1" min="0.1" max="100" placeholder="Trail Start" />
            <input id="exitTrailDistanceInput" class="num-input" type="number" step="0.1" min="0.1" max="100" placeholder="Trail Dist." />
          </div>
        </div>
        <div class="row">
          <span class="label">Candle (%):</span>
          <div>
            <input id="exitCandleRedInput" class="num-input" type="number" step="1" min="0" max="100" placeholder="Red %" />
          </div>
        </div>

        <div class="row" style="margin-top: 8px;">
          <span class="label"></span>
          <div>
            <button class="btn btn-primary btn-small" onclick="updateExitConfig()">
              UPDATE EXIT
            </button>
          </div>
        </div>

        <div class="status-line" id="exitStatus"></div>
      </div>

        <!-- STRATEGY SELECTION -->
        <div class="row">
          <span class="label">Strategy:</span>
          <div>
            <button class="btn btn-outline btn-small" onclick="setStrategy(1)">1 – Golden Cross</button>
            <button class="btn btn-outline btn-small" onclick="setStrategy(2)">2 – Trend/Pullback</button>
            <button class="btn btn-outline btn-small" onclick="setStrategy(3)">3 – EMA + ATR</button>
          </div>
        </div>
        <div class="status-line" id="strategyStatus"></div>

        <!-- INTERVAL -->
        <div class="row" style="margin-top: 8px;">
          <span class="label">Loop interval:</span>
          <div>
            <button class="btn btn-outline btn-small" onclick="setIntervalMs(60000)">Every 60s</button>
            <button class="btn btn-outline btn-small" onclick="setIntervalMs(300000)">Every 5 min</button>
            <button class="btn btn-outline btn-small" onclick="setIntervalMs(900000)">Every 15 min</button>
          </div>
        </div>
        <div class="status-line" id="intervalStatus"></div>

        <!-- SELL & RESET -->
        <div class="row" style="margin-top: 10px;">
          <span class="label">Actions:</span>
          <div>
            <button class="btn btn-danger btn-small" onclick="killSwitch()">SELL ALL NOW</button>
            <button id="resetFundsBtn" class="btn btn-outline btn-small" style="margin-left: 6px;">
              RESET FUNDS (10,000 USDT)
            </button>
          </div>
        </div>
        <div class="status-line" id="resetFundsStatus"></div>
      </div>

      <!-- RIGHT: LOG VIEWER -->
      <div class="card">
        <div class="log-header">
          <div class="log-title">Live Logs</div>
          <div>
            <span class="pill" id="logStatusPill">Polling every 5s</span>
          </div>
        </div>
        <div id="logContainer" class="log-container">
          Loading logs...
        </div>
      </div>
    </div>
  </div>

  <script>
    const statusEls = {
      strategy: document.getElementById("statusStrategy"),
      interval: document.getElementById("statusInterval"),
      equity: document.getElementById("statusEquity"),
      pnl: document.getElementById("statusPnl"),
      kill: document.getElementById("statusKill"),
      killBadge: document.getElementById("killBadge"),
      updated: document.getElementById("statusUpdated"),
    };

    const strategyStatusEl = document.getElementById("strategyStatus");
    const intervalStatusEl = document.getElementById("intervalStatus");
    const resetFundsStatusEl = document.getElementById("resetFundsStatus");
    const logContainerEl = document.getElementById("logContainer");
    const logStatusPillEl = document.getElementById("logStatusPill");
    const botControlStatusEl = document.getElementById("botControlStatus");
    const botRunBadgeEl = document.getElementById("botRunBadge");
    const startBotBtn = document.getElementById("startBotBtn");
    const stopBotBtn = document.getElementById("stopBotBtn");

    const exitElems = {
      slValue: document.getElementById("exitSlValue"),
      tpValue: document.getElementById("exitTpValue"),
      trailStartValue: document.getElementById("exitTrailStartValue"),
      trailDistanceValue: document.getElementById("exitTrailDistanceValue"),
      candleRedValue: document.getElementById("exitCandleRedValue"),

      slInput: document.getElementById("exitSlInput"),
      tpInput: document.getElementById("exitTpInput"),
      trailStartInput: document.getElementById("exitTrailStartInput"),
      trailDistanceInput: document.getElementById("exitTrailDistanceInput"),
      candleRedInput: document.getElementById("exitCandleRedInput"),
    };

    const exitStatusEl = document.getElementById("exitStatus");

    // --- HELPERS ---
    function setBotRunUi(running) {
      botRunBadgeEl.textContent = running ? "Running" : "Stopped";
      botRunBadgeEl.classList.toggle("pill-green", running);
      botRunBadgeEl.classList.toggle("pill-red", !running);
      startBotBtn.disabled = running;
      stopBotBtn.disabled = !running;
    }

    function formatTs(ts) {
      if (!ts) return "–";
      const d = new Date(ts);
      return d.toLocaleString();
    }

    function formatPnl(p) {
      if (p === null || p === undefined) return "–";
      const v = Number(p);
      if (Number.isNaN(v)) return "–";
      const sign = v > 0 ? "+" : "";
      return sign + v.toFixed(2) + "%";
    }

    function pctText(v, digits = 2) {
      return v === null || v === undefined ? "–" : (v * 100).toFixed(digits) + "%";
    }

    function escapeHtml(str) {
      return str
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    function highlightLog(line) {
      let safe = escapeHtml(line);
      const highlights = [
        { regex: /\bBUY\b/g, cls: "log-buy" },
        { regex: /\bSELL\b/g, cls: "log-sell" },
        { regex: /\bTP\b/g, cls: "log-tp" },
        { regex: /\bSL\b/g, cls: "log-sl" },
      ];

      highlights.forEach(({ regex, cls }) => {
        safe = safe.replace(regex, (m) => `<span class="${cls}">${m}</span>`);
      });

      return safe;
    }

    // --- STATUS POLLING ---
    async function fetchStatus() {
      try {
        const res = await fetch("/api/status");
        const data = await res.json();
        if (!data.ok) throw new Error("status not ok");

        const cfg = data;
        setBotRunUi(data.botRunning !== false);
        statusEls.strategy.textContent = cfg.activeStrategyId ?? "–";

        const intervalMs = cfg.config?.loopIntervalMs || cfg.loopIntervalMs;
        statusEls.interval.textContent = intervalMs ? intervalMs / 1000 + " s" : "–";

        if (data.performance) {
          if (data.performance.lastEquity != null) {
            const equity = Number(data.performance.lastEquity);
            statusEls.equity.textContent = equity.toFixed(2) + " USDT";
          } else {
            statusEls.equity.textContent = "–";
          }
          statusEls.pnl.textContent = formatPnl(data.performance.lastPnlPct);
        }

        if (data.exitConfig) {
          const ex = data.exitConfig;

          exitElems.slValue.textContent = pctText(ex.slPct);
          exitElems.tpValue.textContent = pctText(ex.tpPct);
          exitElems.trailStartValue.textContent = pctText(ex.trailStartPct);
          exitElems.trailDistanceValue.textContent = pctText(ex.trailDistancePct);
          exitElems.candleRedValue.textContent = pctText(ex.candleRedTriggerPct, 0);

          // Prefill inputs only if empty, to avoid overwriting user typing
          if (!exitElems.slInput.value && ex.slPct != null)
            exitElems.slInput.value = (ex.slPct * 100).toFixed(2);
          if (!exitElems.tpInput.value && ex.tpPct != null)
            exitElems.tpInput.value = (ex.tpPct * 100).toFixed(2);
          if (!exitElems.trailStartInput.value && ex.trailStartPct != null)
            exitElems.trailStartInput.value = (ex.trailStartPct * 100).toFixed(2);
          if (!exitElems.trailDistanceInput.value && ex.trailDistancePct != null)
            exitElems.trailDistanceInput.value = (ex.trailDistancePct * 100).toFixed(2);
          if (!exitElems.candleRedInput.value && ex.candleRedTriggerPct != null)
            exitElems.candleRedInput.value = (ex.candleRedTriggerPct * 100).toFixed(0);
        }

        const isKill = data.killSwitch === true;
        statusEls.kill.textContent = isKill ? "ON" : "OFF";
        if (isKill) {
          statusEls.killBadge.textContent = "Active";
          statusEls.killBadge.classList.remove("badge-green");
          statusEls.killBadge.classList.add("badge-red");
        } else {
          statusEls.killBadge.textContent = "Inactive";
          statusEls.killBadge.classList.remove("badge-red");
          statusEls.killBadge.classList.add("badge-green");
        }

        statusEls.updated.textContent =
          "Last update: " +
          formatTs(data.stateSummary?.lastUpdateTs || data.performance?.lastUpdateTs || Date.now());
      } catch (err) {
        statusEls.updated.textContent = "Status error: " + err.message;
      }
    }

    // --- EXIT SETTINGS ---
    async function updateExitConfig() {
      try {
        exitStatusEl.textContent = "Sending EXIT config...";

        const sl = parseFloat(exitElems.slInput.value);
        const tp = parseFloat(exitElems.tpInput.value);
        const ts = parseFloat(exitElems.trailStartInput.value);
        const td = parseFloat(exitElems.trailDistanceInput.value);
        const cr = parseFloat(exitElems.candleRedInput.value);

        const payload = {};

        if (!Number.isNaN(sl)) payload.slPct = sl / 100.0;
        if (!Number.isNaN(tp)) payload.tpPct = tp / 100.0;
        if (!Number.isNaN(ts)) payload.trailStartPct = ts / 100.0;
        if (!Number.isNaN(td)) payload.trailDistancePct = td / 100.0;
        if (!Number.isNaN(cr)) payload.candleRedTriggerPct = cr / 100.0;

        const res = await fetch("/api/config", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        const data = await res.json();
        if (!data.ok) throw new Error(data.error || "failed");

        exitStatusEl.textContent = "EXIT updated successfully.";
        await fetchStatus();
      } catch (err) {
        exitStatusEl.textContent = "Error: " + err.message;
      }
    }

    // --- LOGS POLLING ---
    async function fetchLogs() {
      try {
        const res = await fetch("/api/logs");
        const data = await res.json();
        if (!data.ok || !Array.isArray(data.lines)) {
          throw new Error("invalid log payload");
        }

        const html = (data.lines || []).map((line) => highlightLog(line)).join("<br>");
        logContainerEl.innerHTML = html || "(no logs yet)";
        // auto scroll to bottom
        logContainerEl.scrollTop = logContainerEl.scrollHeight;
        logStatusPillEl.textContent = "Last log update: " + new Date().toLocaleTimeString();
      } catch (err) {
        logStatusPillEl.textContent = "Log error: " + err.message;
      }
    }

    // --- CONTROLS ---
    async function startBot() {
      try {
        botControlStatusEl.textContent = "Starting bot...";
        const res = await fetch("/api/bot/start", { method: "POST" });
        const data = await res.json();
        if (!res.ok || !data.ok) throw new Error(data.error || "failed");
        botControlStatusEl.textContent = "Bot resumed. Continuing from saved state.";
        setBotRunUi(true);
      } catch (err) {
        botControlStatusEl.textContent = "Error: " + err.message;
      }
    }

    async function stopBot() {
      try {
        botControlStatusEl.textContent = "Stopping bot after current loop...";
        const res = await fetch("/api/bot/stop", { method: "POST" });
        const data = await res.json();
        if (!res.ok || !data.ok) throw new Error(data.error || "failed");
        botControlStatusEl.textContent = "Bot will pause after persisting state.";
        setBotRunUi(false);
      } catch (err) {
        botControlStatusEl.textContent = "Error: " + err.message;
      }
    }

    async function setStrategy(id) {
      try {
        strategyStatusEl.textContent = "Sending strategy change...";
        const res = await fetch("/api/config", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ activeStrategyId: id }),
        });
        const data = await res.json();
        if (!data.ok) throw new Error(data.error || "failed");
        strategyStatusEl.textContent = "Strategy set to " + id;
        await fetchStatus();
      } catch (err) {
        strategyStatusEl.textContent = "Error: " + err.message;
      }
    }

    async function setIntervalMs(ms) {
      try {
        intervalStatusEl.textContent = "Sending interval change...";
        const res = await fetch("/api/config", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ loopIntervalMs: ms }),
        });
        const data = await res.json();
        if (!data.ok) throw new Error(data.error || "failed");
        intervalStatusEl.textContent = "Interval set to " + ms / 1000 + " sec";
        await fetchStatus();
      } catch (err) {
        intervalStatusEl.textContent = "Error: " + err.message;
      }
    }

    async function killSwitch() {
      try {
        intervalStatusEl.textContent = "Sending SELL ALL...";
        const res = await fetch("/api/kill", { method: "POST" });
        const data = await res.json();
        if (!data.ok) throw new Error(data.error || "failed");
        intervalStatusEl.textContent = "SELL ALL requested";
      } catch (err) {
        intervalStatusEl.textContent = "Error: " + err.message;
      }
    }

    async function resetFundsGui() {
      try {
        resetFundsStatusEl.textContent = "Sending RESET FUNDS...";
        const res = await fetch("/api/resetFunds", { method: "POST" });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || "HTTP " + res.status);
        resetFundsStatusEl.textContent = "→ " + (data.message || "RESET FUNDS REQUESTED");
      } catch (err) {
        resetFundsStatusEl.textContent = "Error: " + err.message;
      }
    }

    startBotBtn.addEventListener("click", startBot);
    stopBotBtn.addEventListener("click", stopBot);
    document.getElementById("resetFundsBtn").addEventListener("click", resetFundsGui);

    // --- INITIAL LOAD ---
    fetchStatus();
    fetchLogs();

    // --- POLLERS ---
    setInterval(fetchStatus, 8000); // status every 8s
    setInterval(fetchLogs, 5000); // logs every 5s
  </script>
</body>
</html>
