<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Crypto Bot Control Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #111827;
      color: #e5e7eb;
    }
    body.theme-crypto {
      --tab-active-bg: #10b981;
      --tab-active-text: #0f172a;
      --tab-underline: #10b981;
      --sell-all-outline: transparent;
      --sell-all-bg: #b91c1c;
    }
    body.theme-stocks {
      --tab-active-bg: #6366f1;
      --tab-active-text: #f9fafb;
      --tab-underline: #f59e0b;
      --sell-all-outline: #f59e0b;
      --sell-all-bg: #991b1b;
    }
    .container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 20px;
    }
    h1 {
      margin: 0 0 10px;
      font-size: 24px;
      color: #f9fafb;
    }
    .subtitle {
      margin-bottom: 20px;
      color: #9ca3af;
      font-size: 14px;
    }
    .control-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #1f2933;
      border-radius: 8px;
      padding: 12px 16px;
      border: 1px solid #111827;
      margin-bottom: 14px;
      box-shadow: 0 0 0 1px #111827;
    }
    .control-info {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .control-title {
      font-size: 15px;
      font-weight: 600;
      color: #f9fafb;
    }
    .control-note {
      font-size: 12px;
      color: #9ca3af;
    }
    .control-actions {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 6px;
      flex-wrap: wrap;
    }
    .control-actions-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .pill-green {
      background: #064e3b;
      color: #6ee7b7;
    }
    .pill-red {
      background: #7f1d1d;
      color: #fecaca;
    }
    .num-input {
      width: 70px;
      padding: 3px 6px;
      border-radius: 4px;
      border: 1px solid #4b5563;
      background: #111827;
      color: #e5e7eb;
      font-size: 12px;
      margin-right: 4px;
    }

    .market-tabs {
      display: flex;
      gap: 8px;
      margin: 8px 0 16px;
    }

    .market-tab {
      border: 1px solid #1f2937;
      background: #111827;
      color: #cbd5f5;
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 12px;
      cursor: pointer;
      position: relative;
    }

    .market-tab.active {
      background: var(--tab-active-bg);
      border-color: var(--tab-active-bg);
      color: var(--tab-active-text);
    }

    .market-tab.active::after {
      content: "";
      position: absolute;
      left: 12px;
      right: 12px;
      bottom: -6px;
      height: 2px;
      background: var(--tab-underline);
      border-radius: 999px;
    }

    .grid {
      display: grid;
      grid-template-columns: 340px 1fr;
      gap: 20px;
    }

    .summary-bar {
      background: #0f172a;
      border: 1px solid #111827;
      border-radius: 10px;
      padding: 12px 14px;
      margin-bottom: 14px;
      box-shadow: 0 0 0 1px #0b1220;
    }

    .summary-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 12px;
    }

    .summary-title {
      font-weight: 700;
      color: #f9fafb;
      font-size: 15px;
    }

    .summary-note {
      font-size: 12px;
      color: #9ca3af;
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 12px;
    }

    .summary-item {
      background: #111827;
      border: 1px solid #1f2937;
      border-radius: 8px;
      padding: 10px 12px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .summary-label {
      font-size: 12px;
      color: #9ca3af;
      letter-spacing: 0.03em;
      text-transform: uppercase;
    }

    .summary-value {
      font-size: 18px;
      font-weight: 700;
      color: #e5e7eb;
    }

    .summary-sub {
      font-size: 12px;
      color: #cbd5e1;
    }

    .summary-metrics {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
    }

    .summary-mini-label {
      font-size: 11px;
      color: #94a3b8;
      letter-spacing: 0.02em;
      text-transform: uppercase;
    }

    .summary-mini-value {
      font-size: 16px;
      font-weight: 700;
      color: #e5e7eb;
    }

    .summary-mini-sub {
      font-size: 11px;
      color: #cbd5e1;
    }

    .card {
      background: #1f2933;
      border-radius: 8px;
      padding: 16px;
      box-shadow: 0 0 0 1px #111827;
    }
    .card h2 {
      margin: 0 0 12px;
      font-size: 18px;
      color: #f9fafb;
    }

    .row {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 8px;
    }
    .row + .row {
      margin-top: 6px;
    }
    .label {
      min-width: 110px;
      font-size: 14px;
      color: #9ca3af;
    }
    .value {
      font-size: 14px;
      color: #e5e7eb;
      font-weight: 500;
    }

    .badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      margin-left: 8px;
    }
    .badge-green {
      background: #064e3b;
      color: #6ee7b7;
    }
    .badge-red {
      background: #7f1d1d;
      color: #fecaca;
    }
    .badge-amber {
      background: #78350f;
      color: #fde68a;
    }

    .btn {
      border: none;
      border-radius: 6px;
      padding: 6px 12px;
      font-size: 13px;
      cursor: pointer;
      margin-right: 6px;
      margin-top: 4px;
      transition: background 0.15s, transform 0.05s;
    }
    .btn:active {
      transform: translateY(1px);
    }
    .btn-primary {
      background: #2563eb;
      color: #f9fafb;
    }
    .btn-outline {
      background: transparent;
      color: #e5e7eb;
      border: 1px solid #4b5563;
    }
    .btn-danger {
      background: #b91c1c;
      color: #fee2e2;
    }

    .sell-all-btn {
      background: var(--sell-all-bg);
      border: 1px solid var(--sell-all-outline);
    }
    .btn-small {
      font-size: 12px;
      padding: 4px 10px;
    }

    .status-line {
      font-size: 12px;
      color: #9ca3af;
      margin-top: 4px;
    }

    .countdown-focus .label,
    .countdown-focus .value {
      color: #f9fafb;
      font-weight: 600;
    }

    .countdown-note {
      margin-left: 110px;
      font-size: 12px;
      color: #9ca3af;
    }

    .stocks-only {
      display: none;
    }

    .stocks-only.active {
      display: flex;
    }

    .stocks-only.card.active {
      display: block;
    }

    .stocks-only.countdown-note.active {
      display: block;
    }

    .crypto-only {
      display: block;
    }

    body.theme-stocks .crypto-only {
      display: none;
    }

    /* LOG AREA LIKE TERMINAL */
    .log-container {
      background: #000000;
      border-radius: 8px;
      padding: 8px 10px;
      border: 1px solid #4b5563;
      height: 520px;
      overflow-y: auto;
      font-family: "Consolas", "SF Mono", "Menlo", "Monaco", monospace;
      font-size: 12px;
      line-height: 1.3;
      color: #d1d5db;
      white-space: pre; /* שומר על הפורמט בדיוק כמו בטרמינל */
    }

    .log-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }
    .log-title {
      font-size: 13px;
      color: #9ca3af;
    }
    .log-controls {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: flex-end;
    }
    .log-controls .num-input {
      width: 200px;
    }
    .log-download[aria-disabled="true"] {
      opacity: 0.5;
      pointer-events: none;
    }
    .pill {
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: #111827;
      color: #9ca3af;
      border: 1px solid #4b5563;
    }

    .log-buy {
      color: #34d399;
      font-weight: 700;
    }
    .log-sell {
      color: #f87171;
      font-weight: 700;
    }
    .log-tp {
      color: #fbbf24;
      font-weight: 700;
    }
    .log-sl {
      color: #c084fc;
      font-weight: 700;
    }

    .log-container {
      white-space: normal;
    }

    .log-toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      border: 1px solid #1f2937;
      border-radius: 8px;
      background: #0b0f1b;
      margin-bottom: 8px;
    }

    .log-toolbar-left {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 10px;
      flex: 1 1 auto;
    }

    .log-toolbar-right {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 0 0 auto;
    }

    .log-search {
      width: 220px;
      padding: 5px 8px;
      border-radius: 6px;
      border: 1px solid #374151;
      background: #111827;
      color: #e5e7eb;
      font-size: 12px;
    }

    .log-toggle {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: #cbd5f5;
      background: #111827;
      border: 1px solid #1f2937;
      padding: 4px 8px;
      border-radius: 999px;
    }

    .log-toggle input {
      accent-color: #38bdf8;
    }

    .log-auto-status {
      font-size: 12px;
      color: #9ca3af;
      border: 1px solid #1f2937;
      background: #111827;
      padding: 4px 8px;
      border-radius: 999px;
    }

    .log-table-head {
      position: sticky;
      top: 0;
      z-index: 2;
      background: #0b0f1b;
      border-bottom: 1px solid #1f2937;
      padding: 6px 0;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #9ca3af;
    }

    .log-rows {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .log-row {
      display: grid;
      grid-template-columns: 70px 80px 120px 140px 1fr;
      gap: 8px;
      padding: 4px 0;
      align-items: center;
    }

    .log-row.error {
      background: rgba(185, 28, 28, 0.14);
    }

    .log-row.section {
      font-weight: 700;
      border-bottom: 1px solid rgba(59, 130, 246, 0.4);
      padding-bottom: 6px;
      margin-bottom: 4px;
    }

    .log-col {
      min-width: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .log-message {
      white-space: normal;
      overflow: visible;
    }

    .log-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      border: 1px solid transparent;
    }

    .log-badge-buy {
      background: #064e3b;
      color: #6ee7b7;
      border-color: #10b981;
    }

    .log-badge-exit {
      background: #3b0764;
      color: #e9d5ff;
      border-color: #a855f7;
    }

    .log-badge-tp {
      background: #0e7490;
      color: #a5f3fc;
      border-color: #22d3ee;
    }

    .log-badge-sl {
      background: #7c2d12;
      color: #fed7aa;
      border-color: #fb923c;
    }

    .log-badge-error {
      background: #7f1d1d;
      color: #fecaca;
      border-color: #ef4444;
    }

    .log-badge-muted {
      background: #111827;
      color: #9ca3af;
      border-color: #4b5563;
    }

    .log-badge-blue {
      background: #1e3a8a;
      color: #bfdbfe;
      border-color: #60a5fa;
    }

    .log-divider {
      height: 1px;
      background: linear-gradient(90deg, rgba(148, 163, 184, 0.1), rgba(148, 163, 184, 0.5), rgba(148, 163, 184, 0.1));
      margin: 6px 0;
    }

    .log-empty {
      color: #9ca3af;
      font-size: 12px;
      padding: 6px 0;
    }

    .log-auto-banner {
      position: sticky;
      bottom: 8px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid #1f2937;
      padding: 6px 10px;
      border-radius: 8px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      margin-top: 10px;
      width: fit-content;
      color: #e2e8f0;
      font-size: 12px;
    }

    .log-auto-banner.is-hidden {
      display: none;
    }

    @media (max-width: 900px) {
      .log-row {
        grid-template-columns: 60px 60px 90px 100px 1fr;
      }
      .log-search {
        width: 100%;
      }
    }

    .strategy-table-wrapper {
      margin-top: 12px;
      overflow-x: auto;
    }

    .strategy-table {
      width: 100%;
      border-collapse: collapse;
      color: #e5e7eb;
      font-size: 13px;
    }

    .strategy-table th,
    .strategy-table td {
      padding: 8px;
      border-bottom: 1px solid #374151;
      vertical-align: top;
      text-align: left;
    }

    .strategy-table th {
      background: #111827;
      color: #9ca3af;
      font-weight: 700;
      font-size: 12px;
      letter-spacing: 0.03em;
      text-transform: uppercase;
    }

    .strategy-table td strong {
      color: #f9fafb;
    }

    .tab-header {
      display: flex;
      gap: 8px;
      margin-bottom: 14px;
      border-bottom: 1px solid #1f2937;
      padding-bottom: 8px;
    }

    .tab-button {
      border: 1px solid #1f2937;
      background: #111827;
      color: #cbd5f5;
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 12px;
      cursor: pointer;
    }

    .tab-button.active {
      background: #2563eb;
      border-color: #2563eb;
      color: #f9fafb;
    }

    .tab-panel {
      display: none;
    }

    .tab-panel.active {
      display: block;
    }

    .preset-inputs {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 8px;
    }

    .preset-input {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 11px;
      color: #9ca3af;
    }

    .preset-input input {
      width: 100%;
    }

    .pairing-select {
      width: 200px;
      padding: 4px 6px;
      border-radius: 6px;
      border: 1px solid #374151;
      background: #111827;
      color: #e5e7eb;
      font-size: 12px;
    }

    .entry-variables {
      font-size: 13px;
      color: #cbd5e1;
      background: #111827;
      border: 1px solid #1f2937;
      border-radius: 6px;
      padding: 8px 10px;
    }

    .settings-panel {
      display: none;
      margin-bottom: 16px;
      background: #0f172a;
      border: 1px solid #1f2937;
    }

    .settings-panel.open {
      display: block;
    }

    .settings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 12px;
    }

    .text-input {
      width: 100%;
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #374151;
      background: #111827;
      color: #e5e7eb;
      font-size: 12px;
    }

    .theme-crypto .settings-stocks {
      opacity: 0.6;
    }

    .theme-stocks .settings-crypto {
      opacity: 0.6;
    }

    .theme-stocks #stocksCountdown {
      color: #f59e0b;
      font-weight: 600;
    }

    .strategy-market-label {
      font-size: 12px;
      color: #9ca3af;
      margin-bottom: 10px;
      letter-spacing: 0.02em;
    }


    .mode-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 3px 10px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      border: 1px solid transparent;
    }

    .mode-pill.auto {
      background: #064e3b;
      color: #a7f3d0;
      border-color: #10b981;
    }

    .mode-pill.manual {
      background: #1e293b;
      color: #bfdbfe;
      border-color: #2563eb;
    }

    .mode-switch {
      display: inline-flex;
      gap: 6px;
    }

    .mode-switch .btn.active {
      background: #0f172a;
      border-color: #38bdf8;
      color: #e2e8f0;
    }

    .mode-inline {
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .auto-only {
      display: none;
    }

    .manual-only {
      display: block;
    }

    body.mode-auto .auto-only {
      display: block;
    }

    body.mode-auto .manual-only {
      display: none;
    }

    body.mode-manual .auto-only {
      display: none;
    }

    body.mode-manual .manual-only {
      display: block;
    }

    .regime-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
    }

    .regime-metrics {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
    }

    .regime-metric {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 12px;
      color: #cbd5e1;
    }

    .regime-metric strong {
      color: #f9fafb;
      font-size: 13px;
    }

    .no-trade-banner {
      margin-top: 12px;
      padding: 10px 12px;
      background: rgba(127, 29, 29, 0.25);
      border: 1px solid #7f1d1d;
      border-radius: 8px;
      color: #fecaca;
      font-size: 12px;
    }

    .no-trade-banner strong {
      color: #fef2f2;
    }

    .auto-strategy-block {
      background: #111827;
      border: 1px solid #1f2937;
      border-radius: 8px;
      padding: 10px 12px;
      margin: 10px 0 6px;
    }

    .auto-note {
      font-size: 12px;
      color: #9ca3af;
      margin-top: 6px;
    }

    .auto-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

  </style>
</head>
<body class="theme-crypto">
  <div class="container">
    <h1>Crypto Bot Control Panel</h1>
    <div class="subtitle">
      Live control over strategy, interval, sell all and reset funds.
      Logs are shown exactly as in the terminal.
    </div>

    <div class="market-tabs" id="marketTabs">
      <button class="market-tab active" data-market="crypto">Crypto</button>
      <button class="market-tab" data-market="stocks">Stocks</button>
    </div>

    <div class="control-bar">
      <div class="control-info">
        <div class="control-title">Bot run control</div>
        <div class="control-note">Pause safely saves state & performance so you can resume later.</div>
      </div>
      <div class="control-actions">
        <div class="control-actions-row">
          <span id="botRunBadge" class="pill pill-green">Running</span>
          <button id="startBotBtn" class="btn btn-primary btn-small">START BOT</button>
          <button id="stopBotBtn" class="btn btn-danger btn-small">STOP BOT</button>
        </div>
        <div class="control-actions-row">
          <span id="modeIndicator" class="mode-pill manual">MODE: --</span>
          <div id="modeSwitch" class="mode-switch">
            <button class="btn btn-outline btn-small" data-mode="AUTO">AUTO</button>
            <button class="btn btn-outline btn-small" data-mode="MANUAL">MANUAL</button>
          </div>
        </div>
        <button id="settingsToggleBtn" class="btn btn-outline btn-small">SETTINGS</button>
      </div>
    </div>
    <div class="status-line" id="botControlStatus"></div>

    <div id="settingsPanel" class="card settings-panel">
      <h2>Connection Settings</h2>
      <div class="settings-grid">
        <label class="preset-input settings-crypto">Binance API Key
          <input id="binanceApiKeyInput" class="text-input" type="text" placeholder="Enter Binance API key" />
        </label>
        <label class="preset-input settings-crypto">Binance Secret Key
          <input id="binanceApiSecretInput" class="text-input" type="password" placeholder="Enter Binance secret key" />
        </label>
        <label class="preset-input settings-crypto">Binance Base URL
          <input id="binanceBaseUrlInput" class="text-input" type="text" placeholder="https://testnet.binance.vision" />
        </label>
        <label class="preset-input settings-crypto">TradingView Webhook URL
          <input id="tradingViewWebhookInput" class="text-input" type="text" placeholder="https://your-webhook-url" />
        </label>
        <label class="preset-input">Market Type
          <select id="marketTypeInput" class="text-input">
            <option value="crypto">Crypto (Binance)</option>
            <option value="stocks">Stocks (Alpaca Trades)</option>
          </select>
        </label>
        <label class="preset-input settings-stocks">Alpaca API Key
          <input id="alpacaApiKeyInput" class="text-input" type="text" placeholder="Enter Alpaca API key" />
        </label>
        <label class="preset-input settings-stocks">Alpaca Secret Key
          <input id="alpacaApiSecretInput" class="text-input" type="password" placeholder="Enter Alpaca secret key" />
        </label>
        <label class="preset-input settings-stocks">Alpaca Trading Base URL
          <input id="alpacaTradingBaseUrlInput" class="text-input" type="text" placeholder="https://paper-api.alpaca.markets" />
        </label>
        <label class="preset-input settings-stocks">Alpaca Data Base URL
          <input id="alpacaDataBaseUrlInput" class="text-input" type="text" placeholder="https://data.alpaca.markets" />
        </label>
        <label class="preset-input settings-stocks">Alpaca Data Feed
          <input id="alpacaDataFeedInput" class="text-input" type="text" placeholder="iex" />
        </label>
      </div>
      <div class="row" style="margin-top: 10px;">
        <button id="saveSettingsBtn" class="btn btn-primary btn-small">Save Settings</button>
        <button id="testAlpacaBtn" class="btn btn-outline btn-small settings-stocks">Test Alpaca Connection</button>
      </div>
      <div class="status-line" id="settingsStatus"></div>
    </div>

    <div class="summary-bar">
      <div class="summary-header">
        <div>
          <div class="summary-title">Performance snapshots</div>
          <div class="summary-note">PNL, trades, wins/losses, and win rate for each window.</div>
        </div>
        <div class="summary-note">Auto-refreshes with the bot status poll.</div>
      </div>
      <div class="summary-grid">
        <div class="summary-item">
          <div class="summary-label">Last 24 hours</div>
          <div class="summary-value" id="summaryPnlValue-24h">–</div>
          <div class="summary-sub" id="summaryPnlPct-24h">–</div>
          <div class="summary-metrics">
            <div>
              <div class="summary-mini-label">Trades</div>
              <div class="summary-mini-value" id="summaryTrades-24h">–</div>
              <div class="summary-mini-sub" id="summaryWinLoss-24h">–</div>
            </div>
            <div>
              <div class="summary-mini-label">Win rate</div>
              <div class="summary-mini-value" id="summaryWinRate-24h">–</div>
              <div class="summary-mini-sub" id="summaryAvgPnl-24h">–</div>
            </div>
          </div>
        </div>
        <div class="summary-item">
          <div class="summary-label">Last 3 days</div>
          <div class="summary-value" id="summaryPnlValue-3d">–</div>
          <div class="summary-sub" id="summaryPnlPct-3d">–</div>
          <div class="summary-metrics">
            <div>
              <div class="summary-mini-label">Trades</div>
              <div class="summary-mini-value" id="summaryTrades-3d">–</div>
              <div class="summary-mini-sub" id="summaryWinLoss-3d">–</div>
            </div>
            <div>
              <div class="summary-mini-label">Win rate</div>
              <div class="summary-mini-value" id="summaryWinRate-3d">–</div>
              <div class="summary-mini-sub" id="summaryAvgPnl-3d">–</div>
            </div>
          </div>
        </div>
        <div class="summary-item">
          <div class="summary-label">Last 1 week</div>
          <div class="summary-value" id="summaryPnlValue-7d">–</div>
          <div class="summary-sub" id="summaryPnlPct-7d">–</div>
          <div class="summary-metrics">
            <div>
              <div class="summary-mini-label">Trades</div>
              <div class="summary-mini-value" id="summaryTrades-7d">–</div>
              <div class="summary-mini-sub" id="summaryWinLoss-7d">–</div>
            </div>
            <div>
              <div class="summary-mini-label">Win rate</div>
              <div class="summary-mini-value" id="summaryWinRate-7d">–</div>
              <div class="summary-mini-sub" id="summaryAvgPnl-7d">–</div>
            </div>
          </div>
        </div>
      </div>
    </div>


    <div class="card crypto-only" id="regimeCard">
      <h2>Market Scan & Regime</h2>
      <div class="regime-grid">
        <div class="summary-item">
          <div class="summary-label">Scan Source</div>
          <div class="summary-value" id="regimeProxySymbol">-</div>
          <div class="summary-sub">Timeframe: <span id="regimeTimeframe">-</span></div>
          <div class="summary-sub">Last scan: <span id="regimeLastScan">-</span></div>
        </div>
        <div class="summary-item">
          <div class="summary-label">Market Regime</div>
          <div class="summary-value" id="regimeCurrent">-</div>
          <div class="summary-sub">Detected: <span id="regimeDetected">-</span></div>
          <div class="summary-sub">Confidence: <span id="regimeConfidence">-</span></div>
          <div class="summary-sub">Status: <span id="regimeStatus">-</span></div>
          <div class="summary-sub" id="regimeReason"></div>
        </div>
        <div class="summary-item">
          <div class="summary-label">Supporting Metrics</div>
          <div class="regime-metrics">
            <div class="regime-metric">
              <span>MA slope</span>
              <strong id="regimeSlope">-</strong>
            </div>
            <div class="regime-metric">
              <span>RSI</span>
              <strong id="regimeRsi">-</strong>
            </div>
            <div class="regime-metric">
              <span>ATR ratio</span>
              <strong id="regimeAtrRatio">-</strong>
            </div>
            <div class="regime-metric">
              <span>Volume ratio</span>
              <strong id="regimeVolumeRatio">-</strong>
            </div>
          </div>
        </div>
      </div>
      <div class="no-trade-banner" id="noTradeBanner" style="display: none;">
        <strong>NO TRADE.</strong> <span id="noTradeReason">-</span>
        <div>No new entries will be taken. Existing positions are still managed.</div>
      </div>
    </div>


    <div class="grid">
      <!-- LEFT: STATUS + CONTROLS -->
      <div class="card">
        <h2>Status & Controls</h2>

        <!-- STATUS -->
        <div class="row">
          <span class="label">Strategy:</span>
          <span class="value">
            <span id="statusStrategy">–</span>
          </span>
        </div>
        <div class="row">
          <span class="label">Interval:</span>
          <span class="value"><span id="statusInterval">–</span></span>
        </div>
        <div class="row">
          <span class="label">Last Equity:</span>
          <span class="value">
            <span id="statusEquity">–</span>
          </span>
        </div>
        <div class="row">
          <span class="label">Last PNL:</span>
          <span class="value">
            <span id="statusPnl">–</span>
          </span>
        </div>
        <div class="row">
          <span class="label">Symbols:</span>
          <span class="value">
            <span id="statusSymbols">—</span>
          </span>
        </div>
        <div class="row stocks-only" id="stocksAlpacaRow">
          <span class="label">Alpaca:</span>
          <span class="value"><span id="statusAlpaca">?</span></span>
        </div>
        <div class="row stocks-only" id="stocksMarketOpenRow">
          <span class="label">Market Open:</span>
          <span class="value"><span id="stocksMarketOpen">—</span></span>
        </div>
        <div class="row stocks-only" id="stocksNextOpenRow">
          <span class="label">Next Open:</span>
          <span class="value"><span id="stocksNextOpen">—</span></span>
        </div>
        <div class="row stocks-only" id="stocksCountdownRow">
          <span class="label">Countdown:</span>
          <span class="value"><span id="stocksCountdown">—</span></span>
        </div>
        <div class="status-line stocks-only countdown-note" id="stocksCountdownNote"></div>
        <div class="status-line" id="statusUpdated">Last update: –</div>

        <hr style="border: none; border-top: 1px solid #374151; margin: 10px 0;" />
            <!-- LEFT: EXIT SETTINGS CARD -->
      <div class="card" style="margin-top: 12px;">
        <h2>Exit Settings</h2>

        <!-- ערכים בפועל -->
        <div class="row">
          <span class="label">Current SL:</span>
          <span class="value"><span id="exitSlValue">–</span></span>
        </div>
        <div class="row">
          <span class="label">Current TP:</span>
          <span class="value"><span id="exitTpValue">–</span></span>
        </div>
        <div class="row">
          <span class="label">Trail Start:</span>
          <span class="value"><span id="exitTrailStartValue">–</span></span>
        </div>
        <div class="row">
          <span class="label">Trail Distance:</span>
          <span class="value"><span id="exitTrailDistanceValue">–</span></span>
        </div>
        <div class="row">
          <span class="label">Candle Exit:</span>
          <span class="value"><span id="exitCandleRedValue">–</span></span>
        </div>

        <hr style="border: none; border-top: 1px solid #374151; margin: 10px 0;" />

        <div class="auto-only auto-strategy-block">
          <div class="row">
            <span class="label">Active Exit:</span>
            <span class="value"><span id="exitAutoPreset">-</span></span>
          </div>
          <div class="row">
            <span class="label">Source:</span>
            <span class="value"><span id="exitAutoSource">-</span></span>
          </div>
          <div class="auto-note">Switch to MANUAL mode to override exits.</div>
        </div>

        <div class="row manual-only">
          <span class="label">Preset sets:</span>
          <div>
            <select id="exitPresetSelect" class="num-input" style="width: 240px;">
              <option value="" selected disabled>Select exit preset...</option>
            </select>
            <button id="applyExitPresetBtn" class="btn btn-outline btn-small" style="margin-left: 4px;">
              Apply preset
            </button>
          </div>
        </div>

        <!-- עריכה דינמית -->
        <div class="row manual-only">
          <span class="label">Edit (%):</span>
          <div>
            <input id="exitSlInput" class="num-input" type="number" step="0.1" min="0.1" max="50" placeholder="SL" />
            <input id="exitTpInput" class="num-input" type="number" step="0.1" min="0.1" max="100" placeholder="TP" />
          </div>
        </div>
        <div class="row manual-only">
          <span class="label"></span>
          <div>
            <input id="exitTrailStartInput" class="num-input" type="number" step="0.1" min="0.1" max="100" placeholder="Trail Start" />
            <input id="exitTrailDistanceInput" class="num-input" type="number" step="0.1" min="0.1" max="100" placeholder="Trail Dist." />
          </div>
        </div>
        <div class="row manual-only">
          <span class="label">Candle (%):</span>
          <div>
            <label style="display: flex; align-items: center; gap: 8px;">
              <input id="exitCandleEnabledInput" type="checkbox" />
              <span>Use candle confirmation</span>
            </label>
            <input
              id="exitCandleRedInput"
              class="num-input"
              type="number"
              step="1"
              min="0"
              max="100"
              placeholder="Red %"
              disabled
            />
          </div>
        </div>

        <div class="row manual-only" style="margin-top: 8px;">
          <span class="label"></span>
          <div>
            <button class="btn btn-primary btn-small" onclick="updateExitConfig()">
              UPDATE EXIT
            </button>
          </div>
        </div>

        <div class="status-line manual-only" id="exitStatus"></div>
      </div>

        <!-- ENTRY STRATEGY SELECTION -->
        <div class="auto-only auto-strategy-block crypto-only" id="autoStrategyBlock">
          <div class="row">
            <span class="label">Regime:</span>
            <span class="value"><span id="autoStrategyRegime">-</span></span>
          </div>
          <div class="row">
            <span class="label">Entry:</span>
            <span class="value"><span id="autoEntryStrategy">-</span></span>
          </div>
          <div class="row">
            <span class="label">Exit:</span>
            <span class="value"><span id="autoExitStrategy">-</span></span>
          </div>
          <div class="row">
            <span class="label">Status:</span>
            <span class="value"><span id="autoStrategyStatus">-</span></span>
          </div>
          <div class="status-line" id="autoStrategyReason"></div>
        </div>
        <div class="row crypto-only manual-only">
          <span class="label">Entry Strategy:</span>
          <div>
            <select id="entryStrategySelect" class="num-input" style="width: 260px;">
              <option value="" disabled selected>Select entry strategy...</option>
            </select>
          </div>
        </div>
        <div class="status-line crypto-only manual-only" id="entryPresetInfo">This preset changes: MA, Pullback, RSI, ATR, Volume.</div>
        <div class="status-line crypto-only manual-only" id="strategyStatus">Select an entry strategy to send it live.</div>

        <!-- INTERVAL -->
        <div class="row" style="margin-top: 8px;">
          <span class="label">Loop interval:</span>
          <div>
            <button class="btn btn-outline btn-small" onclick="setIntervalMs(60000)">Every 60s</button>
            <button class="btn btn-outline btn-small" onclick="setIntervalMs(300000)">Every 5 min</button>
            <button class="btn btn-outline btn-small" onclick="setIntervalMs(900000)">Every 15 min</button>
          </div>
        </div>
        <div class="status-line" id="intervalStatus"></div>

        <!-- SELL & RESET -->
        <div class="row" style="margin-top: 10px;">
          <span class="label">Actions:</span>
          <div>
            <button id="sellAllBtn" class="btn btn-danger btn-small sell-all-btn" onclick="sellAll()">SELL ALL (Crypto)</button>
          </div>
        </div>
      </div>

      <!-- RIGHT: LOG VIEWER -->
      <div class="card">
        <div class="log-header">
          <div class="log-title">Live Logs</div>
          <div class="log-controls">
            <label for="logFileSelect" style="font-size: 12px; color: #9ca3af;">Log file:</label>
            <select id="logFileSelect" class="num-input">
              <option value="">Latest (live)</option>
            </select>
            <button id="logLoadBtn" class="btn btn-outline btn-small">View</button>
            <button id="logRefreshBtn" class="btn btn-outline btn-small">Refresh list</button>
            <a id="logDownloadLink" class="btn btn-primary btn-small log-download" aria-disabled="true" download>Download</a>
            <span class="pill" id="logStatusPill">Polling every 5s</span>
          </div>
        </div>
        <div class="log-toolbar">
          <div class="log-toolbar-left">
            <input id="logSearchInput" class="log-search" type="search" placeholder="Search symbol or message..." />
            <label class="log-toggle">
              <input id="logToggleHideEntryCheck" type="checkbox" checked />
              Hide Entry 2 Check
            </label>
            <label class="log-toggle">
              <input id="logToggleSignalsOnly" type="checkbox" />
              Signals only
            </label>
            <label class="log-toggle">
              <input id="logToggleHidePortfolio" type="checkbox" />
              Hide Portfolio blocks
            </label>
            <label class="log-toggle">
              <input id="logToggleHidePerfTrades" type="checkbox" />
              Hide Performance/Trades lines
            </label>
          </div>
          <div class="log-toolbar-right">
            <span class="log-auto-status" id="logAutoStatus">Auto-scroll: ON</span>
            <button id="logResumeBtn" class="btn btn-outline btn-small">Resume auto-scroll</button>
          </div>
        </div>
        <div id="logContainer" class="log-container">
          <div class="log-row log-table-head">
            <div class="log-col">Time</div>
            <div class="log-col">Scope</div>
            <div class="log-col">Badge</div>
            <div class="log-col">Symbol</div>
            <div class="log-col">Message</div>
          </div>
          <div id="logRows" class="log-rows">
            <div class="log-empty">Loading logs...</div>
          </div>
          <div id="logAutoPaused" class="log-auto-banner is-hidden">
            <span>Auto-scroll paused (scroll)</span>
            <button id="logResumeStickyBtn" class="btn btn-outline btn-small">Resume</button>
          </div>
        </div>
    </div>
  </div>

    <div class="card crypto-only" style="margin-top: 16px;">
      <div class="tab-header" role="tablist">
        <button class="tab-button active" data-tab="entry">Entry Strategy Presets</button>
        <button class="tab-button" data-tab="exit">Exit Strategy Presets</button>
      </div>

      <div id="entryStrategyTab" class="tab-panel active">
        <h2>Entry Strategy Presets</h2>
        <div class="strategy-market-label" id="entryStrategyMarketLabel">Entry Strategy Presets - Crypto</div>
        <div class="auto-only auto-strategy-block" id="autoEntryTabSummary">
          <div class="row">
            <span class="label">Detected Regime:</span>
            <span class="value"><span id="entryTabRegime">-</span></span>
          </div>
          <div class="row">
            <span class="label">Selected Entry:</span>
            <span class="value"><span id="entryTabStrategy">-</span></span>
          </div>
          <div class="row">
            <span class="label">Explanation:</span>
            <span class="value"><span id="entryTabExplanation">-</span></span>
          </div>
        </div>
        <p class="subtitle" style="margin-bottom: 12px;">
          These presets adjust MA, Pullback, RSI, ATR, and Volume filters. Selecting one updates the bot
          immediately for the next trading loop.
        </p>
        <div class="entry-variables">
          <strong>This preset changes:</strong> MA, Pullback, RSI, ATR, Volume.
        </div>
        <div class="strategy-table-wrapper">
          <table class="strategy-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Purpose & Behavior</th>
                <th>Run Logic</th>
                <th>Suggested Exit Preset</th>
                <th>Parameters</th>
              </tr>
            </thead>
            <tbody id="strategyTableBody"></tbody>
          </table>
        </div>
      <details class="legacy-block">
        <summary>Legacy (Advanced)</summary>
        <p class="subtitle" style="margin-bottom: 12px;">Legacy entry IDs are accepted but mapped to the closest of Entry 1-5.</p>
        <div class="strategy-table-wrapper">
          <table class="strategy-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Purpose</th>
                <th>Notes</th>
              </tr>
            </thead>
            <tbody id="legacyStrategyTableBody"></tbody>
          </table>
        </div>
      </details>

      </div>

      <div id="exitStrategyTab" class="tab-panel">
        <h2>Exit Strategy Presets</h2>
        <p class="subtitle" style="margin-bottom: 12px;">
          Tune each exit preset, save your preferred values, and quickly load them into the live Exit Settings.
        </p>
        <div class="strategy-table-wrapper">
          <table class="strategy-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Purpose</th>
                <th>Preset Values (%)</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="exitStrategyTableBody"></tbody>
          </table>
        <details class="legacy-block">
        <summary>Legacy (Advanced)</summary>
        <p class="subtitle" style="margin-bottom: 12px;">Legacy exit IDs are accepted but mapped to Exit 1-5.</p>
        <div class="strategy-table-wrapper">
          <table class="strategy-table">
            <thead>
              <tr>
                <th>Legacy ID</th>
                <th>Name</th>
                <th>Mapped Exit</th>
              </tr>
            </thead>
            <tbody id="legacyExitPresetBody"></tbody>
          </table>
        </div>
      </details>

      </div>
      </div>
    </div>
  </div>

  <div class="card stocks-only" id="stocksPortfolioCard" style="margin-top: 16px;">
    <h2>Stocks Portfolio Overview</h2>
    <div class="strategy-market-label">Stocks-only portfolio presets (IEX)</div>
    <div class="summary-grid" id="stocksPortfolioSummary">
      <div class="summary-item">
        <div class="summary-label">Global Risk</div>
        <div class="summary-sub" id="stocksGlobalRisk">-</div>
      </div>
      <div class="summary-item">
        <div class="summary-label">Timeframes</div>
        <div class="summary-sub" id="stocksTimeframes">-</div>
      </div>
      <div class="summary-item">
        <div class="summary-label">Universe Filters</div>
        <div class="summary-sub" id="stocksUniverseFilters">-</div>
      </div>
      <div class="summary-item">
        <div class="summary-label">Regime Rules</div>
        <div class="summary-sub" id="stocksRegimeRules">-</div>
      </div>
    </div>

    <div class="strategy-table-wrapper" style="margin-top: 12px;">
      <table class="strategy-table">
        <thead>
          <tr>
            <th>Layer</th>
            <th>Allocation</th>
            <th>Max Open</th>
            <th>Risk/Trade</th>
            <th>Loss Stops</th>
            <th>Timeframe</th>
            <th>Entry Preset</th>
            <th>Exit Preset</th>
          </tr>
        </thead>
        <tbody id="stocksLayersTableBody"></tbody>
      </table>
    </div>

    <div class="strategy-table-wrapper" style="margin-top: 12px;">
      <table class="strategy-table">
        <thead>
          <tr>
            <th>Entry Preset</th>
            <th>Logic</th>
            <th>Parameters</th>
          </tr>
        </thead>
        <tbody id="stocksEntryPresetsBody"></tbody>
      </table>
    </div>

    <div class="strategy-table-wrapper" style="margin-top: 12px;">
      <table class="strategy-table">
        <thead>
          <tr>
            <th>Exit Preset</th>
            <th>Stops/Targets</th>
            <th>Trail/Rules</th>
          </tr>
        </thead>
        <tbody id="stocksExitPresetsBody"></tbody>
      </table>
    </div>
  </div>


  <script>
    const statusEls = {
      strategy: document.getElementById("statusStrategy"),
      interval: document.getElementById("statusInterval"),
      equity: document.getElementById("statusEquity"),
      pnl: document.getElementById("statusPnl"),
      symbols: document.getElementById("statusSymbols"),
      alpaca: document.getElementById("statusAlpaca"),
      stocksMarketOpen: document.getElementById("stocksMarketOpen"),
      stocksNextOpen: document.getElementById("stocksNextOpen"),
      stocksCountdown: document.getElementById("stocksCountdown"),
      stocksCountdownNote: document.getElementById("stocksCountdownNote"),
      updated: document.getElementById("statusUpdated"),
    };

    const modeIndicatorEl = document.getElementById("modeIndicator");
    const modeSwitchEl = document.getElementById("modeSwitch");
    const modeSwitchButtons = modeSwitchEl
      ? Array.from(modeSwitchEl.querySelectorAll("button[data-mode]"))
      : [];

    const regimeEls = {
      proxySymbol: document.getElementById("regimeProxySymbol"),
      timeframe: document.getElementById("regimeTimeframe"),
      lastScan: document.getElementById("regimeLastScan"),
      current: document.getElementById("regimeCurrent"),
      detected: document.getElementById("regimeDetected"),
      confidence: document.getElementById("regimeConfidence"),
      status: document.getElementById("regimeStatus"),
      reason: document.getElementById("regimeReason"),
      slope: document.getElementById("regimeSlope"),
      rsi: document.getElementById("regimeRsi"),
      atrRatio: document.getElementById("regimeAtrRatio"),
      volumeRatio: document.getElementById("regimeVolumeRatio"),
      noTradeBanner: document.getElementById("noTradeBanner"),
      noTradeReason: document.getElementById("noTradeReason"),
    };

    const autoStrategyEls = {
      block: document.getElementById("autoStrategyBlock"),
      regime: document.getElementById("autoStrategyRegime"),
      entry: document.getElementById("autoEntryStrategy"),
      exit: document.getElementById("autoExitStrategy"),
      status: document.getElementById("autoStrategyStatus"),
      reason: document.getElementById("autoStrategyReason"),
    };

    const exitAutoEls = {
      preset: document.getElementById("exitAutoPreset"),
      source: document.getElementById("exitAutoSource"),
    };

    const entryTabAutoEls = {
      regime: document.getElementById("entryTabRegime"),
      strategy: document.getElementById("entryTabStrategy"),
      explanation: document.getElementById("entryTabExplanation"),
    };

    let cachedSettings = null;
    let currentMode = "MANUAL";
    const modeByMarket = {
      crypto: localStorage.getItem("modeCrypto") || "MANUAL",
      stocks: localStorage.getItem("modeStocks") || "MANUAL",
    };

    const marketTabsEl = document.getElementById("marketTabs");
    const marketTabButtons = marketTabsEl
      ? Array.from(marketTabsEl.querySelectorAll(".market-tab"))
      : [];
    const stocksOnlyEls = document.querySelectorAll(".stocks-only");
    let currentMarket = localStorage.getItem("activeMarket") || "crypto";
    let statusTimer = null;
    let logTimer = null;
    let logListTimer = null;

    const strategyStatusEl = document.getElementById("strategyStatus");
    const intervalStatusEl = document.getElementById("intervalStatus");
    const logContainerEl = document.getElementById("logContainer");
    const logRowsEl = document.getElementById("logRows");
    const logStatusPillEl = document.getElementById("logStatusPill");
    const logFileSelectEl = document.getElementById("logFileSelect");
    const logRefreshBtn = document.getElementById("logRefreshBtn");
    const logLoadBtn = document.getElementById("logLoadBtn");
    const logDownloadLinkEl = document.getElementById("logDownloadLink");
    const logSearchInputEl = document.getElementById("logSearchInput");
    const logToggleHideEntryCheckEl = document.getElementById("logToggleHideEntryCheck");
    const logToggleSignalsOnlyEl = document.getElementById("logToggleSignalsOnly");
    const logToggleHidePortfolioEl = document.getElementById("logToggleHidePortfolio");
    const logToggleHidePerfTradesEl = document.getElementById("logToggleHidePerfTrades");
    const logAutoStatusEl = document.getElementById("logAutoStatus");
    const logResumeBtnEl = document.getElementById("logResumeBtn");
    const logResumeStickyBtnEl = document.getElementById("logResumeStickyBtn");
    const logAutoPausedEl = document.getElementById("logAutoPaused");
    const sellAllBtnEl = document.getElementById("sellAllBtn");
    const entryStrategyMarketLabelEl = document.getElementById("entryStrategyMarketLabel");
    const stocksCountdownRowEl = document.getElementById("stocksCountdownRow");
    const botControlStatusEl = document.getElementById("botControlStatus");
    const botRunBadgeEl = document.getElementById("botRunBadge");
    const startBotBtn = document.getElementById("startBotBtn");
    const stopBotBtn = document.getElementById("stopBotBtn");
    const settingsToggleBtn = document.getElementById("settingsToggleBtn");
    const settingsPanelEl = document.getElementById("settingsPanel");
    const saveSettingsBtn = document.getElementById("saveSettingsBtn");
    const testAlpacaBtn = document.getElementById("testAlpacaBtn");
    const settingsStatusEl = document.getElementById("settingsStatus");

    const stocksPortfolioEls = {
      card: document.getElementById("stocksPortfolioCard"),
      globalRisk: document.getElementById("stocksGlobalRisk"),
      timeframes: document.getElementById("stocksTimeframes"),
      universe: document.getElementById("stocksUniverseFilters"),
      regime: document.getElementById("stocksRegimeRules"),
      layersBody: document.getElementById("stocksLayersTableBody"),
      entryBody: document.getElementById("stocksEntryPresetsBody"),
      exitBody: document.getElementById("stocksExitPresetsBody"),
    };

    let portfolioSnapshot = null;

    const settingsInputs = {
      binanceApiKey: document.getElementById("binanceApiKeyInput"),
      binanceApiSecret: document.getElementById("binanceApiSecretInput"),
      binanceBaseUrl: document.getElementById("binanceBaseUrlInput"),
      tradingViewWebhookUrl: document.getElementById("tradingViewWebhookInput"),
      marketType: document.getElementById("marketTypeInput"),
      alpacaApiKey: document.getElementById("alpacaApiKeyInput"),
      alpacaApiSecret: document.getElementById("alpacaApiSecretInput"),
      alpacaTradingBaseUrl: document.getElementById("alpacaTradingBaseUrlInput"),
      alpacaDataBaseUrl: document.getElementById("alpacaDataBaseUrlInput"),
      alpacaDataFeed: document.getElementById("alpacaDataFeedInput"),
    };

    let selectedLogFile = "";
    let logLinesCache = [];
    let logAutoScrollEnabled = true;

    const summaryConfig = {
      last24h: { suffix: "24h", label: "24h" },
      last3d: { suffix: "3d", label: "3 days" },
      last7d: { suffix: "7d", label: "1 week" },
    };

    const summaryEls = Object.fromEntries(
      Object.entries(summaryConfig).map(([key, cfg]) => [
        key,
        {
          pnlValue: document.getElementById(`summaryPnlValue-${cfg.suffix}`),
          pnlPct: document.getElementById(`summaryPnlPct-${cfg.suffix}`),
          trades: document.getElementById(`summaryTrades-${cfg.suffix}`),
          winLoss: document.getElementById(`summaryWinLoss-${cfg.suffix}`),
          winRate: document.getElementById(`summaryWinRate-${cfg.suffix}`),
          avgPnl: document.getElementById(`summaryAvgPnl-${cfg.suffix}`),
        },
      ])
    );

    const exitElems = {
      slValue: document.getElementById("exitSlValue"),
      tpValue: document.getElementById("exitTpValue"),
      trailStartValue: document.getElementById("exitTrailStartValue"),
      trailDistanceValue: document.getElementById("exitTrailDistanceValue"),
      candleRedValue: document.getElementById("exitCandleRedValue"),

      slInput: document.getElementById("exitSlInput"),
      tpInput: document.getElementById("exitTpInput"),
      trailStartInput: document.getElementById("exitTrailStartInput"),
      trailDistanceInput: document.getElementById("exitTrailDistanceInput"),
      candleRedInput: document.getElementById("exitCandleRedInput"),
      candleEnabledInput: document.getElementById("exitCandleEnabledInput"),
    };

    const exitStatusEl = document.getElementById("exitStatus");
    const exitPresetSelectEl = document.getElementById("exitPresetSelect");
    const applyExitPresetBtn = document.getElementById("applyExitPresetBtn");
    const entryStrategySelectEl = document.getElementById("entryStrategySelect");
    const strategyTableBodyEl = document.getElementById("strategyTableBody");
    const exitStrategyTableBodyEl = document.getElementById("exitStrategyTableBody");
    const legacyStrategyTableBodyEl = document.getElementById("legacyStrategyTableBody");
    const legacyExitPresetBodyEl = document.getElementById("legacyExitPresetBody");
    const tabButtons = Array.from(document.querySelectorAll(".tab-button"));
    const tabPanels = Array.from(document.querySelectorAll(".tab-panel"));

    const ENTRY_EXIT_PAIR_KEY = "entryExitPairs";
    const EXIT_PRESET_STORAGE_KEY = "exitPresetOverrides";
    const entryStrategies = [
      {
        id: 101,
        displayId: 1,
        name: "Trend Conservative",
        purpose: "Steady trends, avoid noise",
        behavior: "Fewer but higher-quality trend entries",
        logicGroup: "Trend/Pullback (Strategy 2)",
        defaultExitPresetId: 1,
        group: "official",
        parameters: [
          { label: "Fast MA", value: "20" },
          { label: "Slow MA", value: "200" },
          { label: "Pullback", value: "1.0%-2.0%" },
          { label: "RSI", value: "50-60" },
          { label: "ATR Filter", value: "ON (ATR > ATR_MA x 0.7)" },
          { label: "Volume Surge", value: "Optional" },
        ],
      },
      {
        id: 102,
        displayId: 2,
        name: "Trend Aggressive",
        purpose: "Strong trends and momentum",
        behavior: "Faster trend entries on momentum",
        logicGroup: "Trend/Pullback (Strategy 2)",
        defaultExitPresetId: 4,
        group: "official",
        parameters: [
          { label: "Fast MA", value: "10" },
          { label: "Slow MA", value: "50" },
          { label: "Pullback", value: "2.5%-4.0%" },
          { label: "RSI", value: "55-70" },
          { label: "ATR Filter", value: "OFF" },
          { label: "Volume Surge", value: "ON (>= 20% above 10-candle avg)" },
        ],
      },
      {
        id: 104,
        displayId: 3,
        name: "Swing Deep Pullback",
        purpose: "Buy deeper dips inside an uptrend",
        behavior: "Waits for larger pullbacks for discount entries",
        logicGroup: "Trend/Pullback (Strategy 2)",
        defaultExitPresetId: 6,
        group: "official",
        parameters: [
          { label: "Fast MA", value: "50" },
          { label: "Slow MA", value: "200" },
          { label: "Pullback", value: "3%-6%" },
          { label: "RSI", value: "28-40" },
          { label: "ATR Filter", value: "ON" },
          { label: "Volume Surge", value: "OFF" },
        ],
      },
      {
        id: 105,
        displayId: 4,
        name: "Breakout",
        purpose: "Capture upside breakouts",
        behavior: "Enters on breakouts with volume expansion",
        logicGroup: "Aggressive Breakout",
        defaultExitPresetId: 7,
        group: "official",
        parameters: [
          { label: "Breakout Lookback", value: "20 candles" },
          { label: "Volume MA", value: "10" },
          { label: "Volume Mult", value: "1.3x" },
          { label: "RSI", value: "60-80" },
          { label: "Trend Confirm", value: "EMA rising or price > VWAP" },
        ],
      },
      {
        id: 103,
        displayId: 5,
        name: "Scalping / Micro-Momentum",
        purpose: "Quick pops in low-volatility ranges",
        behavior: "Short bursts with tight filters",
        logicGroup: "EMA + ATR Momentum (Strategy 3)",
        defaultExitPresetId: 3,
        group: "official",
        parameters: [
          { label: "EMA Fast/Slow", value: "9 / 21" },
          { label: "Body vs ATR", value: "> 0.7x ATR" },
          { label: "RSI", value: "45-55" },
          { label: "Volume Surge", value: "10% above avg" },
        ],
      },
      {
        id: 1,
        displayId: "L1",
        name: "Legacy - Golden Cross",
        purpose: "Baseline moving-average crossover",
        behavior: "Enters on SMA 12/50 crossovers",
        logicGroup: "Golden Cross (Strategy 1)",
        defaultExitPresetId: 1,
        group: "legacy",
        parameters: [
          { label: "Fast MA", value: "12" },
          { label: "Slow MA", value: "50" },
        ],
      },
      {
        id: 2,
        displayId: "L2",
        name: "Legacy - Trend/Pullback",
        purpose: "Original trend + pullback logic",
        behavior: "Trend filtered pullbacks with RSI and candle checks",
        logicGroup: "Trend/Pullback (Strategy 2)",
        defaultExitPresetId: 1,
        group: "legacy",
        parameters: [
          { label: "Fast MA", value: "Config FAST_MA" },
          { label: "Slow MA", value: "Config SLOW_MA" },
        ],
      },
      {
        id: 3,
        displayId: "L3",
        name: "Legacy - EMA + ATR",
        purpose: "EMA crossover with volatility filter",
        behavior: "Momentum entries when crossover plus body > 0.7 x ATR",
        logicGroup: "EMA + ATR Momentum (Strategy 3)",
        defaultExitPresetId: 3,
        group: "legacy",
        parameters: [
          { label: "EMA", value: "9 / 21" },
          { label: "Volatility", value: "Body > 0.7 x ATR" },
        ],
      },
      {
        id: 106,
        displayId: "L6",
        name: "Legacy - Volatility Adaptive Entry",
        purpose: "Fit entries to volatility",
        behavior: "Pullback + entry thresholds scale with ATR",
        logicGroup: "EMA + ATR Momentum (Strategy 3)",
        defaultExitPresetId: 6,
        group: "legacy",
        parameters: [
          { label: "Fast MA", value: "10" },
          { label: "Slow MA", value: "30" },
        ],
      },
      {
        id: 107,
        displayId: "L7",
        name: "Legacy - MA Slope Entry",
        purpose: "Detect the beginning of a new trend",
        behavior: "Enters when MA slopes show acceleration",
        logicGroup: "Trend/Pullback (Strategy 2)",
        defaultExitPresetId: 4,
        group: "legacy",
        parameters: [
          { label: "Fast MA Slope", value: "> 0.1% per candle" },
          { label: "Slow MA Slope", value: "Positive" },
        ],
      },
      {
        id: 108,
        displayId: "L8",
        name: "Legacy - EMA + ATR Core",
        purpose: "Volatility-aware swing entries",
        behavior: "Entries triggered by volatility zones around EMAs",
        logicGroup: "EMA + ATR Momentum (Strategy 3)",
        defaultExitPresetId: 4,
        group: "legacy",
        parameters: [
          { label: "EMA", value: "20 / 50" },
          { label: "ATR Stop", value: "ATR x 1.8" },
        ],
      },
    ];
    const entryStrategiesOfficial = entryStrategies.filter((s) => s.group === "official");
    const entryStrategiesLegacy = entryStrategies.filter((s) => s.group === "legacy");

    const LEGACY_ENTRY_MAP = {
      1: "Legacy only",
      2: "Entry 1",
      3: "Entry 5",
      106: "Entry 5",
      107: "Entry 2",
      108: "Entry 5",
    };

    const EXIT_PRESET_ALIAS_MAP = {
      1: 1,
      2: 4,
      3: 3,
      4: 4,
      5: 6,
      6: 6,
      7: 7,
      8: 3,
    };
    const exitPresetDefaults = [
      {
        id: 1,
        order: 1,
        name: "Conservative",
        purpose: "Lower risk, wider stops with moderate targets.",
        sl: 1.2,
        tp: 2.4,
        trailStart: 1.2,
        trailDistance: 0.6,
        candleRed: 60,
      },
      {
        id: 4,
        order: 2,
        name: "Trend Rider",
        purpose: "Let momentum breathe before trailing.",
        sl: 1.0,
        tp: 4.0,
        trailStart: 2.0,
        trailDistance: 1.0,
        candleRed: 30,
      },
      {
        id: 3,
        order: 3,
        name: "Scalping",
        purpose: "Quick exits for short-term scalps.",
        sl: 0.6,
        tp: 1.2,
        trailStart: 0.8,
        trailDistance: 0.4,
        candleRed: 50,
      },
      {
        id: 7,
        order: 4,
        name: "Breakout",
        purpose: "Give big breakouts space to extend.",
        sl: 0.8,
        tp: 5.0,
        trailStart: 3.0,
        trailDistance: 1.5,
        candleRed: 20,
      },
      {
        id: 6,
        order: 5,
        name: "Volatility Shield",
        purpose: "More protection during choppy sessions.",
        sl: 1.5,
        tp: 2.5,
        trailStart: 2.2,
        trailDistance: 1.2,
        candleRed: 70,
      },
    ];

    const legacyExitPresets = [
      { id: 2, name: "Aggressive Trend" },
      { id: 5, name: "ATR Mixed (semi-dynamic)" },
      { id: 8, name: "Ultra Tight" },
    ];


    

    let exitPresets = loadExitPresets(exitPresetDefaults);

    function applyExitPreset(id) {
      const preset = exitPresets.find((p) => p.id === id);
      if (!preset) {
        exitStatusEl.textContent = "Preset not found.";
        return;
      }

      exitElems.slInput.value = preset.sl.toFixed(2);
      exitElems.tpInput.value = preset.tp.toFixed(2);
      exitElems.trailStartInput.value = preset.trailStart.toFixed(2);
      exitElems.trailDistanceInput.value = preset.trailDistance.toFixed(2);
      exitElems.candleRedInput.value = preset.candleRed.toFixed(0);

      exitStatusEl.textContent = `${formatExitPresetLabel(
        preset
      )} loaded into fields. Click UPDATE EXIT to apply.`;
    }

    // --- HELPERS ---
    function setBotRunUi(running) {
      botRunBadgeEl.textContent = running ? "Running" : "Stopped";
      botRunBadgeEl.classList.toggle("pill-green", running);
      botRunBadgeEl.classList.toggle("pill-red", !running);
      startBotBtn.disabled = running;
      stopBotBtn.disabled = !running;
    }

    function formatTs(ts) {
      if (!ts) return "–";
      const d = new Date(ts);
      return d.toLocaleString();
    }

    function formatPnl(p) {
      if (p === null || p === undefined) return "–";
      const v = Number(p);
      if (Number.isNaN(v)) return "–";
      const sign = v > 0 ? "+" : "";
      return sign + v.toFixed(2) + "%";
    }

    function formatUsd(v) {
      if (v === null || v === undefined) return "–";
      const num = Number(v);
      if (Number.isNaN(num)) return "–";
      const sign = num > 0 ? "+" : num < 0 ? "" : "";
      return sign + num.toFixed(2) + " USDT";
    }

    function pctText(v, digits = 2) {
      return v === null || v === undefined ? "–" : (v * 100).toFixed(digits) + "%";
    }

    function formatRegimeNumber(value, digits = 2) {
      if (!Number.isFinite(value)) return "-";
      return Number(value).toFixed(digits);
    }

    function formatRegimePercent(value, digits = 2) {
      if (!Number.isFinite(value)) return "-";
      return Number(value).toFixed(digits) + "%";
    }

    function formatConfidence(confidence) {
      const value = Number(confidence);
      if (!Number.isFinite(value)) return "-";
      const label = value >= 0.7 ? "High" : value >= 0.5 ? "Medium" : "Low";
      return value.toFixed(2) + " (" + label + ")";
    }

    function formatEntryLabel(meta, fallbackId) {
      const displayId = meta?.displayId ?? meta?.id ?? fallbackId;
      return meta ? `${displayId} - ${meta.name}` : fallbackId || "-";
    }

    function formatExitLabel(meta, fallbackId) {
      const displayId = meta?.order ?? meta?.id ?? fallbackId;
      return meta ? `${displayId} - ${meta.name}` : fallbackId || "-";
    }

    function formatRegimeCheckSummary(regimeState) {
      if (!regimeState) return "";
      const applied = regimeState.detectedRegime || regimeState.currentRegime;
      const checks = regimeState.checks?.[applied]?.checks || [];
      if (!checks.length) return "";
      return checks
        .map((check) => `${check.label}:${check.passed ? "ok" : "fail"}`)
        .join(" | ");
    }

    function regimeExplanation(regime) {
      switch (regime) {
        case "TREND":
          return "Trend detected";
        case "RANGE":
          return "Range detected";
        case "BREAKOUT":
          return "Breakout detected";
        case "NO_TRADE":
          return "No trade allowed";
        default:
          return "Regime scan pending";
      }
    }

    function resolveExitPresetMeta(id) {
      if (id == null) return null;
      const byId = getExitPresetById(String(id)) || getExitPresetById(id);
      if (byId) return byId;
      const numeric = Number(id);
      if (!Number.isFinite(numeric)) return null;
      return exitPresets.find((preset) => preset.order === numeric) || null;
    }

    function setRegimeBadge(element, regime) {
      if (!element) return;
      const label = regime || "-";
      const cssClass =
        label === "NO_TRADE"
          ? "badge-red"
          : label === "RANGE"
            ? "badge-amber"
            : "badge-green";
      element.innerHTML = `<span class="badge ${cssClass}">${escapeHtml(String(label))}</span>`;
    }

    function isAutoMode() {
      return currentMode === "AUTO";
    }

    function persistMarketMode(market, mode) {
      const key = market === "stocks" ? "modeStocks" : "modeCrypto";
      localStorage.setItem(key, mode);
    }

    function setModeControlsEnabled() {
      modeSwitchButtons.forEach((btn) => {
        btn.disabled = false;
        btn.title = "";
      });
      if (modeIndicatorEl) modeIndicatorEl.title = "";
    }

    function setModeUi(mode, options = {}) {
      const next = mode === "AUTO" ? "AUTO" : "MANUAL";
      const changed = currentMode !== next;
      currentMode = next;
      const targetMarket = options.market || currentMarket;
      if (options.syncMarket !== false) {
        modeByMarket[targetMarket] = next;
        persistMarketMode(targetMarket, next);
      }
      document.body.classList.toggle("mode-auto", next === "AUTO");
      document.body.classList.toggle("mode-manual", next === "MANUAL");

      if (modeIndicatorEl) {
        modeIndicatorEl.textContent = "MODE: " + next;
        modeIndicatorEl.classList.toggle("auto", next === "AUTO");
        modeIndicatorEl.classList.toggle("manual", next === "MANUAL");
      }

      modeSwitchButtons.forEach((btn) => {
        const targetMode = btn.dataset.mode === "AUTO" ? "AUTO" : "MANUAL";
        btn.classList.toggle("active", targetMode === next);
      });

      if (entryStrategySelectEl) entryStrategySelectEl.disabled = next === "AUTO";
      if (exitPresetSelectEl) exitPresetSelectEl.disabled = next === "AUTO";
      if (applyExitPresetBtn) applyExitPresetBtn.disabled = next === "AUTO";

      if (exitElems.slInput) exitElems.slInput.disabled = next === "AUTO";
      if (exitElems.tpInput) exitElems.tpInput.disabled = next === "AUTO";
      if (exitElems.trailStartInput) exitElems.trailStartInput.disabled = next === "AUTO";
      if (exitElems.trailDistanceInput) exitElems.trailDistanceInput.disabled = next === "AUTO";
      if (exitElems.candleEnabledInput) exitElems.candleEnabledInput.disabled = next === "AUTO";
      if (exitElems.candleRedInput) exitElems.candleRedInput.disabled = next === "AUTO";

      if (changed) {
        renderEntryStrategyTable();
        renderExitPresetTable();
      }
    }

    function updateRegimeUi(regimeState, data) {
      if (!regimeState) return;
      const appliedRegime = regimeState.currentRegime || regimeState.detectedRegime || "-";
      const detectedRegime = regimeState.detectedRegime || appliedRegime;
      const blockReason = regimeState.blockReason || regimeState.reason || "";
      const allowEntries = regimeState.allowEntries !== false;
      const openPositions = Number(data?.openPositions) || 0;

      if (regimeEls.proxySymbol) regimeEls.proxySymbol.textContent = regimeState.proxySymbol || "-";
      if (regimeEls.timeframe) regimeEls.timeframe.textContent = regimeState.timeframe || "-";
      if (regimeEls.lastScan) regimeEls.lastScan.textContent = formatTs(regimeState.updatedAt);
      if (regimeEls.current) setRegimeBadge(regimeEls.current, appliedRegime);
      if (regimeEls.detected) regimeEls.detected.textContent = detectedRegime;
      if (regimeEls.confidence) regimeEls.confidence.textContent = formatConfidence(regimeState.confidence);
      if (regimeEls.status) regimeEls.status.textContent = allowEntries ? "Active" : "Blocked";
      const checkSummary = formatRegimeCheckSummary(regimeState);
      const selectionNote = regimeState.selection ? `Selection: ${regimeState.selection}` : "";
      const reasonParts = [];
      if (blockReason) reasonParts.push(`Reason: ${blockReason}`);
      if (selectionNote) reasonParts.push(selectionNote);
      if (checkSummary) reasonParts.push(`Checks: ${checkSummary}`);
      if (regimeEls.reason) {
        regimeEls.reason.textContent = reasonParts.join(" | ");
      }

      if (regimeEls.slope) regimeEls.slope.textContent = formatRegimePercent(regimeState.metrics?.slopePct, 3);
      if (regimeEls.rsi) regimeEls.rsi.textContent = formatRegimeNumber(regimeState.metrics?.rsi, 0);
      if (regimeEls.atrRatio) regimeEls.atrRatio.textContent = formatRegimeNumber(regimeState.metrics?.atrRatio, 2);
      if (regimeEls.volumeRatio) regimeEls.volumeRatio.textContent = formatRegimeNumber(regimeState.metrics?.volumeRatio, 2);

      const isNoTrade = appliedRegime === "NO_TRADE";
      if (regimeEls.noTradeBanner) {
        regimeEls.noTradeBanner.style.display = isNoTrade ? "block" : "none";
      }
      if (regimeEls.noTradeReason) {
        regimeEls.noTradeReason.textContent = blockReason || regimeState.reason || "No trade";
      }
      const entryMeta = getEntryStrategyById(regimeState.entryStrategyId);
      const entryIdLabel =
        regimeState.entryStrategyId != null ? String(regimeState.entryStrategyId) : "-";
      const entryLabel = entryMeta
        ? formatEntryLabel(entryMeta, entryIdLabel)
        : entryIdLabel || "-";
      const exitMeta = resolveExitPresetMeta(regimeState.exitPresetId);
      const exitIdLabel =
        regimeState.exitPresetId != null ? String(regimeState.exitPresetId) : null;
      const exitLabel = exitMeta
        ? formatExitLabel(exitMeta, exitIdLabel)
        : exitIdLabel || "-";

      if (autoStrategyEls.regime) autoStrategyEls.regime.textContent = appliedRegime;
      if (autoStrategyEls.entry) autoStrategyEls.entry.textContent = entryLabel;
      if (autoStrategyEls.exit) autoStrategyEls.exit.textContent = exitLabel;
      if (autoStrategyEls.status) {
        autoStrategyEls.status.textContent =
          openPositions > 0 ? "Locked (open position)" : "Applied this loop";
      }
      if (autoStrategyEls.reason) {
        const note = isNoTrade ? "No trade allowed" : regimeExplanation(appliedRegime);
        const parts = [note];
        if (selectionNote) parts.push(selectionNote);
        if (checkSummary) parts.push(`Checks: ${checkSummary}`);
        if (blockReason) parts.push(`Reason: ${blockReason}`);
        autoStrategyEls.reason.textContent = parts.join(" | ");
      }

      if (exitAutoEls.preset) exitAutoEls.preset.textContent = exitLabel;
      if (exitAutoEls.source) {
        const exitSourceId = exitIdLabel || (exitMeta ? exitMeta.id : "");
        exitAutoEls.source.textContent = exitSourceId
          ? `Derived from Exit Preset ${exitSourceId}`
          : "Derived from exit preset";
      }

      if (entryTabAutoEls.regime) entryTabAutoEls.regime.textContent = appliedRegime;
      if (entryTabAutoEls.strategy) entryTabAutoEls.strategy.textContent = entryLabel;
      if (entryTabAutoEls.explanation) {
        const parts = [regimeExplanation(appliedRegime)];
        if (selectionNote) parts.push(selectionNote);
        if (checkSummary) parts.push(`Checks: ${checkSummary}`);
        entryTabAutoEls.explanation.textContent = parts.join(" | ");
      }
    }

    function escapeHtml(str) {
      return str
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    function loadStoredJson(key, fallback) {
      try {
        const raw = localStorage.getItem(key);
        if (!raw) return fallback;
        const parsed = JSON.parse(raw);
        return parsed ?? fallback;
      } catch (err) {
        return fallback;
      }
    }

    function formatExitPresetLabel(preset) {
      return `${preset.order} — ${preset.name}`;
    }

    function formatPercent(value, digits = 2) {
      if (value === null || value === undefined) return "-";
      const num = Number(value);
      if (Number.isNaN(num)) return "-";
      return num.toFixed(digits) + "%";
    }

    function formatAllocation(value) {
      if (value === null || value === undefined) return "-";
      const num = Number(value);
      if (Number.isNaN(num)) return "-";
      return (num * 100).toFixed(0) + "%";
    }

    function formatMillions(value) {
      if (value === null || value === undefined) return "-";
      const num = Number(value);
      if (Number.isNaN(num)) return "-";
      if (num >= 1000000) return (num / 1000000).toFixed(1) + "M";
      if (num >= 1000) return (num / 1000).toFixed(1) + "K";
      return String(num);
    }

    const STOCKS_ENTRY_PRESET_DISPLAY = [
      {
        id: "CORE_TREND",
        name: "Core Trend",
        logic:
          "EMA50 > EMA200, Close > EMA50, ADX14 >= 18, RSI 45-70, Pullback to EMA50",
        params: "EMA fast 50 | EMA slow 200 | ADX 14 | RSI 14",
      },
      {
        id: "SWING_PULLBACK",
        name: "Swing Pullback",
        logic:
          "EMA20 > EMA100, Pullback 0.8-3% below swing high, RSI 40-60, ATR% 1-4.5, Reclaim above EMA20",
        params: "EMA fast 20 | EMA slow 100 | RSI 14 | ATR 14",
      },
      {
        id: "AGGR_BREAKOUT",
        name: "Aggressive Breakout",
        logic:
          "Breakout above 20-bar high, Volume >= 1.8x MA20, RSI 55-75, EMA20 rising or VWAP",
        params: "EMA 20 | RSI 14 | Breakout 20 | Vol x1.8",
      },
    ];
    const STOCKS_EXIT_PRESET_DISPLAY = [
      {
        id: "CORE_EXIT",
        name: "Core Exit",
        stops: "SL 1.8x ATR14 | TP none",
        trail: "Trail 2R @ 2.5x ATR | Trend exit EMA50/EMA200",
      },
      {
        id: "SWING_EXIT",
        name: "Swing Exit",
        stops: "SL 1.2x ATR14 | TP 2.2R",
        trail: "Trail 1.2R @ 1.4x ATR | Time stop 18 bars (<0.6R)",
      },
      {
        id: "AGGR_EXIT",
        name: "Aggressive Exit",
        stops: "SL 0.9x ATR14 | TP 1.6R",
        trail: "Trail 0.8R @ 1x ATR | Invalidate 3 bars",
      },
    ];

    function renderStocksPortfolio(payload) {
      if (!stocksPortfolioEls.card) return;
      const config = payload?.strategyPortfolio;
      const layers = payload?.layers || config?.layers || [];
      const rules = payload?.regimeRules || config?.regimeRules || {};

      if (!config) {
        if (stocksPortfolioEls.globalRisk) stocksPortfolioEls.globalRisk.textContent = "-";
        if (stocksPortfolioEls.timeframes) stocksPortfolioEls.timeframes.textContent = "-";
        if (stocksPortfolioEls.universe) stocksPortfolioEls.universe.textContent = "-";
        if (stocksPortfolioEls.regime) stocksPortfolioEls.regime.textContent = "-";
        if (stocksPortfolioEls.layersBody) stocksPortfolioEls.layersBody.innerHTML = "";
        if (stocksPortfolioEls.entryBody) stocksPortfolioEls.entryBody.innerHTML = "";
        if (stocksPortfolioEls.exitBody) stocksPortfolioEls.exitBody.innerHTML = "";
        return;
      }

      const global = config.globalRisk || {};
      const globalParts = [
        `Max positions ${global.maxTotalPositions ?? "-"}`,
        `Max open risk ${formatPercent(global.maxOpenRiskPct, 2)}`,
        `Daily stop ${formatPercent(global.dailyStopPct, 2)}`,
      ];
      if (stocksPortfolioEls.globalRisk) {
        stocksPortfolioEls.globalRisk.textContent = globalParts.join(" | ");
      }

      if (stocksPortfolioEls.timeframes) {
        const tf = Array.isArray(config.timeframesAllowed)
          ? config.timeframesAllowed.join(", ")
          : "-";
        stocksPortfolioEls.timeframes.textContent = tf || "-";
      }

      const filters = config.universe?.filters || {};
      const filterParts = [
        filters.priceMin || filters.priceMax
          ? `Price $${filters.priceMin ?? "?"}-$${filters.priceMax ?? "?"}`
          : null,
        filters.advDollarMin ? `ADV$ >= ${formatMillions(filters.advDollarMin)}` : null,
        filters.avgShareVolumeMin
          ? `Avg Vol >= ${formatMillions(filters.avgShareVolumeMin)} sh/day`
          : null,
        filters.atrPctMin || filters.atrPctMax
          ? `ATR% ${filters.atrPctMin ?? "?"}-${filters.atrPctMax ?? "?"}`
          : null,
        filters.universeTargetMin || filters.universeTargetMax
          ? `Universe ${filters.universeTargetMin ?? "?"}-${filters.universeTargetMax ?? "?"}`
          : null,
        filters.excludeEtf ? "Exclude ETFs" : null,
        filters.excludeOtc ? "Exclude OTC" : null,
        filters.excludePenny ? "Exclude penny" : null,
      ].filter(Boolean);

      if (stocksPortfolioEls.universe) {
        stocksPortfolioEls.universe.textContent = filterParts.join(" | ") || "-";
      }

      if (stocksPortfolioEls.regime) {
        const parts = Object.keys(rules).map((key) => {
          const list = Array.isArray(rules[key]) ? rules[key].join(", ") : "-";
          return `${key}: ${list || "-"}`;
        });
        stocksPortfolioEls.regime.textContent = parts.join(" | ") || "-";
      }

      if (stocksPortfolioEls.layersBody) {
        const rows = layers.map((layer) => {
          const lossStops = `D ${formatPercent(layer.lossStopDailyPct, 2)} / W ${formatPercent(layer.lossStopWeeklyPct, 2)}`;
          return `
            <tr>
              <td><strong>${escapeHtml(layer.name || layer.id || "-")}</strong></td>
              <td>${formatAllocation(layer.allocationPct)}</td>
              <td>${layer.maxOpenPositions ?? "-"}</td>
              <td>${formatPercent(layer.maxRiskPerTradePct, 2)}</td>
              <td>${lossStops}</td>
              <td>${escapeHtml(layer.timeframe || "-")}</td>
              <td>${escapeHtml(layer.entryPresetId || "-")}</td>
              <td>${escapeHtml(layer.exitPresetId || "-")}</td>
            </tr>
          `;
        });
        stocksPortfolioEls.layersBody.innerHTML = rows.join("") || "";
      }

      if (stocksPortfolioEls.entryBody) {
        const rows = STOCKS_ENTRY_PRESET_DISPLAY.map((preset) => `
          <tr>
            <td><strong>${escapeHtml(preset.name)}</strong><br><span class="subtitle" style="margin:0;">${escapeHtml(preset.id)}</span></td>
            <td>${escapeHtml(preset.logic)}</td>
            <td>${escapeHtml(preset.params)}</td>
          </tr>
        `);
        stocksPortfolioEls.entryBody.innerHTML = rows.join("") || "";
      }

      if (stocksPortfolioEls.exitBody) {
        const rows = STOCKS_EXIT_PRESET_DISPLAY.map((preset) => `
          <tr>
            <td><strong>${escapeHtml(preset.name)}</strong><br><span class="subtitle" style="margin:0;">${escapeHtml(preset.id)}</span></td>
            <td>${escapeHtml(preset.stops)}</td>
            <td>${escapeHtml(preset.trail)}</td>
          </tr>
        `);
        stocksPortfolioEls.exitBody.innerHTML = rows.join("") || "";
      }
    }

    function loadExitPresetOverrides() {
      return loadStoredJson(EXIT_PRESET_STORAGE_KEY, {});
    }

    function saveExitPresetOverrides(overrides) {
      localStorage.setItem(EXIT_PRESET_STORAGE_KEY, JSON.stringify(overrides));
    }

    function loadExitPresets(defaults) {
      const overrides = loadExitPresetOverrides();
      const mappedOverrides = { ...overrides };
      Object.keys(EXIT_PRESET_ALIAS_MAP).forEach((legacyId) => {
        const mappedId = EXIT_PRESET_ALIAS_MAP[legacyId];
        if (overrides[legacyId] && !mappedOverrides[mappedId]) {
          mappedOverrides[mappedId] = overrides[legacyId];
        }
      });
      return defaults.map((preset) => ({
        ...preset,
        ...(mappedOverrides[preset.id] || {}),
      }));
    }

    let entryExitPairs = loadStoredJson(ENTRY_EXIT_PAIR_KEY, {});

    const LOG_SIGNAL_BADGES = new Set([
      "ENTRY",
      "EXIT",
      "BUY",
      "SELL",
      "TP",
      "SL",
      "CLOSED",
      "ERROR",
    ]);
    const LOG_KNOWN_BADGES = new Set([
      "CHECK",
      "NO_POS",
      "PORTFOLIO",
      "PERFORMANCE",
      "TRADES",
      "WAIT",
      "ERROR",
      "SIGNAL",
      "ENTRY",
      "EXIT",
      "BUY",
      "SELL",
      "TP",
      "SL",
      "CLOSED",
    ]);

    function normalizeBadgeToken(token) {
      const upper = token.trim().toUpperCase();
      if (upper === "NO POS" || upper === "NO POSITION" || upper === "NO_POSITION") {
        return "NO_POS";
      }
      return upper.replace(/\s+/g, "_");
    }

    function detectBadgeFromText(text) {
      const rules = [
        { key: "ERROR", regex: /\bERROR\b/i },
        { key: "NO_POS", regex: /\bNO POS\b|\bNO POSITION\b|conditions NOT met/i },
        { key: "ENTRY", regex: /\bENTRY\b/i },
        { key: "EXIT", regex: /\bEXIT\b/i },
        { key: "BUY", regex: /\bBUY\b/i },
        { key: "SELL", regex: /\bSELL\b/i },
        { key: "TP", regex: /\bTP\b/i },
        { key: "SL", regex: /\bSL\b/i },
        { key: "CLOSED", regex: /\bCLOSED\b/i },
        { key: "PORTFOLIO", regex: /\bPORTFOLIO\b/i },
        { key: "PERFORMANCE", regex: /\bPERFORMANCE\b/i },
        { key: "TRADES", regex: /\bTRADES\b/i },
        { key: "CHECK", regex: /\bCHECK\b/i },
        { key: "WAIT", regex: /\bWAIT\b/i },
        { key: "SIGNAL", regex: /\bSIGNAL\b/i },
      ];

      for (const rule of rules) {
        if (rule.regex.test(text)) {
          return rule.key;
        }
      }
      return "";
    }

    function formatLogTime(ts) {
      const parsed = new Date(ts);
      if (Number.isNaN(parsed.getTime())) return "--:--:--";
      return parsed.toISOString().slice(11, 19);
    }

    function parseLogLine(line) {
      const raw = String(line || "").trimEnd();
      if (!raw) return null;

      let working = raw.trim();
      let scope = "";
      let time = "--:--:--";

      const scopeMatch = working.match(/^\[(CRYPTO|STOCKS)\]\s*/i);
      if (scopeMatch) {
        scope = scopeMatch[1].toUpperCase();
        working = working.slice(scopeMatch[0].length);
      } else {
        scope = currentMarket === "stocks" ? "STOCKS" : "CRYPTO";
      }

      const tsMatch = working.match(/^\[([^\]]+)\]\s*/);
      if (tsMatch) {
        time = formatLogTime(tsMatch[1]);
        working = working.slice(tsMatch[0].length);
      }

      let symbol = "-";
      let badgeKey = "";
      let message = working.trim();

      const firstBracket = message.match(/^\[([^\]]+)\]\s*/);
      if (firstBracket) {
        const token = firstBracket[1].trim();
        const normalized = normalizeBadgeToken(token);
        if (LOG_KNOWN_BADGES.has(normalized)) {
          badgeKey = normalized;
          message = message.slice(firstBracket[0].length).trim();
        } else {
          symbol = token;
          message = message.slice(firstBracket[0].length).trim();
        }
      }

      if (!badgeKey) {
        badgeKey = detectBadgeFromText(message);
      }

      if (!badgeKey) {
        badgeKey = "INFO";
      }

      if (/^-{2,}\s*wait\s*\d+\s*sec\s*-{2,}$/i.test(message)) {
        return { isDivider: true };
      }

      return {
        raw,
        scope,
        time,
        symbol: symbol || "-",
        badgeKey,
        message: message || "-",
      };
    }

    function getBadgeClass(badgeKey) {
      if (badgeKey === "BUY" || badgeKey === "ENTRY" || badgeKey === "SIGNAL") {
        return "log-badge-buy";
      }
      if (badgeKey === "SELL" || badgeKey === "EXIT" || badgeKey === "CLOSED") {
        return "log-badge-exit";
      }
      if (badgeKey === "TP") {
        return "log-badge-tp";
      }
      if (badgeKey === "SL") {
        return "log-badge-sl";
      }
      if (badgeKey === "ERROR") {
        return "log-badge-error";
      }
      if (
        badgeKey === "PORTFOLIO" ||
        badgeKey === "PERFORMANCE" ||
        badgeKey === "TRADES"
      ) {
        return "log-badge-blue";
      }
      return "log-badge-muted";
    }

    function renderLogRow(entry) {
      const badgeClass = getBadgeClass(entry.badgeKey);
      const rowClasses = ["log-row"];
      if (entry.badgeKey === "ERROR") {
        rowClasses.push("error");
      }
      if (
        entry.badgeKey === "PORTFOLIO" &&
        /portfolio|summary|balances|positions|holdings|total/i.test(entry.message)
      ) {
        rowClasses.push("section");
      }
      return `
        <div class="${rowClasses.join(" ")}">
          <div class="log-col">${escapeHtml(entry.time)}</div>
          <div class="log-col">${escapeHtml(entry.scope)}</div>
          <div class="log-col"><span class="log-badge ${badgeClass}">[${escapeHtml(entry.badgeKey)}]</span></div>
          <div class="log-col">${escapeHtml(entry.symbol || "-")}</div>
          <div class="log-col log-message">${escapeHtml(entry.message)}</div>
        </div>
      `;
    }

    function isLogAtBottom() {
      if (!logContainerEl) return true;
      return (
        logContainerEl.scrollTop + logContainerEl.clientHeight >=
        logContainerEl.scrollHeight - 4
      );
    }

    function updateAutoScrollUi() {
      if (logAutoStatusEl) {
        logAutoStatusEl.textContent = `Auto-scroll: ${logAutoScrollEnabled ? "ON" : "OFF"}`;
      }
      if (logResumeBtnEl) {
        logResumeBtnEl.disabled = logAutoScrollEnabled;
      }
      if (logAutoPausedEl) {
        logAutoPausedEl.classList.toggle("is-hidden", logAutoScrollEnabled);
      }
    }

    function setAutoScroll(enabled, scrollToBottom = false) {
      logAutoScrollEnabled = enabled;
      updateAutoScrollUi();
      if (enabled && scrollToBottom) {
        if (logContainerEl) {
          logContainerEl.scrollTop = logContainerEl.scrollHeight;
        }
      }
    }

    function normalizeLogLine(line) {
      const raw = String(line ?? "");
      if (/^\[(CRYPTO|STOCKS)\]\s*/i.test(raw)) {
        return raw;
      }
      const scope = currentMarket === "stocks" ? "STOCKS" : "CRYPTO";
      return `[${scope}] ${raw}`;
    }

    function renderLogs() {
      if (!logRowsEl) return;
      const search = (logSearchInputEl?.value || "").trim().toLowerCase();
      const hideEntryCheck = !!logToggleHideEntryCheckEl?.checked;
      const signalsOnly = !!logToggleSignalsOnlyEl?.checked;
      const hidePortfolio = !!logToggleHidePortfolioEl?.checked;
      const hidePerfTrades = !!logToggleHidePerfTradesEl?.checked;

      const previousScrollTop = logContainerEl ? logContainerEl.scrollTop : 0;

      const rows = [];
      logLinesCache.forEach((line) => {
        const entry = parseLogLine(line);
        if (!entry) return;
        if (entry.isDivider) {
          rows.push('<div class="log-divider"></div>');
          return;
        }

        const rawLower = entry.raw.toLowerCase();
        if (hideEntryCheck && rawLower.includes("entry 2 check")) return;
        if (signalsOnly && !LOG_SIGNAL_BADGES.has(entry.badgeKey)) return;
        if (hidePortfolio && entry.badgeKey === "PORTFOLIO") return;
        if (hidePerfTrades && (entry.badgeKey === "PERFORMANCE" || entry.badgeKey === "TRADES")) return;
        if (search) {
          const haystack = `${entry.symbol} ${entry.message}`.toLowerCase();
          if (!haystack.includes(search)) return;
        }

        rows.push(renderLogRow(entry));
      });

      logRowsEl.innerHTML = rows.join("") || '<div class="log-empty">(no logs yet)</div>';

      if (logContainerEl) {
        if (logAutoScrollEnabled) {
          logContainerEl.scrollTop = logContainerEl.scrollHeight;
        } else {
          logContainerEl.scrollTop = previousScrollTop;
        }
      }
    }

    function getExitPresetById(id) {
      const numeric = Number(id);
      if (!Number.isFinite(numeric)) return null;
      const mapped = EXIT_PRESET_ALIAS_MAP[numeric] || numeric;
      return exitPresets.find((preset) => preset.id === mapped) || null;
    }

    function getEntryExitPair(entryId) {
      if (entryExitPairs[entryId]) return entryExitPairs[entryId];
      const entry = getEntryStrategyById(entryId);
      return entry?.defaultExitPresetId || "";
    }

    function saveEntryExitPair(entryId, presetId) {
      if (!entryId) return;
      if (!presetId) {
        const { [entryId]: _, ...rest } = entryExitPairs;
        entryExitPairs = rest;
      } else {
        entryExitPairs = {
          ...entryExitPairs,
          [entryId]: presetId,
        };
      }
      localStorage.setItem(ENTRY_EXIT_PAIR_KEY, JSON.stringify(entryExitPairs));
    }

    function getEntryStrategyById(id) {
      const numericId = Number(id);
      return entryStrategies.find((s) => s.id === numericId);
    }

    function describeStrategy(id) {
      const meta = getEntryStrategyById(id);
      const displayId = meta?.displayId ?? meta?.id;
      return meta ? `${displayId} - ${meta.name}` : `ID ${id}`;
    }

    function buildExitPresetOptions(selectedId) {
      const options = ['<option value="">No preset</option>'];
      const numeric = Number(selectedId);
      const normalizedSelected = Number.isFinite(numeric)
        ? EXIT_PRESET_ALIAS_MAP[numeric] || numeric
        : null;
      exitPresets.forEach((preset) => {
        const selected = preset.id === normalizedSelected ? "selected" : "";
        options.push(
          `<option value="${preset.id}" ${selected}>${escapeHtml(
            formatExitPresetLabel(preset)
          )}</option>`
        );
      });
      return options.join("");
    }

    function renderExitPresetOptions() {
      if (!exitPresetSelectEl) return;
      const current = exitPresetSelectEl.value;
      const numeric = Number(current);
      const normalized = Number.isFinite(numeric)
        ? EXIT_PRESET_ALIAS_MAP[numeric] || numeric
        : null;
      exitPresetSelectEl.innerHTML = '<option value="" selected disabled>Select exit preset...</option>';
      exitPresets.forEach((preset) => {
        const opt = document.createElement("option");
        opt.value = preset.id;
        opt.textContent = formatExitPresetLabel(preset);
        exitPresetSelectEl.appendChild(opt);
      });
      if (normalized) {
        exitPresetSelectEl.value = String(normalized);
      }
    }

    function renderEntryStrategyOptions() {
      if (!entryStrategySelectEl) return;
      entryStrategySelectEl.innerHTML = '<option value="" disabled selected>Select entry strategy...</option>';
      entryStrategiesOfficial.forEach((s) => {
        const opt = document.createElement("option");
        const displayId = s.displayId != null ? s.displayId : s.id;
        opt.value = s.id;
        opt.textContent = `${displayId} - ${s.name}`;
        entryStrategySelectEl.appendChild(opt);
      });
    }

    function renderEntryStrategyTable() {
      if (!strategyTableBodyEl) return;
      const rows = entryStrategiesOfficial.map((s) => {
        const disabledAttr = isAutoMode() ? "disabled" : "";
        const params = s.parameters
          .map((p) => `<div><strong>${p.label}:</strong> ${p.value}</div>`)
          .join("");
        const pairedExitId = getEntryExitPair(s.id);
        const pairingSelect = `
          <div style="display: flex; flex-direction: column; gap: 6px;">
            <select class="pairing-select" data-entry-id="${s.id}" ${disabledAttr}>
              ${buildExitPresetOptions(pairedExitId)}
            </select>
            <button class="btn btn-outline btn-small" data-action="load-pair" data-entry-id="${s.id}" ${disabledAttr}>
              Load exit preset
            </button>
          </div>
        `;
        const displayId = s.displayId != null ? s.displayId : s.id;
        return `
          <tr>
            <td>${displayId}</td>
            <td>${escapeHtml(s.name)}</td>
            <td><div><strong>Purpose:</strong> ${escapeHtml(s.purpose)}</div><div><strong>Behavior:</strong> ${escapeHtml(s.behavior)}</div></td>
            <td>${escapeHtml(s.logicGroup || "-")}</td>
            <td>${pairingSelect}</td>
            <td>${params}</td>
          </tr>
        `;
      });
      strategyTableBodyEl.innerHTML = rows.join("");
    }

    function renderLegacyEntryStrategyTable() {
      if (!legacyStrategyTableBodyEl) return;
      const rows = entryStrategiesLegacy.map((s) => {
        const displayId = s.displayId != null ? s.displayId : s.id;
        const mapped = LEGACY_ENTRY_MAP[s.id] || "Entry 1-5";
        return `
          <tr>
            <td>${displayId}</td>
            <td>${escapeHtml(s.name)}</td>
            <td>${escapeHtml(s.purpose)}</td>
            <td>${escapeHtml(mapped)}</td>
          </tr>
        `;
      });
      legacyStrategyTableBodyEl.innerHTML = rows.join("");
    }

function renderExitPresetTable() {
      if (!exitStrategyTableBodyEl) return;
      const rows = exitPresets.map((preset) => {
        const disabledAttr = isAutoMode() ? "disabled" : "";
        const values = `
          <div class="preset-inputs">
            <label class="preset-input">SL
              <input type="number" step="0.1" min="0.1" max="50" value="${preset.sl}" data-field="sl" ${disabledAttr} />
            </label>
            <label class="preset-input">TP
              <input type="number" step="0.1" min="0.1" max="100" value="${preset.tp}" data-field="tp" ${disabledAttr} />
            </label>
            <label class="preset-input">Trail Start
              <input type="number" step="0.1" min="0.1" max="100" value="${preset.trailStart}" data-field="trailStart" ${disabledAttr} />
            </label>
            <label class="preset-input">Trail Distance
              <input type="number" step="0.1" min="0.1" max="100" value="${preset.trailDistance}" data-field="trailDistance" ${disabledAttr} />
            </label>
            <label class="preset-input">Candle Red
              <input type="number" step="1" min="0" max="100" value="${preset.candleRed}" data-field="candleRed" ${disabledAttr} />
            </label>
          </div>
        `;
        return `
          <tr data-exit-id="${preset.id}">
            <td>${preset.order}</td>
            <td>${escapeHtml(preset.name)}</td>
            <td>${escapeHtml(preset.purpose)}</td>
            <td>${values}</td>
            <td>
              <div style="display: flex; flex-direction: column; gap: 6px;">
                <button class="btn btn-outline btn-small" data-action="load-exit" data-exit-id="${preset.id}" ${disabledAttr}>
                  Load
                </button>
                <button class="btn btn-primary btn-small" data-action="save-exit" data-exit-id="${preset.id}" ${disabledAttr}>
                  Save
                </button>
                <button class="btn btn-outline btn-small" data-action="reset-exit" data-exit-id="${preset.id}" ${disabledAttr}>
                  Reset
                </button>
              </div>
            </td>
          </tr>
        `;
      });
      exitStrategyTableBodyEl.innerHTML = rows.join("");
    }
function renderLegacyExitPresetTable() {
      if (!legacyExitPresetBodyEl) return;
      const rows = legacyExitPresets.map((preset) => {
        const mappedPreset = getExitPresetById(preset.id);
        const mappedLabel = mappedPreset ? mappedPreset.order : "-";
        return `
          <tr>
            <td>${preset.id}</td>
            <td>${escapeHtml(preset.name)}</td>
            <td>${escapeHtml(String(mappedLabel))}</td>
          </tr>
        `;
      });
      legacyExitPresetBodyEl.innerHTML = rows.join("");
    }


    function readExitPresetInputs(row) {
      const values = {};
      const fields = ["sl", "tp", "trailStart", "trailDistance", "candleRed"];
      fields.forEach((field) => {
        const input = row.querySelector(`input[data-field="${field}"]`);
        const value = input ? Number(input.value) : NaN;
        values[field] = value;
      });
      return values;
    }

    function isExitPresetValid(values) {
      return (
        Number.isFinite(values.sl) &&
        Number.isFinite(values.tp) &&
        Number.isFinite(values.trailStart) &&
        Number.isFinite(values.trailDistance) &&
        Number.isFinite(values.candleRed) &&
        values.sl > 0 &&
        values.tp > 0 &&
        values.trailStart > 0 &&
        values.trailDistance > 0 &&
        values.candleRed >= 0 &&
        values.candleRed <= 100
      );
    }

    function saveExitPreset(id, values) {
      const overrides = loadExitPresetOverrides();
      overrides[id] = values;
      saveExitPresetOverrides(overrides);
      exitPresets = loadExitPresets(exitPresetDefaults);
    }

    function resetExitPreset(id) {
      const overrides = loadExitPresetOverrides();
      delete overrides[id];
      saveExitPresetOverrides(overrides);
      exitPresets = loadExitPresets(exitPresetDefaults);
    }

    function updateStrategyUiFromStatus(activeId) {
      const meta = getEntryStrategyById(activeId);
      const displayId = meta?.displayId ?? meta?.id;
      const label = meta ? `${displayId} - ${meta.name}` : activeId ?? "-";
      statusEls.strategy.textContent = label || "-";
      if (entryStrategySelectEl) {
        entryStrategySelectEl.value = meta ? String(meta.id) : "";
      }
      if (meta) {
        const pairedExitId = getEntryExitPair(meta.id);
        const pairedPreset = pairedExitId ? getExitPresetById(pairedExitId) : null;
        const pairedExit = pairedPreset
          ? ` | Suggested Exit: ${formatExitPresetLabel(pairedPreset)}`
          : "";
        strategyStatusEl.textContent = `Entry Strategy: ${displayId} - ${meta.name}${pairedExit}`;
      } else if (activeId != null) {
        strategyStatusEl.textContent = `Entry Strategy: ${activeId}`;
      } else {
        strategyStatusEl.textContent = "Select an entry strategy to send it live.";
      }
    }
      if (meta) {
        const pairedExitId = getEntryExitPair(meta.id);
        const pairedPreset = pairedExitId ? getExitPresetById(pairedExitId) : null;
        const pairedExit = pairedPreset
          ? ` • Suggested Exit: ${formatExitPresetLabel(pairedPreset)}`
          : "";
        strategyStatusEl.textContent = `Entry Strategy: ${meta.id} – ${meta.name}${pairedExit}`;
      } else if (activeId != null) {
        strategyStatusEl.textContent = `Entry Strategy: ${activeId}`;
      } else {
        strategyStatusEl.textContent = "Select an entry strategy to send it live.";
      }
    }

    function updateSummaryGroup(key, stats) {
      const cfg = summaryConfig[key];
      const els = summaryEls[key];
      if (!cfg || !els || !els.pnlValue) return;

      const total = Number(stats?.total) || 0;
      const wins = Number(stats?.wins) || 0;
      const losses = Number(stats?.losses) || 0;

      let sumPnLPct = Number(stats?.sumPnLPct);
      let sumPnlValue = Number(stats?.sumPnlValue);

      if (!Number.isFinite(sumPnLPct)) sumPnLPct = 0;
      if (!Number.isFinite(sumPnlValue)) sumPnlValue = 0;

      els.pnlValue.textContent = formatUsd(sumPnlValue);
      els.pnlPct.textContent = formatPnl(sumPnLPct);
      els.trades.textContent = String(total);
      els.winLoss.textContent = `Wins ${wins} • Losses ${losses}`;

      if (total > 0) {
        const winRate = (wins / total) * 100;
        els.winRate.textContent = `${winRate.toFixed(1)}%`;
        const avgPnl = sumPnLPct / total;
        els.avgPnl.textContent = `Avg/Trade: ${formatPnl(avgPnl)}`;
      } else {
        els.winRate.textContent = "0%";
        els.avgPnl.textContent = `No trades in last ${cfg.label}`;
      }
    }

    function updateSummaryBar(allStats) {
      if (!allStats) return;
      Object.keys(summaryConfig).forEach((key) => {
        updateSummaryGroup(key, allStats?.[key]);
      });
    }

    function stopPolling() {
      if (statusTimer) clearInterval(statusTimer);
      if (logTimer) clearInterval(logTimer);
      if (logListTimer) clearInterval(logListTimer);
      statusTimer = null;
      logTimer = null;
      logListTimer = null;
    }

    function startPolling() {
      fetchStatus();
      fetchLogs();
      fetchLogFiles();
      fetchPortfolio();
      statusTimer = setInterval(fetchStatus, 8000);
      logTimer = setInterval(fetchLogs, 5000);
      logListTimer = setInterval(fetchLogFiles, 15000);
    }

    async function fetchPortfolio() {
      if (currentMarket !== "stocks") {
        portfolioSnapshot = null;
        renderStocksPortfolio(null);
        return;
      }
      try {
        const res = await fetch(`/api/portfolio?market=${currentMarket}`);
        const data = await res.json();
        if (!data.ok) throw new Error(data.error || "portfolio failed");
        portfolioSnapshot = data;
        renderStocksPortfolio(data);
      } catch (err) {
        if (stocksPortfolioEls.globalRisk) {
          stocksPortfolioEls.globalRisk.textContent = "Portfolio error: " + err.message;
        }
      }
    }

    function applyMarketTheme(target) {
      document.body.classList.toggle("theme-crypto", target === "crypto");
      document.body.classList.toggle("theme-stocks", target === "stocks");
      setMarketTypeLock(target);
      setModeControlsEnabled();
      if (sellAllBtnEl) {
        sellAllBtnEl.textContent =
          target === "stocks" ? "SELL ALL (Stocks)" : "SELL ALL (Crypto)";
      }
      if (entryStrategyMarketLabelEl) {
        entryStrategyMarketLabelEl.textContent =
          target === "stocks"
            ? "Entry Strategy Presets - Stocks (US Equities)"
            : "Entry Strategy Presets - Crypto";
      }
    }

    function setMarketTypeLock(target) {
      if (!settingsInputs.marketType) return;
      const lockedMarket = target === "stocks" ? "stocks" : "crypto";
      settingsInputs.marketType.value = lockedMarket;
      settingsInputs.marketType.disabled = true;
      settingsInputs.marketType.title =
        lockedMarket === "stocks"
          ? "Locked to Stocks (Alpaca Trades) for this tab"
          : "Locked to Crypto (Binance) for this tab";
    }

    function setActiveMarket(nextMarket) {
      const target = nextMarket === "stocks" ? "stocks" : "crypto";
      currentMarket = target;
      localStorage.setItem("activeMarket", target);
      selectedLogFile = "";
      updateLogDownloadLink();
      marketTabButtons.forEach((btn) =>
        btn.classList.toggle("active", btn.dataset.market === target)
      );
      applyMarketTheme(target);
      setModeUi(modeByMarket[target], { market: target });
      stopPolling();
      startPolling();
    }

    function updateStocksStrategyStatus(status) {
      const portfolio = status.portfolio || {};
      const regime = portfolio.regime || "N/A";
      const dailyStop = portfolio.dailyStopHit ? " | Daily stop hit" : "";
      statusEls.strategy.textContent = `Portfolio ${regime}${dailyStop}`;
    }

    // --- STATUS POLLING ---
    async function fetchStatus() {
      try {
        const res = await fetch(`/api/status?market=${currentMarket}`);
        const data = await res.json();
        if (!data.ok) throw new Error("status not ok");

        const cfg = data;
        setBotRunUi(data.botRunning !== false);

        const regimeState = data.regimeState || null;
        if (currentMarket === "crypto") {
          const settingsMode = cachedSettings?.REGIME_ENGINE?.MODE;
          const resolvedMode =
            settingsMode || regimeState?.mode || modeByMarket.crypto || currentMode;
          const nextMode = resolvedMode === "AUTO" ? "AUTO" : "MANUAL";
          setModeUi(nextMode, { market: "crypto" });
        } else {
          setModeUi(modeByMarket.stocks || "MANUAL", {
            market: "stocks",
            syncMarket: false,
          });
        }
        if (regimeState) {
          updateRegimeUi(regimeState, data);
        }
        if (currentMarket === "stocks") {
          updateStocksStrategyStatus(cfg);
        } else {
          updateStrategyUiFromStatus(cfg.activeStrategyId);
        }

        const intervalMs = cfg.config?.loopIntervalMs || cfg.loopIntervalMs;
        statusEls.interval.textContent = intervalMs ? intervalMs / 1000 + " s" : "–";

        const perfEquity = data.performance?.lastEquity;
        const alpacaEquity = data.alpaca?.equity;
        const equityValue =
          currentMarket === "stocks" && alpacaEquity != null
            ? alpacaEquity
            : perfEquity;

        if (equityValue != null) {
          const equity = Number(equityValue);
          const quoteLabel = currentMarket === "stocks" ? "USD" : "USDT";
          statusEls.equity.textContent = Number.isFinite(equity)
            ? equity.toFixed(2) + " " + quoteLabel
            : "-";
        } else {
          statusEls.equity.textContent = "-";
        }

        if (data.performance) {
          statusEls.pnl.textContent = formatPnl(data.performance.lastPnlPct);
        }

        const exitSource =
          isAutoMode() && data.regimeState?.exitConfig
            ? data.regimeState.exitConfig
            : data.exitConfig;
        if (exitSource) {
          const ex = exitSource;
          const inputSource = data.exitConfig || ex;

          exitElems.slValue.textContent = pctText(ex.SL_PCT ?? ex.slPct);
          exitElems.tpValue.textContent = pctText(ex.TP_PCT ?? ex.tpPct);
          exitElems.trailStartValue.textContent = pctText(
            ex.TRAIL_START_PCT ?? ex.trailStartPct
          );
          exitElems.trailDistanceValue.textContent = pctText(
            ex.TRAIL_DISTANCE_PCT ?? ex.trailDistancePct
          );
          const candleEnabled = !!(ex.CANDLE_EXIT_ENABLED ?? ex.candleExitEnabled);
          const candleValue = ex.CANDLE_RED_TRIGGER_PCT ?? ex.candleRedTriggerPct;
          exitElems.candleRedValue.textContent = candleEnabled
            ? `Enabled (${pctText(candleValue, 0)})`
            : "Disabled";
          exitElems.candleEnabledInput.checked = candleEnabled;
          exitElems.candleRedInput.disabled = !candleEnabled;

          // Prefill inputs only if empty, to avoid overwriting user typing
          if (!exitElems.slInput.value && inputSource.slPct != null)
            exitElems.slInput.value = (inputSource.slPct * 100).toFixed(2);
          if (!exitElems.tpInput.value && inputSource.tpPct != null)
            exitElems.tpInput.value = (inputSource.tpPct * 100).toFixed(2);
          if (!exitElems.trailStartInput.value && inputSource.trailStartPct != null)
            exitElems.trailStartInput.value = (inputSource.trailStartPct * 100).toFixed(2);
          if (!exitElems.trailDistanceInput.value && inputSource.trailDistancePct != null)
            exitElems.trailDistanceInput.value = (inputSource.trailDistancePct * 100).toFixed(2);
          if (!exitElems.candleRedInput.value && inputSource.candleRedTriggerPct != null)
            exitElems.candleRedInput.value = (inputSource.candleRedTriggerPct * 100).toFixed(0);
        }

        const symbolsCount =
          data.symbolsCount != null
            ? data.symbolsCount
            : data.stateSummary?.symbols;
        statusEls.symbols.textContent =
          symbolsCount != null ? String(symbolsCount) : "–";

        const isStocks = currentMarket === "stocks";
        stocksOnlyEls.forEach((el) => el.classList.toggle("active", isStocks));
        if (isStocks && data.marketClock) {
          const clock = data.marketClock;
          const isOpen = clock.isOpen === true;
          statusEls.stocksMarketOpen.innerHTML = isOpen
            ? '<span class="badge badge-green">OPEN</span>'
            : '<span class="badge badge-amber">CLOSED</span>';
          statusEls.stocksNextOpen.textContent = clock.nextOpen || "?";
          statusEls.stocksCountdown.textContent = clock.countdown || "?";
          if (stocksCountdownRowEl) {
            stocksCountdownRowEl.classList.toggle("countdown-focus", !isOpen);
          }
          if (statusEls.stocksCountdownNote) {
            statusEls.stocksCountdownNote.textContent = isOpen
              ? ""
              : "Bot running - waiting for market open";
          }
        }

        if (isStocks && statusEls.alpaca) {
          const alpaca = data.alpaca || {};
          if (alpaca.missingKeys) {
            statusEls.alpaca.innerHTML =
              '<span class="badge badge-red">DISCONNECTED</span> Missing Alpaca API key/secret';
          } else if (alpaca.connected) {
            const base = alpaca.baseUrl
              ? " " + escapeHtml(String(alpaca.baseUrl))
              : "";
            statusEls.alpaca.innerHTML =
              '<span class="badge badge-green">CONNECTED</span>' + base;
          } else {
            const err = alpaca.lastError
              ? " " + escapeHtml(String(alpaca.lastError))
              : "";
            statusEls.alpaca.innerHTML =
              '<span class="badge badge-red">DISCONNECTED</span>' + err;
          }
        } else if (statusEls.alpaca) {
          statusEls.alpaca.textContent = "-";
        }

        updateSummaryBar(data.tradeStats || {});

        statusEls.updated.textContent =
          "Last update: " +
          formatTs(
            data.stateSummary?.lastUpdateTs ||
              data.performance?.lastUpdateTs ||
              Date.now()
          );
      } catch (err) {
        statusEls.updated.textContent = "Status error: " + err.message;
      }
    }

    // --- EXIT SETTINGS ---
    async function updateExitConfig() {
      try {
        exitStatusEl.textContent = "Sending EXIT config...";

        const sl = parseFloat(exitElems.slInput.value);
        const tp = parseFloat(exitElems.tpInput.value);
        const ts = parseFloat(exitElems.trailStartInput.value);
        const td = parseFloat(exitElems.trailDistanceInput.value);
        const cr = parseFloat(exitElems.candleRedInput.value);
        const candleEnabled = exitElems.candleEnabledInput.checked;

        const payload = {};

        if (!Number.isNaN(sl)) payload.slPct = sl / 100.0;
        if (!Number.isNaN(tp)) payload.tpPct = tp / 100.0;
        if (!Number.isNaN(ts)) payload.trailStartPct = ts / 100.0;
        if (!Number.isNaN(td)) payload.trailDistancePct = td / 100.0;
        if (!Number.isNaN(cr)) payload.candleRedTriggerPct = cr / 100.0;
        payload.candleExitEnabled = candleEnabled;

        const res = await fetch(`/api/config?market=${currentMarket}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        const data = await res.json();
        if (!data.ok) throw new Error(data.error || "failed");

        exitStatusEl.textContent = "EXIT updated successfully.";
        await fetchStatus();
      } catch (err) {
        exitStatusEl.textContent = "Error: " + err.message;
      }
    }

    // --- SETTINGS ---
    async function loadSettingsCache() {
      try {
        const res = await fetch("/api/settings");
        const data = await res.json();
        if (!data.ok) throw new Error(data.error || "failed");
        cachedSettings = data.settings || {};
        if (cachedSettings?.REGIME_ENGINE?.MODE) {
          const nextMode =
            cachedSettings.REGIME_ENGINE.MODE === "AUTO" ? "AUTO" : "MANUAL";
          if (currentMarket === "crypto") {
            setModeUi(nextMode, { market: "crypto" });
          } else {
            modeByMarket.crypto = nextMode;
            persistMarketMode("crypto", nextMode);
          }
        }
      } catch (err) {
        // Allow status polling to drive mode UI if settings load fails.
      }
    }

    async function updateModeSetting(nextMode) {
      try {
        const mode = nextMode === "AUTO" ? "AUTO" : "MANUAL";
        if (currentMarket !== "crypto") {
          setModeUi(mode, { market: "stocks" });
          botControlStatusEl.textContent = `Stocks mode set to ${mode}.`;
        } else {
          botControlStatusEl.textContent = `Updating mode to ${mode}...`;
          if (!cachedSettings) await loadSettingsCache();
          const base = cachedSettings || {};
          const payload = {
            ...base,
            REGIME_ENGINE: {
              ...(base.REGIME_ENGINE || {}),
              MODE: mode,
            },
          };

          const res = await fetch("/api/settings", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          const data = await res.json();
          if (!data.ok) throw new Error(data.error || "failed");
          cachedSettings = data.settings || payload;
          botControlStatusEl.textContent = `Mode updated to ${mode}.`;
          setModeUi(mode, { market: "crypto" });
          await fetchStatus();
        }
      } catch (err) {
        botControlStatusEl.textContent = "Mode update error: " + err.message;
      }
    }

    async function fetchSettings() {
      try {
        settingsStatusEl.textContent = "Loading settings...";
        const res = await fetch("/api/settings");
        const data = await res.json();
        if (!data.ok) throw new Error(data.error || "failed");

        const settings = data.settings || {};
        cachedSettings = settings;
        if (settings?.REGIME_ENGINE?.MODE) {
          const nextMode =
            settings.REGIME_ENGINE.MODE === "AUTO" ? "AUTO" : "MANUAL";
          if (currentMarket === "crypto") {
            setModeUi(nextMode, { market: "crypto" });
          } else {
            modeByMarket.crypto = nextMode;
            persistMarketMode("crypto", nextMode);
          }
        }
        settingsInputs.binanceApiKey.value = settings.binanceApiKey || "";
        settingsInputs.binanceApiSecret.value = settings.binanceApiSecret || "";
        settingsInputs.binanceBaseUrl.value = settings.binanceBaseUrl || "";
        settingsInputs.tradingViewWebhookUrl.value =
          settings.tradingViewWebhookUrl || "";
        settingsInputs.marketType.value = settings.marketType || "crypto";
        setMarketTypeLock(currentMarket);
        settingsInputs.alpacaApiKey.value = settings.alpacaApiKey || "";
        settingsInputs.alpacaApiSecret.value = settings.alpacaApiSecret || "";
        settingsInputs.alpacaTradingBaseUrl.value =
          settings.alpacaTradingBaseUrl || "";
        settingsInputs.alpacaDataBaseUrl.value =
          settings.alpacaDataBaseUrl || "";
        settingsInputs.alpacaDataFeed.value = settings.alpacaDataFeed || "";
        settingsStatusEl.textContent = "";
      } catch (err) {
        settingsStatusEl.textContent = "Settings error: " + err.message;
      }
    }

    async function saveSettings() {
      try {
        settingsStatusEl.textContent = "Saving settings...";
        const base = cachedSettings || {};
        const payload = {
          ...base,
          binanceApiKey: settingsInputs.binanceApiKey.value.trim(),
          binanceApiSecret: settingsInputs.binanceApiSecret.value.trim(),
          binanceBaseUrl: settingsInputs.binanceBaseUrl.value.trim(),
          tradingViewWebhookUrl: settingsInputs.tradingViewWebhookUrl.value.trim(),
          marketType: currentMarket,
          alpacaApiKey: settingsInputs.alpacaApiKey.value.trim(),
          alpacaApiSecret: settingsInputs.alpacaApiSecret.value.trim(),
          alpacaTradingBaseUrl: settingsInputs.alpacaTradingBaseUrl.value.trim(),
          alpacaDataBaseUrl: settingsInputs.alpacaDataBaseUrl.value.trim(),
          alpacaDataFeed: settingsInputs.alpacaDataFeed.value.trim(),
          REGIME_ENGINE: {
            ...(base.REGIME_ENGINE || {}),
            MODE: base.REGIME_ENGINE?.MODE || currentMode,
          },
        };

        const res = await fetch("/api/settings", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        const data = await res.json();
        if (!data.ok) throw new Error(data.error || "failed");
        cachedSettings = data.settings || payload;
        settingsStatusEl.textContent = "Settings saved successfully.";
      } catch (err) {
        settingsStatusEl.textContent = "Settings error: " + err.message;
      }
    }

    async function testAlpacaConnection() {
      try {
        settingsStatusEl.textContent = "Testing Alpaca connection...";
        const res = await fetch("/api/alpaca/test?market=stocks", { method: "POST" });
        const data = await res.json();
        if (!data.ok) {
          settingsStatusEl.textContent = "Alpaca test failed: " + (data.error || "failed");
        } else {
          const equity = Number.isFinite(Number(data.equity))
            ? " Equity=" + Number(data.equity).toFixed(2)
            : "";
          settingsStatusEl.textContent = "Alpaca test OK." + equity;
        }
        await fetchStatus();
      } catch (err) {
        settingsStatusEl.textContent = "Alpaca test error: " + err.message;
      }
    }

    // --- LOGS POLLING ---
    function updateLogDownloadLink() {
      if (selectedLogFile) {
        logDownloadLinkEl.href = `/api/logs/download?market=${currentMarket}&file=${encodeURIComponent(selectedLogFile)}`;
        logDownloadLinkEl.setAttribute("aria-disabled", "false");
      } else {
        logDownloadLinkEl.removeAttribute("href");
        logDownloadLinkEl.setAttribute("aria-disabled", "true");
      }
    }

    async function fetchLogFiles() {
      try {
        const res = await fetch(`/api/logs/list?market=${currentMarket}`);
        const data = await res.json();
        if (!data.ok || !Array.isArray(data.files)) {
          throw new Error("invalid log list");
        }

        const options = ["<option value=\"\">Latest (live)</option>"];
        data.files.forEach((file) => {
          const sizeKb = file.size ? (file.size / 1024).toFixed(1) : "0";
          const label = file.date ? `${file.date} (${sizeKb} KB)` : `${file.name} (${sizeKb} KB)`;
          const selected = file.name === selectedLogFile ? "selected" : "";
          options.push(`<option value="${file.name}" ${selected}>${label}</option>`);
        });

        logFileSelectEl.innerHTML = options.join("");

        if (selectedLogFile && !data.files.find((f) => f.name === selectedLogFile)) {
          selectedLogFile = "";
        }

        updateLogDownloadLink();
      } catch (err) {
        logStatusPillEl.textContent = "Log list error: " + err.message;
      }
    }

    async function fetchLogs() {
      try {
        const url = selectedLogFile
          ? `/api/logs?market=${currentMarket}&file=${encodeURIComponent(selectedLogFile)}`
          : `/api/logs?market=${currentMarket}`;
        const res = await fetch(url);
        const data = await res.json();
        if (!data.ok || !Array.isArray(data.lines)) {
          throw new Error("invalid log payload");
        }

        logLinesCache = (data.lines || []).map((line) => normalizeLogLine(line));
        renderLogs();
        const label = selectedLogFile ? `Viewing ${selectedLogFile}` : "Polling every 5s";
        logStatusPillEl.textContent = `${label} • ${new Date().toLocaleTimeString()}`;
      } catch (err) {
        logStatusPillEl.textContent = "Log error: " + err.message;
      }
    }

    // --- CONTROLS ---
    async function startBot() {
      try {
        botControlStatusEl.textContent = "Starting bot...";
        const res = await fetch("/api/bot/start", { method: "POST" });
        const data = await res.json();
        if (!res.ok || !data.ok) throw new Error(data.error || "failed");
        botControlStatusEl.textContent = "Bot resumed. Continuing from saved state.";
        setBotRunUi(true);
      } catch (err) {
        botControlStatusEl.textContent = "Error: " + err.message;
      }
    }

    async function stopBot() {
      try {
        botControlStatusEl.textContent = "Stopping bot after current loop...";
        const res = await fetch("/api/bot/stop", { method: "POST" });
        const data = await res.json();
        if (!res.ok || !data.ok) throw new Error(data.error || "failed");
        botControlStatusEl.textContent = "Bot will pause after persisting state.";
        setBotRunUi(false);
      } catch (err) {
        botControlStatusEl.textContent = "Error: " + err.message;
      }
    }

    async function setStrategy(id) {
      try {
        const label = describeStrategy(id);
        strategyStatusEl.textContent = `Sending strategy change for ${label}...`;
        const res = await fetch(`/api/config?market=${currentMarket}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ activeStrategyId: Number(id) }),
        });
        const data = await res.json();
        if (!data.ok) throw new Error(data.error || "failed");
        strategyStatusEl.textContent = "Entry Strategy set to " + label;
        await fetchStatus();
      } catch (err) {
        strategyStatusEl.textContent = "Error: " + err.message;
      }
    }

    async function setIntervalMs(ms) {
      try {
        intervalStatusEl.textContent = "Sending interval change...";
        const res = await fetch(`/api/config?market=${currentMarket}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ loopIntervalMs: ms }),
        });
        const data = await res.json();
        if (!data.ok) throw new Error(data.error || "failed");
        intervalStatusEl.textContent = "Interval set to " + ms / 1000 + " sec";
        await fetchStatus();
      } catch (err) {
        intervalStatusEl.textContent = "Error: " + err.message;
      }
    }

    async function sellAll() {
      try {
        intervalStatusEl.textContent = "Sending SELL ALL...";
        const res = await fetch(`/api/sellAll?market=${currentMarket}`, {
          method: "POST",
        });
        const data = await res.json();
        if (!data.ok) throw new Error(data.error || "failed");
        intervalStatusEl.textContent = "SELL ALL requested";
      } catch (err) {
        intervalStatusEl.textContent = "Error: " + err.message;
      }
    }

    startBotBtn.addEventListener("click", startBot);
    stopBotBtn.addEventListener("click", stopBot);
    settingsToggleBtn.addEventListener("click", () => {
      settingsPanelEl.classList.toggle("open");
      if (settingsPanelEl.classList.contains("open")) {
        fetchSettings();
      }
    });
    modeSwitchButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        const targetMode = btn.dataset.mode === "AUTO" ? "AUTO" : "MANUAL";
        updateModeSetting(targetMode);
      });
    });
    saveSettingsBtn.addEventListener("click", saveSettings);
    if (testAlpacaBtn) testAlpacaBtn.addEventListener("click", testAlpacaConnection);
    applyExitPresetBtn.addEventListener("click", () => {
      const presetId = exitPresetSelectEl.value;
      if (!presetId) {
        exitStatusEl.textContent = "Please choose a preset first.";
        return;
      }
      applyExitPreset(presetId);
    });
    exitPresetSelectEl.addEventListener("change", () => {
      if (exitPresetSelectEl.value) {
        applyExitPreset(exitPresetSelectEl.value);
      }
    });

    tabButtons.forEach((button) => {
      button.addEventListener("click", () => {
        const target = button.dataset.tab;
        tabButtons.forEach((btn) => btn.classList.toggle("active", btn === button));
        tabPanels.forEach((panel) =>
          panel.classList.toggle("active", panel.id === `${target}StrategyTab`)
        );
      });
    });

    strategyTableBodyEl.addEventListener("change", (event) => {
      const target = event.target;
      if (!(target instanceof HTMLSelectElement)) return;
      if (!target.classList.contains("pairing-select")) return;
      const entryId = Number(target.dataset.entryId);
      saveEntryExitPair(entryId, target.value);
      strategyStatusEl.textContent = `Saved pairing for Entry ${entryId}.`;
    });

    strategyTableBodyEl.addEventListener("click", (event) => {
      const button = event.target.closest("button");
      if (!button) return;
      const action = button.dataset.action;
      if (action !== "load-pair") return;
      const entryId = Number(button.dataset.entryId);
      const selectEl = strategyTableBodyEl.querySelector(
        `select.pairing-select[data-entry-id="${entryId}"]`
      );
      const presetId = selectEl?.value;
      if (!presetId) {
        exitStatusEl.textContent = "Select an exit preset to load.";
        return;
      }
      applyExitPreset(presetId);
    });

    exitStrategyTableBodyEl.addEventListener("click", (event) => {
      const button = event.target.closest("button");
      if (!button) return;
      const action = button.dataset.action;
      const presetId = button.dataset.exitId;
      if (!action || !presetId) return;
      const row = button.closest("tr");
      if (!row) return;
      if (action === "load-exit") {
        applyExitPreset(presetId);
        return;
      }
      if (action === "save-exit") {
        const values = readExitPresetInputs(row);
        if (!isExitPresetValid(values)) {
          exitStatusEl.textContent = "Please enter valid numbers before saving.";
          return;
        }
        saveExitPreset(presetId, values);
        renderExitPresetOptions();
        renderExitPresetTable();
        renderEntryStrategyTable();
        const preset = getExitPresetById(presetId);
        exitStatusEl.textContent = preset
          ? `${formatExitPresetLabel(preset)} saved.`
          : "Preset saved.";
        return;
      }
      if (action === "reset-exit") {
        resetExitPreset(presetId);
        renderExitPresetOptions();
        renderExitPresetTable();
        renderEntryStrategyTable();
        const preset = getExitPresetById(presetId);
        exitStatusEl.textContent = preset
          ? `${formatExitPresetLabel(preset)} reset to default.`
          : "Preset reset.";
      }
    });

    exitElems.candleEnabledInput.addEventListener("change", () => {
      exitElems.candleRedInput.disabled = !exitElems.candleEnabledInput.checked;
    });

    entryStrategySelectEl.addEventListener("change", () => {
      const id = Number(entryStrategySelectEl.value);
      if (!id) return;
      setStrategy(id);
    });

    marketTabButtons.forEach((button) => {
      button.addEventListener("click", () => {
        const target = button.dataset.market;
        if (!target) return;
        setActiveMarket(target);
      });
    });

    renderExitPresetOptions();
    renderEntryStrategyOptions();
    renderEntryStrategyTable();
    renderLegacyEntryStrategyTable();
    renderExitPresetTable();
    renderLegacyExitPresetTable();

    logFileSelectEl.addEventListener("change", () => {
      selectedLogFile = logFileSelectEl.value;
      updateLogDownloadLink();
      fetchLogs();
    });

    logLoadBtn.addEventListener("click", () => {
      fetchLogs();
    });

    logRefreshBtn.addEventListener("click", () => {
      fetchLogFiles();
    });

    if (logSearchInputEl) {
      logSearchInputEl.addEventListener("input", () => {
        renderLogs();
      });
    }

    [
      logToggleHideEntryCheckEl,
      logToggleSignalsOnlyEl,
      logToggleHidePortfolioEl,
      logToggleHidePerfTradesEl,
    ].forEach((el) => {
      if (!el) return;
      el.addEventListener("change", () => {
        renderLogs();
      });
    });

    if (logResumeBtnEl) {
      logResumeBtnEl.addEventListener("click", () => {
        setAutoScroll(true, true);
      });
    }

    if (logResumeStickyBtnEl) {
      logResumeStickyBtnEl.addEventListener("click", () => {
        setAutoScroll(true, true);
      });
    }

    if (logContainerEl) {
      logContainerEl.addEventListener("scroll", () => {
        if (logAutoScrollEnabled && !isLogAtBottom()) {
          setAutoScroll(false, false);
        }
      });
    }

    // --- INITIAL LOAD ---
    updateAutoScrollUi();
    setModeUi(currentMode);
    loadSettingsCache();
    setActiveMarket(currentMarket);
  </script>
</body>
</html>
