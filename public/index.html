<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Crypto Bot Control Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #111827;
      color: #e5e7eb;
    }
    .container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 20px;
    }
    h1 {
      margin: 0 0 10px;
      font-size: 24px;
      color: #f9fafb;
    }
    .subtitle {
      margin-bottom: 20px;
      color: #9ca3af;
      font-size: 14px;
    }
    .control-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #1f2933;
      border-radius: 8px;
      padding: 12px 16px;
      border: 1px solid #111827;
      margin-bottom: 14px;
      box-shadow: 0 0 0 1px #111827;
    }
    .control-info {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .control-title {
      font-size: 15px;
      font-weight: 600;
      color: #f9fafb;
    }
    .control-note {
      font-size: 12px;
      color: #9ca3af;
    }
    .control-actions {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .pill-green {
      background: #064e3b;
      color: #6ee7b7;
    }
    .pill-red {
      background: #7f1d1d;
      color: #fecaca;
    }
    .num-input {
      width: 70px;
      padding: 3px 6px;
      border-radius: 4px;
      border: 1px solid #4b5563;
      background: #111827;
      color: #e5e7eb;
      font-size: 12px;
      margin-right: 4px;
    }

    .grid {
      display: grid;
      grid-template-columns: 340px 1fr;
      gap: 20px;
    }

    .card {
      background: #1f2933;
      border-radius: 8px;
      padding: 16px;
      box-shadow: 0 0 0 1px #111827;
    }
    .card h2 {
      margin: 0 0 12px;
      font-size: 18px;
      color: #f9fafb;
    }

    .row {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 8px;
    }
    .row + .row {
      margin-top: 6px;
    }
    .label {
      min-width: 110px;
      font-size: 14px;
      color: #9ca3af;
    }
    .value {
      font-size: 14px;
      color: #e5e7eb;
      font-weight: 500;
    }

    .badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      margin-left: 8px;
    }
    .badge-green {
      background: #064e3b;
      color: #6ee7b7;
    }
    .badge-red {
      background: #7f1d1d;
      color: #fecaca;
    }

    .btn {
      border: none;
      border-radius: 6px;
      padding: 6px 12px;
      font-size: 13px;
      cursor: pointer;
      margin-right: 6px;
      margin-top: 4px;
      transition: background 0.15s, transform 0.05s;
    }
    .btn:active {
      transform: translateY(1px);
    }
    .btn-primary {
      background: #2563eb;
      color: #f9fafb;
    }
    .btn-outline {
      background: transparent;
      color: #e5e7eb;
      border: 1px solid #4b5563;
    }
    .btn-danger {
      background: #b91c1c;
      color: #fee2e2;
    }
    .btn-small {
      font-size: 12px;
      padding: 4px 10px;
    }

    .status-line {
      font-size: 12px;
      color: #9ca3af;
      margin-top: 4px;
    }

    /* LOG AREA LIKE TERMINAL */
    .log-container {
      background: #000000;
      border-radius: 8px;
      padding: 8px 10px;
      border: 1px solid #4b5563;
      height: 520px;
      overflow-y: auto;
      font-family: "Consolas", "SF Mono", "Menlo", "Monaco", monospace;
      font-size: 12px;
      line-height: 1.3;
      color: #d1d5db;
      white-space: pre; /* שומר על הפורמט בדיוק כמו בטרמינל */
    }

    .log-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }
    .log-title {
      font-size: 13px;
      color: #9ca3af;
    }
    .pill {
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: #111827;
      color: #9ca3af;
      border: 1px solid #4b5563;
    }

    .log-buy {
      color: #34d399;
      font-weight: 700;
    }
    .log-sell {
      color: #f87171;
      font-weight: 700;
    }
    .log-tp {
      color: #fbbf24;
      font-weight: 700;
    }
    .log-sl {
      color: #c084fc;
      font-weight: 700;
    }

    .strategy-table-wrapper {
      margin-top: 12px;
      overflow-x: auto;
    }

    .strategy-table {
      width: 100%;
      border-collapse: collapse;
      color: #e5e7eb;
      font-size: 13px;
    }

    .strategy-table th,
    .strategy-table td {
      padding: 8px;
      border-bottom: 1px solid #374151;
      vertical-align: top;
      text-align: left;
    }

    .strategy-table th {
      background: #111827;
      color: #9ca3af;
      font-weight: 700;
      font-size: 12px;
      letter-spacing: 0.03em;
      text-transform: uppercase;
    }

    .strategy-table td strong {
      color: #f9fafb;
    }

    .entry-variables {
      font-size: 13px;
      color: #cbd5e1;
      background: #111827;
      border: 1px solid #1f2937;
      border-radius: 6px;
      padding: 8px 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Crypto Bot Control Panel</h1>
    <div class="subtitle">
      Live control over strategy, interval, kill switch and reset funds.
      Logs are shown exactly as in the terminal.
    </div>

    <div class="control-bar">
      <div class="control-info">
        <div class="control-title">Bot run control</div>
        <div class="control-note">Pause safely saves state & performance so you can resume later.</div>
      </div>
      <div class="control-actions">
        <span id="botRunBadge" class="pill pill-green">Running</span>
        <button id="startBotBtn" class="btn btn-primary btn-small">START BOT</button>
        <button id="stopBotBtn" class="btn btn-danger btn-small">STOP BOT</button>
      </div>
    </div>
    <div class="status-line" id="botControlStatus"></div>

    <div class="grid">
      <!-- LEFT: STATUS + CONTROLS -->
      <div class="card">
        <h2>Status & Controls</h2>

        <!-- STATUS -->
        <div class="row">
          <span class="label">Strategy:</span>
          <span class="value">
            <span id="statusStrategy">–</span>
          </span>
        </div>
        <div class="row">
          <span class="label">Interval:</span>
          <span class="value"><span id="statusInterval">–</span></span>
        </div>
        <div class="row">
          <span class="label">Last Equity:</span>
          <span class="value">
            <span id="statusEquity">–</span>
          </span>
        </div>
        <div class="row">
          <span class="label">Last PNL:</span>
          <span class="value">
            <span id="statusPnl">–</span>
          </span>
        </div>
        <div class="row">
          <span class="label">Kill switch:</span>
          <span class="value">
            <span id="statusKill">OFF</span>
            <span id="killBadge" class="badge badge-green">Inactive</span>
          </span>
        </div>
        <div class="status-line" id="statusUpdated">Last update: –</div>

        <hr style="border: none; border-top: 1px solid #374151; margin: 10px 0;" />
            <!-- LEFT: EXIT SETTINGS CARD -->
      <div class="card" style="margin-top: 12px;">
        <h2>Exit Settings</h2>

        <!-- ערכים בפועל -->
        <div class="row">
          <span class="label">Current SL:</span>
          <span class="value"><span id="exitSlValue">–</span></span>
        </div>
        <div class="row">
          <span class="label">Current TP:</span>
          <span class="value"><span id="exitTpValue">–</span></span>
        </div>
        <div class="row">
          <span class="label">Trail Start:</span>
          <span class="value"><span id="exitTrailStartValue">–</span></span>
        </div>
        <div class="row">
          <span class="label">Trail Distance:</span>
          <span class="value"><span id="exitTrailDistanceValue">–</span></span>
        </div>
        <div class="row">
          <span class="label">Candle Exit:</span>
          <span class="value"><span id="exitCandleRedValue">–</span></span>
        </div>

        <hr style="border: none; border-top: 1px solid #374151; margin: 10px 0;" />

        <div class="row">
          <span class="label">Preset sets:</span>
          <div>
            <select id="exitPresetSelect" class="num-input" style="width: 240px;">
              <option value="" selected disabled>Select exit preset...</option>
              <option value="conservative">1 — Conservative</option>
              <option value="aggressive-trend">2 — Aggressive Trend</option>
              <option value="safe-scalping">3 — Safe Scalping</option>
              <option value="momentum-rider">4 — Momentum Rider</option>
              <option value="atr-mixed">5 — ATR Mixed (semi-dynamic)</option>
              <option value="volatility-shield">6 — Volatility Shield</option>
              <option value="breakout-mode">7 — Breakout Mode</option>
              <option value="ultra-tight">8 — Ultra Tight</option>
            </select>
            <button id="applyExitPresetBtn" class="btn btn-outline btn-small" style="margin-left: 4px;">
              Apply preset
            </button>
          </div>
        </div>

        <!-- עריכה דינמית -->
        <div class="row">
          <span class="label">Edit (%):</span>
          <div>
            <input id="exitSlInput" class="num-input" type="number" step="0.1" min="0.1" max="50" placeholder="SL" />
            <input id="exitTpInput" class="num-input" type="number" step="0.1" min="0.1" max="100" placeholder="TP" />
          </div>
        </div>
        <div class="row">
          <span class="label"></span>
          <div>
            <input id="exitTrailStartInput" class="num-input" type="number" step="0.1" min="0.1" max="100" placeholder="Trail Start" />
            <input id="exitTrailDistanceInput" class="num-input" type="number" step="0.1" min="0.1" max="100" placeholder="Trail Dist." />
          </div>
        </div>
        <div class="row">
          <span class="label">Candle (%):</span>
          <div>
            <label style="display: flex; align-items: center; gap: 8px;">
              <input id="exitCandleEnabledInput" type="checkbox" />
              <span>Use candle confirmation</span>
            </label>
            <input
              id="exitCandleRedInput"
              class="num-input"
              type="number"
              step="1"
              min="0"
              max="100"
              placeholder="Red %"
              disabled
            />
          </div>
        </div>

        <div class="row" style="margin-top: 8px;">
          <span class="label"></span>
          <div>
            <button class="btn btn-primary btn-small" onclick="updateExitConfig()">
              UPDATE EXIT
            </button>
          </div>
        </div>

        <div class="status-line" id="exitStatus"></div>
      </div>

        <!-- ENTRY STRATEGY SELECTION -->
        <div class="row">
          <span class="label">Entry Strategy:</span>
          <div>
            <select id="entryStrategySelect" class="num-input" style="width: 260px;">
              <option value="" disabled selected>Select entry strategy...</option>
            </select>
          </div>
        </div>
        <div class="status-line" id="strategyStatus">Select an entry strategy to send it live.</div>

        <!-- INTERVAL -->
        <div class="row" style="margin-top: 8px;">
          <span class="label">Loop interval:</span>
          <div>
            <button class="btn btn-outline btn-small" onclick="setIntervalMs(60000)">Every 60s</button>
            <button class="btn btn-outline btn-small" onclick="setIntervalMs(300000)">Every 5 min</button>
            <button class="btn btn-outline btn-small" onclick="setIntervalMs(900000)">Every 15 min</button>
          </div>
        </div>
        <div class="status-line" id="intervalStatus"></div>

        <!-- SELL & RESET -->
        <div class="row" style="margin-top: 10px;">
          <span class="label">Actions:</span>
          <div>
            <button class="btn btn-danger btn-small" onclick="killSwitch()">SELL ALL NOW</button>
            <button id="resetFundsBtn" class="btn btn-outline btn-small" style="margin-left: 6px;">
              RESET FUNDS (10,000 USDT)
            </button>
          </div>
        </div>
        <div class="status-line" id="resetFundsStatus"></div>
      </div>

      <!-- RIGHT: LOG VIEWER -->
      <div class="card">
        <div class="log-header">
          <div class="log-title">Live Logs</div>
          <div>
            <span class="pill" id="logStatusPill">Polling every 5s</span>
          </div>
        </div>
      <div id="logContainer" class="log-container">
        Loading logs...
      </div>
    </div>
  </div>

    <div class="card" style="margin-top: 16px;">
      <h2>Entry Strategy Presets</h2>
      <p class="subtitle" style="margin-bottom: 12px;">
        These presets adjust trend, pullback, momentum, ATR, and volume filters. Selecting one updates the bot
        immediately for the next trading loop.
      </p>
      <div class="entry-variables">
        <strong>Key entry variables:</strong> MA Fast / MA Slow, Pullback %, RSI Range, ATR Filter, Volume Surge.
      </div>
      <div class="strategy-table-wrapper">
        <table class="strategy-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Name</th>
              <th>Purpose & Behavior</th>
              <th>Parameters</th>
            </tr>
          </thead>
          <tbody id="strategyTableBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    const statusEls = {
      strategy: document.getElementById("statusStrategy"),
      interval: document.getElementById("statusInterval"),
      equity: document.getElementById("statusEquity"),
      pnl: document.getElementById("statusPnl"),
      kill: document.getElementById("statusKill"),
      killBadge: document.getElementById("killBadge"),
      updated: document.getElementById("statusUpdated"),
    };

    const strategyStatusEl = document.getElementById("strategyStatus");
    const intervalStatusEl = document.getElementById("intervalStatus");
    const resetFundsStatusEl = document.getElementById("resetFundsStatus");
    const logContainerEl = document.getElementById("logContainer");
    const logStatusPillEl = document.getElementById("logStatusPill");
    const botControlStatusEl = document.getElementById("botControlStatus");
    const botRunBadgeEl = document.getElementById("botRunBadge");
    const startBotBtn = document.getElementById("startBotBtn");
    const stopBotBtn = document.getElementById("stopBotBtn");

    const exitElems = {
      slValue: document.getElementById("exitSlValue"),
      tpValue: document.getElementById("exitTpValue"),
      trailStartValue: document.getElementById("exitTrailStartValue"),
      trailDistanceValue: document.getElementById("exitTrailDistanceValue"),
      candleRedValue: document.getElementById("exitCandleRedValue"),

      slInput: document.getElementById("exitSlInput"),
      tpInput: document.getElementById("exitTpInput"),
      trailStartInput: document.getElementById("exitTrailStartInput"),
      trailDistanceInput: document.getElementById("exitTrailDistanceInput"),
      candleRedInput: document.getElementById("exitCandleRedInput"),
      candleEnabledInput: document.getElementById("exitCandleEnabledInput"),
    };

    const exitStatusEl = document.getElementById("exitStatus");
    const exitPresetSelectEl = document.getElementById("exitPresetSelect");
    const applyExitPresetBtn = document.getElementById("applyExitPresetBtn");
    const entryStrategySelectEl = document.getElementById("entryStrategySelect");
    const strategyTableBodyEl = document.getElementById("strategyTableBody");

    const entryStrategies = [
      {
        id: 101,
        name: "Conservative Trend Entry",
        purpose: "Stable trends, avoid whipsaw",
        behavior: "Few but high-quality trades",
        parameters: [
          { label: "Fast MA", value: "20" },
          { label: "Slow MA", value: "200" },
          { label: "Pullback", value: "1.0%–2.0%" },
          { label: "RSI", value: "50–60" },
          { label: "ATR Filter", value: "ON (ATR > ATR_MA × 0.7)" },
          { label: "Volume Surge", value: "Optional" },
        ],
      },
      {
        id: 102,
        name: "Aggressive Trend Entry",
        purpose: "Strong trends & momentum markets",
        behavior: "Early entries on breakouts and shallow pullbacks",
        parameters: [
          { label: "Fast MA", value: "10" },
          { label: "Slow MA", value: "50" },
          { label: "Pullback", value: "2.5%–4%" },
          { label: "RSI", value: "55–70" },
          { label: "ATR Filter", value: "OFF" },
          { label: "Volume Surge", value: "ON (≥ 20% above 10-candle avg)" },
        ],
      },
      {
        id: 103,
        name: "Scalping Mode",
        purpose: "Small moves, sideways markets",
        behavior: "Many small, fast trades",
        parameters: [
          { label: "Fast MA", value: "9" },
          { label: "Slow MA", value: "21" },
          { label: "Pullback", value: "≤ 1.0%" },
          { label: "RSI", value: "45–55" },
          { label: "ATR Filter", value: "OFF" },
          { label: "Volume Surge", value: "Low (≥ 10%)" },
        ],
      },
      {
        id: 104,
        name: "Deep Pullback Entry",
        purpose: "Buy deep dips inside an uptrend",
        behavior: "Waits for larger pullbacks for discount entries",
        parameters: [
          { label: "Fast MA", value: "50" },
          { label: "Slow MA", value: "200" },
          { label: "Pullback", value: "3%–6%" },
          { label: "RSI", value: "28–40" },
          { label: "ATR Filter", value: "ON" },
          { label: "Volume Surge", value: "OFF" },
        ],
      },
      {
        id: 105,
        name: "Breakout Entry",
        purpose: "Capture large upside breakouts",
        behavior: "Ignores pullbacks; enters on momentum bursts",
        parameters: [
          { label: "Fast MA", value: "15" },
          { label: "Slow MA", value: "50" },
          { label: "Pullback", value: "0%–1%" },
          { label: "RSI", value: "≥ 60" },
          { label: "ATR Filter", value: "ON" },
          { label: "Volume Surge", value: "High (≥ 30%)" },
        ],
      },
      {
        id: 106,
        name: "Volatility Adaptive Entry (ATR-Based)",
        purpose: "Fit entries to volatility",
        behavior: "Pullback + entry thresholds scale with ATR",
        parameters: [
          { label: "Fast MA", value: "10" },
          { label: "Slow MA", value: "30" },
          { label: "Pullback", value: "ATR × 1.2" },
          { label: "RSI", value: "48–65" },
          { label: "ATR Filter", value: "≥ 1.5 × Average ATR" },
          { label: "Volume Surge", value: "Recommended" },
        ],
      },
      {
        id: 107,
        name: "MA Slope Entry",
        purpose: "Detect the beginning of a new trend",
        behavior: "Enters when MA slopes show acceleration",
        parameters: [
          { label: "Fast MA Slope", value: "> 0.1% per candle" },
          { label: "Slow MA Slope", value: "Positive" },
          { label: "Pullback", value: "1%–3%" },
          { label: "RSI", value: "50–65" },
          { label: "ATR Filter", value: "OFF" },
          { label: "Volume Surge", value: "Moderate" },
        ],
      },
      {
        id: 108,
        name: "EMA + ATR Core (Enhanced Version of Strategy 3)",
        purpose: "Volatility-aware swing entries",
        behavior: "Entries triggered by volatility zones around EMAs",
        parameters: [
          { label: "EMA", value: "20 / 50" },
          { label: "ATR Stop", value: "ATR × 1.8" },
          { label: "Pullback", value: "ATR × 0.8" },
          { label: "RSI", value: "45–60" },
          { label: "Volume Surge", value: "Optional" },
        ],
      },
      {
        id: 1,
        name: "Legacy – Golden Cross",
        purpose: "Baseline moving-average crossover",
        behavior: "Enters on SMA 12/50 crossovers",
        parameters: [
          { label: "Fast MA", value: "12" },
          { label: "Slow MA", value: "50" },
          { label: "Pullback", value: "Cross confirmation" },
          { label: "RSI", value: "Not enforced" },
          { label: "ATR Filter", value: "None" },
          { label: "Volume Surge", value: "Not enforced" },
        ],
      },
      {
        id: 2,
        name: "Legacy – Trend/Pullback",
        purpose: "Original trend + pullback logic",
        behavior: "Trend filtered pullbacks with RSI and candle checks",
        parameters: [
          { label: "Fast MA", value: "Config FAST_MA" },
          { label: "Slow MA", value: "Config SLOW_MA" },
          { label: "Pullback", value: "~0.4%–0.8% below fast MA" },
          { label: "RSI", value: "Config RSI min/max" },
          { label: "ATR Filter", value: "None" },
          { label: "Volume Surge", value: "Optional" },
        ],
      },
      {
        id: 3,
        name: "Legacy – EMA + ATR",
        purpose: "EMA 9/21 crossover with volatility filter",
        behavior: "Momentum entries when crossover plus candle body > 0.7 × ATR",
        parameters: [
          { label: "EMA", value: "9 / 21" },
          { label: "Volatility", value: "Body > 0.7 × ATR" },
          { label: "Pullback", value: "Not required" },
          { label: "RSI", value: "Not enforced" },
          { label: "ATR Filter", value: "Implicit via body" },
          { label: "Volume Surge", value: "Not enforced" },
        ],
      },
    ];

    const exitPresets = [
      {
        id: "conservative",
        label: "1 — Conservative",
        sl: 1.2,
        tp: 2.4,
        trailStart: 1.2,
        trailDistance: 0.6,
        candleRed: 60,
      },
      {
        id: "aggressive-trend",
        label: "2 — Aggressive Trend",
        sl: 0.9,
        tp: 3.2,
        trailStart: 1.6,
        trailDistance: 0.8,
        candleRed: 40,
      },
      {
        id: "safe-scalping",
        label: "3 — Safe Scalping",
        sl: 0.6,
        tp: 1.2,
        trailStart: 0.8,
        trailDistance: 0.4,
        candleRed: 50,
      },
      {
        id: "momentum-rider",
        label: "4 — Momentum Rider",
        sl: 1.0,
        tp: 4.0,
        trailStart: 2.0,
        trailDistance: 1.0,
        candleRed: 30,
      },
      {
        id: "atr-mixed",
        label: "5 — ATR Mixed (semi-dynamic)",
        sl: 0.6,
        tp: 1.4,
        trailStart: 2.0,
        trailDistance: 1.0,
        candleRed: 40,
      },
      {
        id: "volatility-shield",
        label: "6 — Volatility Shield",
        sl: 1.5,
        tp: 2.5,
        trailStart: 2.2,
        trailDistance: 1.2,
        candleRed: 70,
      },
      {
        id: "breakout-mode",
        label: "7 — Breakout Mode",
        sl: 0.8,
        tp: 5.0,
        trailStart: 3.0,
        trailDistance: 1.5,
        candleRed: 20,
      },
      {
        id: "ultra-tight",
        label: "8 — Ultra Tight",
        sl: 0.4,
        tp: 0.8,
        trailStart: 0.5,
        trailDistance: 0.25,
        candleRed: 60,
      },
    ];

    function applyExitPreset(id) {
      const preset = exitPresets.find((p) => p.id === id);
      if (!preset) {
        exitStatusEl.textContent = "Preset not found.";
        return;
      }

      exitElems.slInput.value = preset.sl.toFixed(2);
      exitElems.tpInput.value = preset.tp.toFixed(2);
      exitElems.trailStartInput.value = preset.trailStart.toFixed(2);
      exitElems.trailDistanceInput.value = preset.trailDistance.toFixed(2);
      exitElems.candleRedInput.value = preset.candleRed.toFixed(0);

      exitStatusEl.textContent = `${preset.label} loaded into fields. Click UPDATE EXIT to apply.`;
    }

    // --- HELPERS ---
    function setBotRunUi(running) {
      botRunBadgeEl.textContent = running ? "Running" : "Stopped";
      botRunBadgeEl.classList.toggle("pill-green", running);
      botRunBadgeEl.classList.toggle("pill-red", !running);
      startBotBtn.disabled = running;
      stopBotBtn.disabled = !running;
    }

    function formatTs(ts) {
      if (!ts) return "–";
      const d = new Date(ts);
      return d.toLocaleString();
    }

    function formatPnl(p) {
      if (p === null || p === undefined) return "–";
      const v = Number(p);
      if (Number.isNaN(v)) return "–";
      const sign = v > 0 ? "+" : "";
      return sign + v.toFixed(2) + "%";
    }

    function pctText(v, digits = 2) {
      return v === null || v === undefined ? "–" : (v * 100).toFixed(digits) + "%";
    }

    function escapeHtml(str) {
      return str
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    function highlightLog(line) {
      let safe = escapeHtml(line);
      const highlights = [
        { regex: /\bBUY\b/g, cls: "log-buy" },
        { regex: /\bSELL\b/g, cls: "log-sell" },
        { regex: /\bTP\b/g, cls: "log-tp" },
        { regex: /\bSL\b/g, cls: "log-sl" },
      ];

      highlights.forEach(({ regex, cls }) => {
        safe = safe.replace(regex, (m) => `<span class="${cls}">${m}</span>`);
      });

      return safe;
    }

    function getEntryStrategyById(id) {
      const numericId = Number(id);
      return entryStrategies.find((s) => s.id === numericId);
    }

    function describeStrategy(id) {
      const meta = getEntryStrategyById(id);
      return meta ? `${meta.id} – ${meta.name}` : `ID ${id}`;
    }

    function renderEntryStrategyOptions() {
      if (!entryStrategySelectEl) return;
      entryStrategySelectEl.innerHTML = '<option value="" disabled selected>Select entry strategy...</option>';
      entryStrategies.forEach((s) => {
        const opt = document.createElement("option");
        opt.value = s.id;
        opt.textContent = `${s.id} – ${s.name}`;
        entryStrategySelectEl.appendChild(opt);
      });
    }

    function renderEntryStrategyTable() {
      if (!strategyTableBodyEl) return;
      const rows = entryStrategies.map((s) => {
        const params = s.parameters
          .map((p) => `<div><strong>${p.label}:</strong> ${p.value}</div>`)
          .join("");
        return `
          <tr>
            <td>${s.id}</td>
            <td>${escapeHtml(s.name)}</td>
            <td><div><strong>Purpose:</strong> ${escapeHtml(s.purpose)}</div><div><strong>Behavior:</strong> ${escapeHtml(s.behavior)}</div></td>
            <td>${params}</td>
          </tr>
        `;
      });
      strategyTableBodyEl.innerHTML = rows.join("");
    }

    function updateStrategyUiFromStatus(activeId) {
      const meta = getEntryStrategyById(activeId);
      const label = meta ? `${meta.id} – ${meta.name}` : activeId ?? "–";
      statusEls.strategy.textContent = label || "–";
      if (entryStrategySelectEl) {
        entryStrategySelectEl.value = meta ? String(meta.id) : "";
      }
      if (meta) {
        strategyStatusEl.textContent = `Entry Strategy: ${meta.id} – ${meta.name}`;
      } else if (activeId != null) {
        strategyStatusEl.textContent = `Entry Strategy: ${activeId}`;
      } else {
        strategyStatusEl.textContent = "Select an entry strategy to send it live.";
      }
    }

    // --- STATUS POLLING ---
    async function fetchStatus() {
      try {
        const res = await fetch("/api/status");
        const data = await res.json();
        if (!data.ok) throw new Error("status not ok");

        const cfg = data;
        setBotRunUi(data.botRunning !== false);
        updateStrategyUiFromStatus(cfg.activeStrategyId);

        const intervalMs = cfg.config?.loopIntervalMs || cfg.loopIntervalMs;
        statusEls.interval.textContent = intervalMs ? intervalMs / 1000 + " s" : "–";

        if (data.performance) {
          if (data.performance.lastEquity != null) {
            const equity = Number(data.performance.lastEquity);
            statusEls.equity.textContent = equity.toFixed(2) + " USDT";
          } else {
            statusEls.equity.textContent = "–";
          }
          statusEls.pnl.textContent = formatPnl(data.performance.lastPnlPct);
        }

        if (data.exitConfig) {
          const ex = data.exitConfig;

          exitElems.slValue.textContent = pctText(ex.slPct);
          exitElems.tpValue.textContent = pctText(ex.tpPct);
          exitElems.trailStartValue.textContent = pctText(ex.trailStartPct);
          exitElems.trailDistanceValue.textContent = pctText(ex.trailDistancePct);
          const candleEnabled = !!ex.candleExitEnabled;
          exitElems.candleRedValue.textContent = candleEnabled
            ? pctText(ex.candleRedTriggerPct, 0)
            : "Disabled";
          exitElems.candleEnabledInput.checked = candleEnabled;
          exitElems.candleRedInput.disabled = !candleEnabled;

          // Prefill inputs only if empty, to avoid overwriting user typing
          if (!exitElems.slInput.value && ex.slPct != null)
            exitElems.slInput.value = (ex.slPct * 100).toFixed(2);
          if (!exitElems.tpInput.value && ex.tpPct != null)
            exitElems.tpInput.value = (ex.tpPct * 100).toFixed(2);
          if (!exitElems.trailStartInput.value && ex.trailStartPct != null)
            exitElems.trailStartInput.value = (ex.trailStartPct * 100).toFixed(2);
          if (!exitElems.trailDistanceInput.value && ex.trailDistancePct != null)
            exitElems.trailDistanceInput.value = (ex.trailDistancePct * 100).toFixed(2);
          if (!exitElems.candleRedInput.value && ex.candleRedTriggerPct != null)
            exitElems.candleRedInput.value = (ex.candleRedTriggerPct * 100).toFixed(0);
        }

        const isKill = data.killSwitch === true;
        statusEls.kill.textContent = isKill ? "ON" : "OFF";
        if (isKill) {
          statusEls.killBadge.textContent = "Active";
          statusEls.killBadge.classList.remove("badge-green");
          statusEls.killBadge.classList.add("badge-red");
        } else {
          statusEls.killBadge.textContent = "Inactive";
          statusEls.killBadge.classList.remove("badge-red");
          statusEls.killBadge.classList.add("badge-green");
        }

        statusEls.updated.textContent =
          "Last update: " +
          formatTs(data.stateSummary?.lastUpdateTs || data.performance?.lastUpdateTs || Date.now());
      } catch (err) {
        statusEls.updated.textContent = "Status error: " + err.message;
      }
    }

    // --- EXIT SETTINGS ---
    async function updateExitConfig() {
      try {
        exitStatusEl.textContent = "Sending EXIT config...";

        const sl = parseFloat(exitElems.slInput.value);
        const tp = parseFloat(exitElems.tpInput.value);
        const ts = parseFloat(exitElems.trailStartInput.value);
        const td = parseFloat(exitElems.trailDistanceInput.value);
        const cr = parseFloat(exitElems.candleRedInput.value);
        const candleEnabled = exitElems.candleEnabledInput.checked;

        const payload = {};

        if (!Number.isNaN(sl)) payload.slPct = sl / 100.0;
        if (!Number.isNaN(tp)) payload.tpPct = tp / 100.0;
        if (!Number.isNaN(ts)) payload.trailStartPct = ts / 100.0;
        if (!Number.isNaN(td)) payload.trailDistancePct = td / 100.0;
        if (!Number.isNaN(cr)) payload.candleRedTriggerPct = cr / 100.0;
        payload.candleExitEnabled = candleEnabled;

        const res = await fetch("/api/config", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        const data = await res.json();
        if (!data.ok) throw new Error(data.error || "failed");

        exitStatusEl.textContent = "EXIT updated successfully.";
        await fetchStatus();
      } catch (err) {
        exitStatusEl.textContent = "Error: " + err.message;
      }
    }

    // --- LOGS POLLING ---
    async function fetchLogs() {
      try {
        const res = await fetch("/api/logs");
        const data = await res.json();
        if (!data.ok || !Array.isArray(data.lines)) {
          throw new Error("invalid log payload");
        }

        const html = (data.lines || []).map((line) => highlightLog(line)).join("<br>");
        logContainerEl.innerHTML = html || "(no logs yet)";
        // auto scroll to bottom
        logContainerEl.scrollTop = logContainerEl.scrollHeight;
        logStatusPillEl.textContent = "Last log update: " + new Date().toLocaleTimeString();
      } catch (err) {
        logStatusPillEl.textContent = "Log error: " + err.message;
      }
    }

    // --- CONTROLS ---
    async function startBot() {
      try {
        botControlStatusEl.textContent = "Starting bot...";
        const res = await fetch("/api/bot/start", { method: "POST" });
        const data = await res.json();
        if (!res.ok || !data.ok) throw new Error(data.error || "failed");
        botControlStatusEl.textContent = "Bot resumed. Continuing from saved state.";
        setBotRunUi(true);
      } catch (err) {
        botControlStatusEl.textContent = "Error: " + err.message;
      }
    }

    async function stopBot() {
      try {
        botControlStatusEl.textContent = "Stopping bot after current loop...";
        const res = await fetch("/api/bot/stop", { method: "POST" });
        const data = await res.json();
        if (!res.ok || !data.ok) throw new Error(data.error || "failed");
        botControlStatusEl.textContent = "Bot will pause after persisting state.";
        setBotRunUi(false);
      } catch (err) {
        botControlStatusEl.textContent = "Error: " + err.message;
      }
    }

    async function setStrategy(id) {
      try {
        const label = describeStrategy(id);
        strategyStatusEl.textContent = `Sending strategy change for ${label}...`;
        const res = await fetch("/api/config", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ activeStrategyId: Number(id) }),
        });
        const data = await res.json();
        if (!data.ok) throw new Error(data.error || "failed");
        strategyStatusEl.textContent = "Entry Strategy set to " + label;
        await fetchStatus();
      } catch (err) {
        strategyStatusEl.textContent = "Error: " + err.message;
      }
    }

    async function setIntervalMs(ms) {
      try {
        intervalStatusEl.textContent = "Sending interval change...";
        const res = await fetch("/api/config", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ loopIntervalMs: ms }),
        });
        const data = await res.json();
        if (!data.ok) throw new Error(data.error || "failed");
        intervalStatusEl.textContent = "Interval set to " + ms / 1000 + " sec";
        await fetchStatus();
      } catch (err) {
        intervalStatusEl.textContent = "Error: " + err.message;
      }
    }

    async function killSwitch() {
      try {
        intervalStatusEl.textContent = "Sending SELL ALL...";
        const res = await fetch("/api/kill", { method: "POST" });
        const data = await res.json();
        if (!data.ok) throw new Error(data.error || "failed");
        intervalStatusEl.textContent = "SELL ALL requested";
      } catch (err) {
        intervalStatusEl.textContent = "Error: " + err.message;
      }
    }

    async function resetFundsGui() {
      try {
        resetFundsStatusEl.textContent = "Sending RESET FUNDS...";
        const res = await fetch("/api/resetFunds", { method: "POST" });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || "HTTP " + res.status);
        resetFundsStatusEl.textContent = "→ " + (data.message || "RESET FUNDS REQUESTED");
      } catch (err) {
        resetFundsStatusEl.textContent = "Error: " + err.message;
      }
    }

    startBotBtn.addEventListener("click", startBot);
    stopBotBtn.addEventListener("click", stopBot);
    document.getElementById("resetFundsBtn").addEventListener("click", resetFundsGui);
    applyExitPresetBtn.addEventListener("click", () => {
      const presetId = exitPresetSelectEl.value;
      if (!presetId) {
        exitStatusEl.textContent = "Please choose a preset first.";
        return;
      }
      applyExitPreset(presetId);
    });
    exitPresetSelectEl.addEventListener("change", () => {
      if (exitPresetSelectEl.value) {
        applyExitPreset(exitPresetSelectEl.value);
      }
    });

    exitElems.candleEnabledInput.addEventListener("change", () => {
      exitElems.candleRedInput.disabled = !exitElems.candleEnabledInput.checked;
    });

    entryStrategySelectEl.addEventListener("change", () => {
      const id = Number(entryStrategySelectEl.value);
      if (!id) return;
      setStrategy(id);
    });

    renderEntryStrategyOptions();
    renderEntryStrategyTable();

    // --- INITIAL LOAD ---
    fetchStatus();
    fetchLogs();

    // --- POLLERS ---
    setInterval(fetchStatus, 8000); // status every 8s
    setInterval(fetchLogs, 5000); // logs every 5s
  </script>
</body>
</html>
